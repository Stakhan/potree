function numbersonly(e,t,n){var r;var i;if(window.event)r=window.event.keyCode;else if(t)r=t.which;else return true;i=String.fromCharCode(r);if(r==null||r==0||r==8||r==9||r==13||r==27)return true;else if("0123456789".indexOf(i)>-1)return true;else if(n&&i=="."){e.form.elements[n].focus();return false}else return false}function load_binary_resource(e){var t=new XMLHttpRequest;t.open("GET",e,false);t.overrideMimeType("text/plain; charset=x-user-defined");t.send(null);if(t.status!=200&&t.status!=0){console.log("req.status: '"+t.status+"'");console.log("req.readyState: '"+t.readyState+"'");return""}return t.responseText}function loadBinaryResourceIntoArrayBuffer(e){var t=new XMLHttpRequest;t.open("GET",e,false);t.responseType="arraybuffer";t.overrideMimeType("text/plain; charset=x-user-defined");t.send(null);if(t.readyState==4){if(t.status==200||t.status==0){var n=t.response;return n}else{alert("Failed to load file! HTTP status: "+t.status)}}return null}function getUrlVars(){var e={};var t=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,n,r){e[n]=r});return e}function addCommas(e){e+="";x=e.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var t=/(\d+)(\d{3})/;while(t.test(x1)){x1=x1.replace(t,"$1"+","+"$2")}return x1+x2}function relMouseCoords(e,t){var n=0;var r=0;var i=0;var s=0;var o=t;do{n+=o.offsetLeft-o.scrollLeft;r+=o.offsetTop-o.scrollTop}while(o=o.offsetParent);i=e.pageX-n;s=e.pageY-r;return{x:i,y:s}}function KeyListener(){}function KeyCodes(){}function MouseListener(){}function Mouse(){}function TextureManager(){}function Texture(){this.glid=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.glid);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,false);gl.bindTexture(gl.TEXTURE_2D,null)}function MaterialManager(){}function Shader(e,t,n){if(arguments[0]===inheriting)return;if(e==null){e="Shader_"+Shader.count}this.vertexShaderName=null;this.fragmentShaderName=null;this.program=null;this.name=e;this.setVertexShaderName(t);this.setFragmentShaderName(n);this.relink();this.initUniforms();this.initAttributes();ShaderManager.addShader(this);Shader.count++}function ShaderAttribute(){}function Plane(e,t){this.distance=e;this.normal=t}function Frustum(){this.nearPlane=null;this.farPlane=null;this.leftPlane=null;this.rightPlane=null;this.topPlane=null;this.bottomPlane=null;this.pNearUL=null;this.pNearUR=null;this.pNearLL=null;this.pNearLR=null;this.pFarUL=null;this.pFarUR=null;this.pFarLL=null;this.pFarLR=null;this.planes=new Array}function Renderer(e,t){this.fboColor=t;this.fboDepthAsRGBA=null;this.scene=e;this.bgColor=[0,0,0,1];this._viewport=[0,0,0,0];this.fboWorldPosAt=null;this.worldPosCallbackQueue=new Array}function AABB(){this.points=24;this.color=[1,0,0,1];this.version=0;this.min=V3.$(0,0,0);this.max=V3.$(0,0,0);this.center=M4x4.$();this.radius=null;this.vbo=null;this.transform=M4x4.I;this.p0=null;this.p1=null;this.p2=null;this.p3=null;this.p4=null;this.p5=null;this.p6=null;this.p7=null;this.objectSpaceMin=V3.$(0,0,0);this.objectSpaceMax=V3.$(0,0,0);this.tp0=V3.$(0,0,0);this.tp1=V3.$(0,0,0);this.tp2=V3.$(0,0,0);this.tp3=V3.$(0,0,0);this.tp4=V3.$(0,0,0);this.tp5=V3.$(0,0,0);this.tp6=V3.$(0,0,0);this.tp7=V3.$(0,0,0)}function SceneNode(e,t){if(arguments[0]===inheriting)return;this._scene=null;this.name=e;this.parent=t;this.children=new Object;this.aabb=null;this._visible=true;this._globalPosition=V3.$(0,0,0);this.age=0;this._transform=M4x4.I;if(t!=null){t.addChild(this);this.scene=t.scene}this.tmpMatrix1=M4x4.$();this.tmpMatrix2=M4x4.$();this.tmpMatrix3=M4x4.$()}function Camera(e){SceneNode.call(this,e);this._nearClipPlane=.1;this._farClipPlane=250;this._fieldOfView=60;this._aspectRatio=1;this._viewMatrix=null;this._projectionMatrix=null;this.updateViewMatrix();this.updateProjectionMatrix()}function Scene(e){this.name=e;this.rootNode=new SceneNode("root");this.rootNode.scene=this;this.cameras=new Object;this.cameras["default"]=new Camera("default");this.cameras["default"].scene=this;this.lights=new Object;this.activeCamera=this.cameras["default"]}function MeshNode(e,t,n){SceneNode.call(this,e,n);this.mesh=t}function LightType(){}function Light(e,t){SceneNode.call(this,e,t);this.type=LightType.OMNI;this.colour=[1,1,1];this.castShadows=false}function Sphere(e,t){SceneNode.call(this,e,t);var n=12;this._mesh=null;this.tesselation=n}function Mesh(e){this.name=e;this.subMeshes=new Array;this.setType(MeshType.TRIANGLES);this._material=null;this.primitiveSize=1}function SubMesh(e){this.mesh=e;this.vbos=new Object;this.ibo=null;this.vertexCount=0;this.indices=null;this._material=null}function Viewport(e,t){this.canvas=e;this.camera=t;this.velocity=[0,0,0];this.targetVelocity=[0,0,0];this.targetVelocityMultiplicator=20;this.x=0;this.y=0;if(e!=null){this.width=e.width;this.height=e.height}if(this.camera!=null){this.camera.aspectRatio=this.width/this.height}}function CamHandler(){}function FreeFlightCamHandler(e){this.camera=e;this.velocity=[0,0,0];this.targetVelocity=[0,0,0];this.targetVelocityMultiplicator=20;this.x=0;this.y=0;this.speedMultiplier=.2;this.qualityToggle=0}function OrbitCamHandler(e){this.camera=e;this.x=0;this.y=0;this.speedMultiplier=.2;this.distance=8;this.aX=0;this.aY=2}function Framebuffer(e,t){if(arguments[0]===inheriting)return;if(arguments[0]=="system"){this.framebuffer=null;this.initOtherStuff()}else{this.initBufferStuff(e,t);this.initOtherStuff()}}function FramebufferFloat32(e,t){Framebuffer.call(this,e,t)}function ShaderManager(){}function MeshUtils(){}function PointcloudOctreeSceneNode(e,t){SceneNode.call(this,name,t);this.mno=e}function PointCloudSceneNode(e,t,n){SceneNode.call(this,e,t);this.pointCloud=n;if(MaterialManager.getMaterial("pointCloudMat")==null){this.material=new PointCloudMaterial("pointCloudMat")}else{this.material=MaterialManager.getMaterial("pointCloudMat")}var r=n.pointAttributes;if(r.hasColors()&&r.hasNormals()){this.material.illuminationMode=IlluminationMode.FLAT}else if(r.hasNormals()){this.material.illuminationMode=IlluminationMode.PHONG}else{this.material.illuminationMode=IlluminationMode.POSITION}this.material.renderMode=PointCloudRenderMode.WEIGHTED_CIRCLE}function PointCloud(e,t){this.name=e;this.vbo=null;this.aabb=null;this.pointCloudRoot=false;this.pointAttributes=t;this.size=0}function PointcloudOctreeNode(e,t){this.name=e;this.id=t.octreeDir+"/"+e;this.pointCloud=null;this.level=e.length-1;this.children=new Object;this.age=0;this.poc=t;this.isLoading=false;this.points=0;this.opacity=0;this.fade=0;this.aabb=null;if(PointcloudOctreeNode.lruNodes==null){PointcloudOctreeNode.lruNodes=new LRU}}function POCRenderQueue(){this.byteSize=0;this.nodes=new Object;this.nodeList=new Array;this.length=0;this.points=0}function PointcloudOctree(){this.rootNode=null;this.pointAttributes=null;this.maxRenderingNodes=500;this.nodesRenderedThisFrame=0;this.octreeDir=null;this.loadQueue=new Array;if(MaterialManager.getMaterial("pointCloud")!=null){this.material=MaterialManager.getMaterial("pointCloud")}this.renderQueue=new POCRenderQueue;this.tmpStack=new Array;this.aabbVersion=1;this.minDepth=1;this.nodesBeeingLoaded=new Array;this.loadingNodesLimit=10}function Material(e){if(arguments[0]===inheriting)return;if(e==null){e="Material_"+Material.count}this.name=e;MaterialManager.addMaterial(this);Material.count++}function WeightedPointSizeMaterial(e){Material.call(this,e);this.shader=new Shader(e+"_color","pointSize.vs","colouredPoint.fs");this.posShader=new Shader(e+"_position","weightedPoints/weightedPointsPosition.vs","weightedPoints/weightedPointsPosition.fs");this.rgbaDepthShader=new Shader(e+"_depthRGBA","weightedPoints/weightedPointsDepthAsRGBA.vs","weightedPoints/weightedPointsDepthAsRGBA.fs");this.pointSize=.3}function FixedPointSizeMaterial(e){Material.call(this,e);this.shader=new Shader(e,"fixedPointSize.vs","colouredPoint.fs");this.pointSize=1}function PointCloudMaterial(e){Material.call(this,e);this.renderMode=PointCloudRenderMode.WEIGHTED_CIRCLE;this.filteredMaterial=new FilteredSplatsMaterial(e+"_filtered");this.weightedMaterial=new WeightedPointSizeMaterial(e+"_weighted");this.fixedMaterial=new FixedPointSizeMaterial(e+"_fixed");this.gaussFillMaterial=new GaussFillMaterial(e+"_fill");this.activeMaterial=this.weightedMaterial;this.pointSize=.2;this.blendDepth=.1;this.illuminationMode=IlluminationMode.FLAT}function FlatMaterial(e,t){Material.call(this,e);this.flatShader=new Shader(e,"flatShader.vs","flatShader.fs");if(t!=null){this.color=t}else{this.color=[1,0,0,1]}}function PhongMaterial(e,t){Material.call(this,e);this.flatShader=new Shader(e,"phong.vs","phong.fs");if(t!=null){this.color=t}else{this.color=[1,0,0,1]}}function FilteredSplatsMaterial(e){Material.call(this,e);this.depthShader=new Shader(e+"_depth","filteredSplats/filteredSplatsDepthPass.vs","filteredSplats/filteredSplatsDepthPass.fs");this.normalShader=new Shader(e+"_filtered_normal","filteredSplats/filteredSplatsAttributePass.vs","filteredSplats/filteredSplatsNormalAttributePass.fs");this.colorShader=new Shader(e+"_filtered_color","filteredSplats/filteredSplatsAttributePass.vs","filteredSplats/filteredSplatsColorAttributePass.fs");this.normalizationShader=new Shader(e+"normalization","drawTexture.vs","filteredSplats/filteredSplatsShadingPass.fs");this.depthFBO=new FramebufferFloat32(Potree.canvas.width,Potree.canvas.height);this.normalFBO=new FramebufferFloat32(Potree.canvas.width,Potree.canvas.height);this.colorFBO=new FramebufferFloat32(Potree.canvas.width,Potree.canvas.height);this.illuminationMode=IlluminationMode.PHONG;this.pointSize=1;this.blendDepth=.1}function GaussFillMaterial(e){Material.call(this,e);this.depthShader=new Shader(e+"_depth","gaussFill/gaussFillDepthPass.vs","gaussFill/gaussFillDepthPass.fs");this.colorShader=new Shader(e+"_filtered_color","gaussFill/gaussFillPointsPass.vs","gaussFill/gaussFillPointsPass.fs");this.spreadXShader=new Shader(e+"_spreadX","drawTexture.vs","gaussFill/gaussFillSpreadXPass.fs");this.spreadYShader=new Shader(e+"_spreadY","drawTexture.vs","gaussFill/gaussFillSpreadYPass.fs");this.normalizationShader=new Shader(e+"normalization","drawTexture.vs","gaussFill/gaussFillNormalizationPass.fs");this.depthFBO=new Framebuffer(Potree.canvas.width,Potree.canvas.height);this.colorFBO=new Framebuffer(Potree.canvas.width,Potree.canvas.height);this.spreadXFBO=new FramebufferFloat32(Potree.canvas.width,Potree.canvas.height);this.spreadYFBO=new FramebufferFloat32(Potree.canvas.width,Potree.canvas.height);this.illuminationMode=IlluminationMode.PHONG;this.pointSize=1;this.blendDepth=.1;this.gaussKernel=[.0216149,.0439554,.0778778,.118718,.153857,.167953,.153857,.118718,.0778778,.0439554,.0216149];for(var t=0;t<this.gaussKernel.length;t++){this.gaussKernel[t]=Math.pow(this.gaussKernel[t]+.1,20)}}function POCLoader(){}function PointAttribute(e,t,n){this.name=e;this.type=t;this.numElements=n;this.byteSize=this.numElements*this.type.size}function PointAttributes(e){this.attributes=new Array;this.byteSize=0;this.size=0;if(e!=null){for(var t in e){var n=e[t];this.attributes.push(n);this.byteSize+=n.byteSize;this.size++}}}function ProceduralPointcloudGenerator(){}function PlyFileType(){}function PlyProperty(e,t){this.name=e;this.type=t}function PlyPropertyDataType(e,t){this.name=e;this.size=t}function PlyElement(e){this.name=e;this.properties=new Array;this.size=0}function PlyHeader(){this.type=null;this.byteSize=0;this.elements=new Array}function PlyFile(e){this.buffer=e;this.header=new PlyHeader}function PlyLoaderListener(){}function PlyLoader(){}function LRUItem(e){this.previous=null;this.next=null;this.node=e}function LRU(){this.first=null;this.last=null;this.items=new Object;this.elements=0;this.byteSize=0}function Potree(){this.camHandler=null}const MJS_VERSION=0;const MJS_DO_ASSERT=true;try{WebGLFloatArray}catch(x){WebGLFloatArray=Float32Array}const MJS_FLOAT_ARRAY_TYPE=WebGLFloatArray;if(MJS_DO_ASSERT){function MathUtils_assert(e,t){if(!e)throw"Assertion failed: "+t}}else{function MathUtils_assert(){}}var V3={};V3._temp1=new MJS_FLOAT_ARRAY_TYPE(3);V3._temp2=new MJS_FLOAT_ARRAY_TYPE(3);V3._temp3=new MJS_FLOAT_ARRAY_TYPE(3);if(MJS_FLOAT_ARRAY_TYPE==Array){V3.x=[1,0,0];V3.y=[0,1,0];V3.z=[0,0,1];V3.$=function(t,n,r){return[t,n,r]};V3.clone=function(t){return[t[0],t[1],t[2]]}}else{V3.x=new MJS_FLOAT_ARRAY_TYPE([1,0,0]);V3.y=new MJS_FLOAT_ARRAY_TYPE([0,1,0]);V3.z=new MJS_FLOAT_ARRAY_TYPE([0,0,1]);V3.$=function(t,n,r){return new MJS_FLOAT_ARRAY_TYPE([t,n,r])};V3.clone=function(t){return new MJS_FLOAT_ARRAY_TYPE(t)}}V3.u=V3.x;V3.v=V3.y;V3.add=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);r[0]=t[0]+n[0];r[1]=t[1]+n[1];r[2]=t[2]+n[2];return r};V3.sub=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);r[0]=t[0]-n[0];r[1]=t[1]-n[1];r[2]=t[2]-n[2];return r};V3.neg=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(3);n[0]=-t[0];n[1]=-t[1];n[2]=-t[2];return n};V3.direction=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);return V3.normalize(V3.sub(t,n,r),r)};V3.length=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])};V3.lengthSquared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]};V3.normalize=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(3);var r=1/V3.length(t);n[0]=t[0]*r;n[1]=t[1]*r;n[2]=t[2]*r;return n};V3.scale=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);r[0]=t[0]*n;r[1]=t[1]*n;r[2]=t[2]*n;return r};V3.dot=function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]};V3.cross=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);r[0]=t[1]*n[2]-t[2]*n[1];r[1]=t[2]*n[0]-t[0]*n[2];r[2]=t[0]*n[1]-t[1]*n[0];return r};var M4x4={};M4x4._temp1=new MJS_FLOAT_ARRAY_TYPE(16);M4x4._temp2=new MJS_FLOAT_ARRAY_TYPE(16);if(MJS_FLOAT_ARRAY_TYPE==Array){M4x4.I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];M4x4.$=function(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return[t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m]};M4x4.clone=function(t){return new[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]}}else{M4x4.I=new MJS_FLOAT_ARRAY_TYPE([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);M4x4.$=function(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return new MJS_FLOAT_ARRAY_TYPE([t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m])};M4x4.clone=function(t){return new MJS_FLOAT_ARRAY_TYPE(t)}}M4x4.identity=M4x4.I;M4x4.topLeft3x3=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(9);n[0]=t[0];n[1]=t[1];n[2]=t[2];n[3]=t[4];n[4]=t[5];n[5]=t[6];n[6]=t[8];n[7]=t[9];n[8]=t[10];return n};M4x4.inverseOrthonormal=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(16);M4x4.transpose(t,n);var r=[t[12],t[13],t[14]];n[3]=n[7]=n[11]=0;n[12]=-Vec3.dot([n[0],n[4],n[8]],r);n[13]=-Vec3.dot([n[1],n[5],n[9]],r);n[14]=-Vec3.dot([n[2],n[6],n[10]],r);return n};M4x4.inverseTo3x3=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(9);var r=t[10]*t[5]-t[6]*t[9],i=-t[10]*t[1]+t[2]*t[9],s=t[6]*t[1]-t[2]*t[5],o=-t[10]*t[4]+t[6]*t[8],u=t[10]*t[0]-t[2]*t[8],a=-t[6]*t[0]+t[2]*t[4],f=t[9]*t[4]-t[5]*t[8],l=-t[9]*t[0]+t[1]*t[8],c=t[5]*t[0]-t[1]*t[4];var h=t[0]*r+t[1]*o+t[2]*f;if(h==0)throw"matrix not invertible";var p=1/h;n[0]=p*r;n[1]=p*i;n[2]=p*s;n[3]=p*o;n[4]=p*u;n[5]=p*a;n[6]=p*f;n[7]=p*l;n[8]=p*c;return n};M4x4.makeFrustum=function(t,n,r,i,s,o,u){if(u==undefined)u=new MJS_FLOAT_ARRAY_TYPE(16);var a=2*s/(n-t);var f=2*s/(i-r);var l=(n+t)/(n-t);var c=(i+r)/(i-r);var h=-(o+s)/(o-s);var p=-2*o*s/(o-s);u[0]=2*s/(n-t);u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=2*s/(i-r);u[6]=0;u[7]=0;u[8]=(n+t)/(n-t);u[9]=(i+r)/(i-r);u[10]=-(o+s)/(o-s);u[11]=-1;u[12]=0;u[13]=0;u[14]=-2*o*s/(o-s);u[15]=0;return u};M4x4.makePerspective=function(t,n,r,i,s){var o=r*Math.tan(t*Math.PI/360);var u=-o;var a=u*n;var f=o*n;return M4x4.makeFrustum(a,f,u,o,r,i,s)};M4x4.makeOrtho=function(t,n,r,i,s,o,u){if(u==undefined)u=new MJS_FLOAT_ARRAY_TYPE(16);var a=-(n+t)/(n-t);var f=-(i+r)/(i-r);var l=-(o+s)/(o-s);var c=2/(n-t);var h=2/(i-r);var p=-2/(o-s);u[0]=2/(n-t);u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=2/(i-r);u[6]=0;u[7]=0;u[8]=0;u[9]=0;u[10]=-2/(o-s);u[11]=0;u[12]=-(n+t)/(n-t);u[13]=-(i+r)/(i-r);u[14]=-(o+s)/(o-s);u[15]=0;return u};M4x4.makeOrtho2D=function(t,n,r,i,s){return M4x4.makeOrtho(t,n,r,i,-1,1,s)};M4x4.mul=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(16);r[0]=n[0]*t[0]+n[0+1]*t[4]+n[0+2]*t[8]+n[0+3]*t[12];r[0+1]=n[0]*t[1]+n[0+1]*t[5]+n[0+2]*t[9]+n[0+3]*t[13];r[0+2]=n[0]*t[2]+n[0+1]*t[6]+n[0+2]*t[10]+n[0+3]*t[14];r[0+3]=n[0]*t[3]+n[0+1]*t[7]+n[0+2]*t[11]+n[0+3]*t[15];r[4]=n[4]*t[0]+n[4+1]*t[4]+n[4+2]*t[8]+n[4+3]*t[12];r[4+1]=n[4]*t[1]+n[4+1]*t[5]+n[4+2]*t[9]+n[4+3]*t[13];r[4+2]=n[4]*t[2]+n[4+1]*t[6]+n[4+2]*t[10]+n[4+3]*t[14];r[4+3]=n[4]*t[3]+n[4+1]*t[7]+n[4+2]*t[11]+n[4+3]*t[15];r[8]=n[8]*t[0]+n[8+1]*t[4]+n[8+2]*t[8]+n[8+3]*t[12];r[8+1]=n[8]*t[1]+n[8+1]*t[5]+n[8+2]*t[9]+n[8+3]*t[13];r[8+2]=n[8]*t[2]+n[8+1]*t[6]+n[8+2]*t[10]+n[8+3]*t[14];r[8+3]=n[8]*t[3]+n[8+1]*t[7]+n[8+2]*t[11]+n[8+3]*t[15];r[12]=n[12]*t[0]+n[12+1]*t[4]+n[12+2]*t[8]+n[12+3]*t[12];r[12+1]=n[12]*t[1]+n[12+1]*t[5]+n[12+2]*t[9]+n[12+3]*t[13];r[12+2]=n[12]*t[2]+n[12+1]*t[6]+n[12+2]*t[10]+n[12+3]*t[14];r[12+3]=n[12]*t[3]+n[12+1]*t[7]+n[12+2]*t[11]+n[12+3]*t[15];return r};M4x4.makeRotate=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(16);n=V3.normalize(n);var i=n[0],s=n[1],o=n[2];var u=Math.cos(t);var a=1-u;var f=Math.sin(t);r[0]=i*i*a+u;r[1]=s*i*a+o*f;r[2]=o*i*a-s*f;r[3]=0;r[4]=i*s*a-o*f;r[5]=s*s*a+u;r[6]=s*o*a+i*f;r[7]=0;r[8]=i*o*a+s*f;r[9]=s*o*a-i*f;r[10]=o*o*a+u;r[11]=0;r[12]=0;r[13]=0;r[14]=0;r[15]=1;return r};M4x4.rotate=function(t,n,r,i){M4x4.makeRotate(t,n,M4x4._temp1);return M4x4.mul(r,M4x4._temp1,i)};M4x4.makeScale3=function(t,n,r,i){if(i==undefined)i=new MJS_FLOAT_ARRAY_TYPE(16);i[0]=t;i[1]=0;i[2]=0;i[3]=0;i[4]=0;i[5]=n;i[6]=0;i[7]=0;i[8]=0;i[9]=0;i[10]=r;i[11]=0;i[12]=0;i[13]=0;i[14]=0;i[15]=1;return i};M4x4.makeScale1=function(t,n){return M4x4.makeScale3(t,t,t,n)};M4x4.makeScale=function(t,n){return M4x4.makeScale3(t[0],t[1],t[2],n)};M4x4.scale3=function(t,n,r,i,s){M4x4.makeScale3(t,n,r,M4x4._temp1);return M4x4.mul(i,M4x4._temp1,s)};M4x4.scale1=function(t,n,r){M4x4.makeScale3(t,t,t,M4x4._temp1);return M4x4.mul(n,M4x4._temp1,r)};M4x4.scale=function(t,n,r){M4x4.makeScale3(t[0],t[1],t[2],M4x4._temp1);return M4x4.mul(n,M4x4._temp1,r)};M4x4.makeTranslate3=function(t,n,r,i){if(i==undefined)i=new MJS_FLOAT_ARRAY_TYPE(16);i[0]=1;i[1]=0;i[2]=0;i[3]=0;i[4]=0;i[5]=1;i[6]=0;i[7]=0;i[8]=0;i[9]=0;i[10]=1;i[11]=0;i[12]=t;i[13]=n;i[14]=r;i[15]=1;return i};M4x4.makeTranslate1=function(t,n){return M4x4.makeTranslate3(t,t,t,n)};M4x4.makeTranslate=function(t,n){return M4x4.makeTranslate3(t[0],t[1],t[2],n)};M4x4.translate3=function(t,n,r,i,s){M4x4.makeTranslate3(t,n,r,M4x4._temp1);return M4x4.mul(i,M4x4._temp1,s)};M4x4.translate1=function(t,n,r){M4x4.makeTranslate3(t,t,t,M4x4._temp1);return M4x4.mul(n,M4x4._temp1,r)};M4x4.translate=function(t,n,r){M4x4.makeTranslate3(t[0],t[1],t[2],M4x4._temp1);return M4x4.mul(n,M4x4._temp1,r)};M4x4.makeLookAt=function(t,n,r,i){var s=V3.direction(t,n,V3._temp1);var o=V3.normalize(V3.cross(r,s,V3._temp2),V3._temp2);var u=V3.normalize(V3.cross(s,o,V3._temp3),V3._temp3);var a=M4x4._temp1;var f=M4x4._temp2;a[0]=o[0];a[1]=u[0];a[2]=s[0];a[3]=0;a[4]=o[1];a[5]=u[1];a[6]=s[1];a[7]=0;a[8]=o[2];a[9]=u[2];a[10]=s[2];a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;f[0]=1;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=1;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=1;f[3]=0;f[0]=-t[0];f[1]=-t[1];f[2]=-t[2];f[3]=0;if(i==undefined)i=new MJS_FLOAT_ARRAY_TYPE(16);return M4x4.mul(a,f,i)};M4x4.transpose=function(t,n){if(t==n){var r=0;r=t[1];t[1]=t[4];t[4]=r;r=t[2];t[2]=t[8];t[8]=r;r=t[3];t[3]=t[12];t[12]=r;r=t[6];t[6]=t[9];t[9]=r;r=t[7];t[7]=t[13];t[13]=r;r=t[11];t[11]=t[14];t[14]=r;return t}if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(16);n[0]=t[0];n[1]=t[4];n[2]=t[8];n[3]=t[12];n[4]=t[1];n[5]=t[5];n[6]=t[9];n[7]=t[13];n[8]=t[2];n[9]=t[6];n[10]=t[10];n[11]=t[14];n[12]=t[3];n[13]=t[7];n[14]=t[11];n[15]=t[15];return n};WebGLDebugUtils=function(){function r(e){if(n==null){n={};for(var t in e){if(typeof e[t]=="number"){n[e[t]]=t}}}}function i(){if(n==null){throw"WebGLDebugUtils.init(ctx) not called"}}function s(e){i();return n[e]!==undefined}function o(e){i();var t=n[e];return t!==undefined?t:"*UNKNOWN WebGL ENUM (0x"+e.toString(16)+")"}function u(e,n,r){var i=t[e];if(i!==undefined){if(i[n]){return o(r)}}if(r==null){return"null"}else{return r.toString()}}function a(t,n){function s(e,t){return function(){var r=e[t].apply(e,arguments);var s=e.getError();if(s!=0){i[s]=true;n(s,t,arguments)}return r}}r(t);n=n||function(t,n,r){var i="";for(var s=0;s<r.length;++s){i+=(s==0?"":", ")+u(n,s,r[s])}e("WebGL error "+o(t)+" in "+n+"("+i+")")};var i={};var a={};for(var f in t){if(typeof t[f]=="function"){a[f]=s(t,f)}else{a[f]=t[f]}}a.getError=function(){for(var e in i){if(i[e]){i[e]=false;return e}}return t.NO_ERROR};return a}function f(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS);var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n);for(var r=0;r<t;++r){e.disableVertexAttribArray(r);e.vertexAttribPointer(r,4,e.FLOAT,false,0,0);e.vertexAttrib1f(r,0)}e.deleteBuffer(n);var i=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<i;++r){e.activeTexture(e.TEXTURE0+r);e.bindTexture(e.TEXTURE_CUBE_MAP,null);e.bindTexture(e.TEXTURE_2D,null)}e.activeTexture(e.TEXTURE0);e.useProgram(null);e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.disable(e.BLEND);e.disable(e.CULL_FACE);e.disable(e.DEPTH_TEST);e.disable(e.DITHER);e.disable(e.SCISSOR_TEST);e.blendColor(0,0,0,0);e.blendEquation(e.FUNC_ADD);e.blendFunc(e.ONE,e.ZERO);e.clearColor(0,0,0,0);e.clearDepth(1);e.clearStencil(-1);e.colorMask(true,true,true,true);e.cullFace(e.BACK);e.depthFunc(e.LESS);e.depthMask(true);e.depthRange(0,1);e.frontFace(e.CCW);e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE);e.lineWidth(1);e.pixelStorei(e.PACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,false);e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(e.UNPACK_COLORSPACE_CONVERSION_WEBGL){e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL)}e.polygonOffset(0,0);e.sampleCoverage(1,false);e.scissor(0,0,e.canvas.width,e.canvas.height);e.stencilFunc(e.ALWAYS,0,4294967295);e.stencilMask(4294967295);e.stencilOp(e.KEEP,e.KEEP,e.KEEP);e.viewport(0,0,e.canvas.clientWidth,e.canvas.clientHeight);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);while(e.getError());}function l(e){function c(e){return e instanceof WebGLBuffer||e instanceof WebGLFramebuffer||e instanceof WebGLProgram||e instanceof WebGLRenderbuffer||e instanceof WebGLShader||e instanceof WebGLTexture}function h(e){for(var t=0;t<e.length;++t){var r=e[t];if(c(r)){return r.__webglDebugContextLostId__==n}}return true}function p(){var e=Object.keys(l);for(var t=0;t<e.length;++t){delete glErrorShdow_[e]}}function d(e,t){var n=e[t];return function(){if(!r){if(!h(arguments)){l[e.INVALID_OPERATION]=true;return}var t=n.apply(e,arguments);return t}}}function m(e){return{statusMessage:e}}function g(){for(var t=0;t<s.length;++t){var n=s[t];if(n instanceof WebGLBuffer){e.deleteBuffer(n)}else if(n instanceof WebctxFramebuffer){e.deleteFramebuffer(n)}else if(n instanceof WebctxProgram){e.deleteProgram(n)}else if(n instanceof WebctxRenderbuffer){e.deleteRenderbuffer(n)}else if(n instanceof WebctxShader){e.deleteShader(n)}else if(n instanceof WebctxTexture){e.deleteTexture(n)}}}function x(e){if(typeof e=="function"){return e}else{return function(t){e.handleEvent(t)}}}var t={};var n=1;var r=false;var i=0;var s=[];var o=undefined;var u=undefined;var a=undefined;var l={};for(var v in e){if(typeof e[v]=="function"){t[v]=d(e,v)}else{t[v]=e[v]}}t.loseContext=function(){if(!r){r=true;++n;while(e.getError());p();l[e.CONTEXT_LOST_WEBGL]=true;setTimeout(function(){if(o){o(m("context lost"))}},0)}};t.restoreContext=function(){if(r){if(u){setTimeout(function(){g();f(e);r=false;if(u){var t=u;u=a;a=undefined;t(m("context restored"))}},0)}else{throw"You can not restore the context without a listener"}}};t.getError=function(){if(!r){var t;while(t=e.getError()){l[t]=true}}for(var t in l){if(l[t]){delete l[t];return t}}return e.NO_ERROR};var y=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var b=0;b<y.length;++b){var w=y[b];t[w]=function(t){return function(){if(r){return null}var i=t.apply(e,arguments);i.__webglDebugContextLostId__=n;s.push(i);return i}}(e[w])}var E=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var b=0;b<E.length;++b){var w=E[b];t[w]=function(t){return function(){if(r){return null}return t.apply(e,arguments)}}(t[w])}var S=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var b=0;b<S.length;++b){var w=S[b];t[w]=function(t){return function(){if(r){return false}return t.apply(e,arguments)}}(t[w])}t.checkFramebufferStatus=function(t){return function(){if(r){return e.FRAMEBUFFER_UNSUPPORTED}return t.apply(e,arguments)}}(t.checkFramebufferStatus);t.getAttribLocation=function(t){return function(){if(r){return-1}return t.apply(e,arguments)}}(t.getAttribLocation);t.getVertexAttribOffset=function(t){return function(){if(r){return 0}return t.apply(e,arguments)}}(t.getVertexAttribOffset);t.isContextLost=function(){return r};t.registerOnContextLostListener=function(e){o=x(e)};t.registerOnContextRestoredListener=function(e){if(r){a=x(e)}else{u=x(e)}};return t}var e=function(e){if(window.console&&window.console.log){window.console.log(e)}};var t={enable:{0:true},disable:{0:true},getParameter:{0:true},drawArrays:{0:true},drawElements:{0:true,2:true},createShader:{0:true},getShaderParameter:{1:true},getProgramParameter:{1:true},getVertexAttrib:{1:true},vertexAttribPointer:{2:true},bindTexture:{0:true},activeTexture:{0:true},getTexParameter:{0:true,1:true},texParameterf:{0:true,1:true},texParameteri:{0:true,1:true,2:true},texImage2D:{0:true,2:true,6:true,7:true},texSubImage2D:{0:true,6:true,7:true},copyTexImage2D:{0:true,2:true},copyTexSubImage2D:{0:true},generateMipmap:{0:true},bindBuffer:{0:true},bufferData:{0:true,2:true},bufferSubData:{0:true},getBufferParameter:{0:true,1:true},pixelStorei:{0:true,1:true},readPixels:{4:true,5:true},bindRenderbuffer:{0:true},bindFramebuffer:{0:true},checkFramebufferStatus:{0:true},framebufferRenderbuffer:{0:true,1:true,2:true},framebufferTexture2D:{0:true,1:true,2:true},getFramebufferAttachmentParameter:{0:true,1:true,2:true},getRenderbufferParameter:{0:true,1:true},renderbufferStorage:{0:true,1:true},clear:{0:true},depthFunc:{0:true},blendFunc:{0:true,1:true},blendFuncSeparate:{0:true,1:true,2:true,3:true},blendEquation:{0:true},blendEquationSeparate:{0:true,1:true},stencilFunc:{0:true},stencilFuncSeparate:{0:true,1:true},stencilMaskSeparate:{0:true},stencilOp:{0:true,1:true,2:true},stencilOpSeparate:{0:true,1:true,2:true,3:true},cullFace:{0:true},frontFace:{0:true}};var n=null;return{init:r,mightBeEnum:s,glEnumToString:o,glFunctionArgToString:u,makeDebugContext:a,makeLostContextSimulatingContext:l,resetToInitialState:f}}();Array=Array;Array.prototype.remove=function(e){var t=null;while((t=this.indexOf(e))!=-1){this.splice(t,1)}};Array.prototype.contains=function(e){var t=this.indexOf(e);return t!=-1};Object.defineProperties(Array.prototype,{x:{get:function(){return this[0]}},y:{get:function(){return this[1]}},z:{get:function(){return this[2]}},w:{get:function(){return this[3]}},r:{get:function(){return this[0]}},g:{get:function(){return this[1]}},b:{get:function(){return this[2]}},a:{get:function(){return this[3]}}});V3=V3;M4x4=M4x4;V3.transform=function(t,n,r){if(r==undefined){r=new MJS_FLOAT_ARRAY_TYPE(3)}r[0]=t[0]*n[0]+t[1]*n[4]+t[2]*n[8]+n[12];r[1]=t[0]*n[1]+t[1]*n[5]+t[2]*n[9]+n[13];r[2]=t[0]*n[2]+t[1]*n[6]+t[2]*n[10]+n[14];var i=t[0]*n[3]+t[1]*n[7]+t[2]*n[11]+n[15];r[0]=r[0]/i;r[1]=r[1]/i;r[2]=r[2]/i;return r};M4x4.inverseOrthonormal=function(t,n){if(n==undefined)n=new MJS_FLOAT_ARRAY_TYPE(16);M4x4.transpose(t,n);var r=[t[12],t[13],t[14]];n[3]=n[7]=n[11]=0;n[12]=-V3.dot([n[0],n[4],n[8]],r);n[13]=-V3.dot([n[1],n[5],n[9]],r);n[14]=-V3.dot([n[2],n[6],n[10]],r);return n};V3.direction=function(t,n,r){if(r==undefined)r=new MJS_FLOAT_ARRAY_TYPE(3);return V3.normalize(V3.sub(n,t,r),r)};V3.equalScalar=function(t,n,r){var i=Math.abs(t);var s=Math.abs(n);var o=Math.abs(t-n);if(t==n){return true}else if(t*n==0){return o<r*r}else{return o/(i+s)<r}};V3.equal=function(t,n,r){if(r==undefined){r=1e-6}var i=V3.equalScalar(t[0],n[0],r);i=i&&V3.equalScalar(t[1],n[1],r);i=i&&V3.equalScalar(t[2],n[2],r);return i};M4x4.makeInversePerspective=function(t,n,r,i,s){var o=r*Math.tan(t*Math.PI/360);var u=-o;var a=u*n;var f=o*n;return M4x4.makeInverseFrustum(a,f,u,o,r,i,s)};M4x4.makeInverseFrustum=function(t,n,r,i,s,o,u){if(u==undefined)u=new MJS_FLOAT_ARRAY_TYPE(16);u[0]=(-t+n)/(2*s);u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=(-r+i)/(2*s);u[6]=0;u[7]=0;u[8]=0;u[9]=0;u[10]=0;u[11]=-(o-s)/(2*o*s);u[12]=(t+n)/(2*s);u[13]=(r+i)/(2*s);u[14]=-1;u[15]=(o+s)/(2*o*s);return u};M4x4.copy=function(e,t){for(var n=0;n<16;n++){t[n]=e[n]}};String.prototype.repeat=function(e){var t="";for(var n=0;n<e;n++){t+=this}return t};String.prototype.leftPad=function(e,t){if(t==null){t=" "}var n="";var r=e-this.length;if(r>0){n=t.repeat(r)+this}return n};String.prototype.rightPad=function(e,t){if(t==null){t=" "}var n="";var r=e-this.length;if(r>0){n=this+t.repeat(r)}return n};String.fromBuffer=function(e){var t="";var n=new Uint8Array(e);for(var r=0;r<n.length;r++){t+=String.fromCharCode(n[r])}return t};Object.defineProperty(String.prototype,"first",{get:function(){return"lala"}});ArrayBuffer=ArrayBuffer;ArrayBuffer.prototype.subarray=function(e,t){if(t==null){t=this.byteLength-e}var n=new ArrayBuffer(t);var r=new Int8Array(n);var i=new Int8Array(this);for(var s=0;s<t;s++){r[s]=i[e+s]}return n};Float32Array=Float32Array;Float32Array.prototype.toString=function(){var e="";for(var t=0;t<this.length;t++){e+=this[t]+", "}return e};Float32Array.prototype.toMatrixFormString=function(){var e="";for(var t=0;t<this.length;t++){if(t!=0&&t%4==0){e+="\n"}e+=this[t].toFixed(3)+"	"}return e};Object.defineProperties(Float32Array.prototype,{x:{get:function(){return this[0]}},y:{get:function(){return this[1]}},z:{get:function(){return this[2]}},w:{get:function(){return this[3]}},r:{get:function(){return this[0]}},g:{get:function(){return this[1]}},b:{get:function(){return this[2]}},a:{get:function(){return this[3]}}});var inheriting={};KeyListener.pressedKeys=new Array;KeyListener.listener=new Array;KeyListener.addListener=function(e){if(!KeyListener.listener.contains(e)){KeyListener.listener.push(e)}};KeyListener.removeListener=function(e){KeyListener.listener.remove(e)};KeyListener.keyDown=function(e){if(!KeyListener.pressedKeys.contains(e.which)){KeyListener.pressedKeys.push(e.which)}for(var t=0;t<KeyListener.listener.length;t++){KeyListener.listener[t].invokeKeyDown(e)}e.stopPropagation()};KeyListener.keyUp=function(e){KeyListener.pressedKeys.remove(e.which);for(var t=0;t<KeyListener.listener.length;t++){KeyListener.listener[t].invokeKeyUp(e)}};KeyListener.keyPress=function(e){for(var t=0;t<KeyListener.listener.length;t++){KeyListener.listener[t].invokeKeyPress(e)}};KeyCodes.SPACE=32;KeyCodes.M=77;MouseListener.x=null;MouseListener.y=null;MouseListener.pressedKeys=new Array;MouseListener.listener=new Array;MouseListener.addListener=function(e){if(!MouseListener.listener.contains(e)){MouseListener.listener.push(e)}};MouseListener.removeListener=function(e){MouseListener.listener.remove(e)};MouseListener.mouseDown=function(e){MouseListener.pressedKeys.push(e.button);for(var t=0;t<MouseListener.listener.length;t++){MouseListener.listener[t].invokeMouseDown(e)}return false};MouseListener.mouseUp=function(e){MouseListener.pressedKeys.remove(e.button);for(var t=0;t<MouseListener.listener.length;t++){MouseListener.listener[t].invokeMouseUp(e)}return false};MouseListener.mouseWheel=function(e){var t=window.event||e;var n=t.detail?t.detail*-120:t.wheelDelta;var r=true;for(var i=0;i<MouseListener.listener.length;i++){r=r&&MouseListener.listener[i].invokeMouseWheel(n,e)}return r};MouseListener.mouseMove=function(e){if(MouseListener.x==null){MouseListener.x=e.screenX;MouseListener.y=e.screenY}var t=e.screenX-MouseListener.x;var n=e.screenY-MouseListener.y;MouseListener.x=e.screenX;MouseListener.y=e.screenY;if(MouseListener.pressedKeys.length>0){for(var r=0;r<MouseListener.listener.length;r++){MouseListener.listener[r].invokeMouseDrag(e,MouseListener.pressedKeys,t,n)}}else{for(var r=0;r<MouseListener.listener.length;r++){MouseListener.listener[r].invokeMouseMove(e,t,n)}}return true};Mouse.left=0;Mouse.middle=1;Mouse.right=2;TextureManager.textures=new Array;TextureManager.getTexture=function(e){for(var t=0;t<this.textures.length;t++){var n=this.textures[t];if(n.name==e){return n}}return null};TextureManager.loadTexture=function(e,t){var n=new Image;n.onload=function(){var r=new Texture;r.source=e;r.name=t;r.image=n;gl.bindTexture(gl.TEXTURE_2D,r.glid);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,r.image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);TextureManager.textures.push(r)};n.src=e};Texture.prototype.setData=function(e,t,n){var r=0;gl.bindTexture(gl.TEXTURE_2D,this.glid);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,n,r,gl.RGBA,gl.UNSIGNED_BYTE,e);gl.bindTexture(gl.TEXTURE_2D,null)};MaterialManager.materials=new Array;MaterialManager.addMaterial=function(e){if(MaterialManager.getMaterial(e.name)!=null){var t="material has already been created: "+e.name;Logger.error(t);throw t}this.materials.push(e)};MaterialManager.getMaterial=function(e){for(var t=0;t<this.materials.length;t++){var n=this.materials[t];if(n.name==e){return n}}return null};Shader.count=0;ShaderAttribute.Position="aVertexPosition";ShaderAttribute.Color="aVertexColor";ShaderAttribute.Normal="aVertexNormal";Shader.prototype.initUniforms=function(){this.uniforms={};var e=gl.getProgramParameter(this.program,gl.ACTIVE_UNIFORMS);for(var t=0;t<e;t++){var n=gl.getActiveUniform(this.program,t);var r=n.name;this.uniforms[r]=gl.getUniformLocation(this.program,r)}};Shader.prototype.initAttributes=function(){this.attributes={};var e=gl.getProgramParameter(this.program,gl.ACTIVE_ATTRIBUTES);for(var t=0;t<e;t++){var n=gl.getActiveAttrib(this.program,t);var r=n.name;this.attributes[r]=gl.getAttribLocation(this.program,r)}};Shader.prototype.relink=function(){if(this.vertexShaderName==null){console.log("Shader.vertexShaderName is null -> Shader won't be linked")}if(this.fragmentShaderName==null){console.log("Shader.fragmentShaderName is null -> Shader won't be linked")}if(this.program!=null){gl.deleteProgram(program)}this.program=gl.createProgram();var e=ShaderManager.getVertexShader(this.vertexShaderName);var t=ShaderManager.getFragmentShader(this.fragmentShaderName);gl.attachShader(this.program,e);gl.attachShader(this.program,t);gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){console.log(gl.getProgramInfoLog(this.program));return}};Shader.prototype.setVertexShaderName=function(e){this.vertexShaderName=e};Shader.prototype.setFragmentShaderName=function(e){this.fragmentShaderName=e};Plane.prototype.distanceTo=function(t){var n=this.normal[0];var r=this.normal[1];var i=this.normal[2];var s=-(n*t[0]+r*t[1]+i*t[2]);return this.distance-s};Plane.prototype.intersection=function(e,t){var n=this.normal;var r=e;var i=t;var s=this.distance;var o=-(s+V3.dot(n,r))/V3.dot(n,i);var u=V3.add(r,V3.scale(t,o));return u};Frustum.fromCamera=function(e){var t=new Frustum;var n=e.globalTransformation;var r=2*e.nearClipPlane*Math.tan(e.fieldOfView*Math.PI/360);var i=2*e.farClipPlane*Math.tan(e.fieldOfView*Math.PI/360);var s=r*e.aspectRatio;var o=i*e.aspectRatio;var u=[0,0,-e.nearClipPlane];var a=[0,0,-e.farClipPlane];t.pNearUL=V3.add(u,[-s/2,+r/2,0]);t.pNearUR=V3.add(u,[+s/2,+r/2,0]);t.pNearLL=V3.add(u,[-s/2,-r/2,0]);t.pNearLR=V3.add(u,[+s/2,-r/2,0]);t.pFarUL=V3.add(a,[-o/2,+i/2,0]);t.pFarUR=V3.add(a,[+o/2,+i/2,0]);t.pFarLL=V3.add(a,[-o/2,-i/2,0]);t.pFarLR=V3.add(a,[+o/2,-i/2,0]);t.pNearUL=V3.transform(t.pNearUL,n);t.pNearUR=V3.transform(t.pNearUR,n);t.pNearLL=V3.transform(t.pNearLL,n);t.pNearLR=V3.transform(t.pNearLR,n);t.pFarUL=V3.transform(t.pFarUL,n);t.pFarUR=V3.transform(t.pFarUR,n);t.pFarLL=V3.transform(t.pFarLL,n);t.pFarLR=V3.transform(t.pFarLR,n);t.nearPlane=Frustum.calculatePlane(t.pNearLL,t.pNearUL,t.pNearLR);t.farPlane=Frustum.calculatePlane(t.pFarLR,t.pFarUR,t.pFarLL);t.leftPlane=Frustum.calculatePlane(t.pFarLL,t.pFarUL,t.pNearLL);t.rightPlane=Frustum.calculatePlane(t.pNearLR,t.pNearUR,t.pFarLR);t.topPlane=Frustum.calculatePlane(t.pNearUR,t.pNearUL,t.pFarUR);t.bottomPlane=Frustum.calculatePlane(t.pNearLL,t.pNearLR,t.pFarLL);t.planes=[t.nearPlane,t.farPlane,t.leftPlane,t.rightPlane,t.topPlane,t.bottomPlane];return t};Frustum.calculatePlane=function(e,t,n){var r=V3.direction(e,t);var i=V3.direction(e,n);var s=V3.cross(r,i);var o=s[0];var u=s[1];var a=s[2];var f=e[0];var l=e[1];var c=e[2];var h=-o*f-u*l-a*c;return new Plane(h,s)};Frustum.prototype.isOutside=function(t){for(var n=0;n<this.planes.length;n++){var r=this.planes[n];if(r.distanceTo(t.getPositive(r.normal))<0)return true}return false};Renderer.prototype.viewport=function(e,t,n,r){this._viewport=[e,t,n,r];gl.viewport(e,t,n,r)};Renderer.prototype.worldPosAt=function(e){this.worldPosCallbackQueue.push(e)};Renderer.prototype._worldPosAt=function(e,t,n,r){var i=this.fboColor;var s=this.fboDepthAsRGBA;this.fboColor=null;if(this.fboWorldPosAt==null){this.fboWorldPosAt=new Framebuffer(this._viewport[2],this._viewport[3])}this.fboWorldPosAt.bind();gl.clearColor(this.bgColor.r,this.bgColor.g,this.bgColor.b,this.bgColor.a);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.enable(gl.SCISSOR_TEST);gl.scissor(e-n/2,t-n/2,n,r);this.fboDepthAsRGBA=this.fboWorldPosAt;this.render();var o=new Uint8Array(n*r*4);gl.readPixels(e-n/2,t-r/2,n,r,gl.RGBA,gl.UNSIGNED_BYTE,o);var u=Infinity;var a=null;for(var f=0;f<n*r;f++){var l=f%n-n/2;var c=f/r-r/2;var h=l*l+c*c;var p=f*4;var d=[o[p+0],o[p+1],o[p+2],o[p+3]];if(!(d[0]+d[1]+d[2]==0&&d[3]==255)&&h<u){a=d}}var v=50;if(a!=null){var m=a[0]/255;var g=a[1]/255;var y=a[2]/255;var b=a[3]/255;var w=m/(256*256*256)+g/(256*256)+y/256+b;var E=this.camera.inverseProjectionMatrix;v=Math.abs(V3.transform(V3.$(0,0,w),E).z)}var S=null;{var x=e/Potree.canvas.width;var T=t/Potree.canvas.height;var N=this.camera.getDirection(x,T);S=V3.add(this.camera.globalPosition,V3.scale(N,v))}{this.fboColor=i;this.fboDepthAsRGBA=s;gl.disable(gl.SCISSOR_TEST);gl.viewport(this._viewport[0],this._viewport[1],this._viewport[2],this._viewport[3])}return S};Renderer.prototype.clear=function(){if(this.fboColor!=null){this.fboColor.bind();gl.clearColor(this.bgColor.r,this.bgColor.g,this.bgColor.b,this.bgColor.a);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}};Renderer.prototype.render=function(){this.clear();this.lights=new Array;var e=new Array;var t=new Array;var n=new Array;this.camera=this.scene.activeCamera;var r=new Array;r.push(this.scene.rootNode);while(r.length>0){var i=r.pop();for(var s in i.children){r.push(i.children[s])}if(i instanceof Light){this.lights.push(i)}else if(i instanceof PointCloudSceneNode){e.push(i)}else if(i instanceof PointcloudOctreeSceneNode){t.push(i)}else if(i instanceof Sphere){n.push(i)}}for(var s=0;s<e.length;s++){var i=e[s];i.render(this)}for(var s=0;s<t.length;s++){var i=t[s];i.render(this)}for(var s=0;s<n.length;s++){var i=n[s];i.render(this)}if(this.fboDepthAsRGBA==null){for(var s=0;s<this.worldPosCallbackQueue.length;s++){var o=this.worldPosCallbackQueue[s];var u=this._worldPosAt(o.x,o.y,o.width,o.height);o.callback(u)}this.worldPosCallbackQueue.length=0}};AABB.prototype.setDimension=function(e,t,n,r,i,s,o,u){this.p0=e;this.p1=t;this.p2=n;this.p3=r;this.p4=i;this.p5=s;this.p6=o;this.p7=u;this.update()};AABB.prototype.setDimensionByMinMax=function(e,t){this.p0=[e[0],e[1],t[2]];this.p1=[t[0],e[1],t[2]];this.p2=[t[0],e[1],e[2]];this.p3=[e[0],e[1],e[2]];this.p4=[e[0],t[1],t[2]];this.p5=[t[0],t[1],t[2]];this.p6=[t[0],t[1],e[2]];this.p7=[e[0],t[1],e[2]];this.update()};AABB.prototype.setTransform=function(e){this.transform=e;this.update()};AABB.tmpVec=V3.$(0,0,0);AABB.prototype.update=function(){this.objectSpaceMin[0]=Math.min(this.p0[0],this.p1[0],this.p2[0],this.p3[0],this.p4[0],this.p5[0],this.p6[0],this.p7[0]);this.objectSpaceMin[1]=Math.min(this.p0[1],this.p1[1],this.p2[1],this.p3[1],this.p4[1],this.p5[1],this.p6[1],this.p7[1]);this.objectSpaceMin[2]=Math.min(this.p0[2],this.p1[2],this.p2[2],this.p3[2],this.p4[2],this.p5[2],this.p6[2],this.p7[2]);this.objectSpaceMax[0]=Math.max(this.p0[0],this.p1[0],this.p2[0],this.p3[0],this.p4[0],this.p5[0],this.p6[0],this.p7[0]);this.objectSpaceMax[1]=Math.max(this.p0[1],this.p1[1],this.p2[1],this.p3[1],this.p4[1],this.p5[1],this.p6[1],this.p7[1]);this.objectSpaceMax[2]=Math.max(this.p0[2],this.p1[2],this.p2[2],this.p3[2],this.p4[2],this.p5[2],this.p6[2],this.p7[2]);V3.transform(this.p0,this.transform,this.tp0);V3.transform(this.p1,this.transform,this.tp1);V3.transform(this.p2,this.transform,this.tp2);V3.transform(this.p3,this.transform,this.tp3);V3.transform(this.p4,this.transform,this.tp4);V3.transform(this.p5,this.transform,this.tp5);V3.transform(this.p6,this.transform,this.tp6);V3.transform(this.p7,this.transform,this.tp7);this.min[0]=Math.min(this.tp0[0],this.tp1[0],this.tp2[0],this.tp3[0],this.tp4[0],this.tp5[0],this.tp6[0],this.tp7[0]);this.min[1]=Math.min(this.tp0[1],this.tp1[1],this.tp2[1],this.tp3[1],this.tp4[1],this.tp5[1],this.tp6[1],this.tp7[1]);this.min[2]=Math.min(this.tp0[2],this.tp1[2],this.tp2[2],this.tp3[2],this.tp4[2],this.tp5[2],this.tp6[2],this.tp7[2]);this.max[0]=Math.max(this.tp0[0],this.tp1[0],this.tp2[0],this.tp3[0],this.tp4[0],this.tp5[0],this.tp6[0],this.tp7[0]);this.max[1]=Math.max(this.tp0[1],this.tp1[1],this.tp2[1],this.tp3[1],this.tp4[1],this.tp5[1],this.tp6[1],this.tp7[1]);this.max[2]=Math.max(this.tp0[2],this.tp1[2],this.tp2[2],this.tp3[2],this.tp4[2],this.tp5[2],this.tp6[2],this.tp7[2]);V3.add(this.min,this.max,this.center);V3.scale(this.center,.5,this.center);V3.sub(this.max,this.min,AABB.tmpVec);this.radius=V3.length(AABB.tmpVec)/2};AABB.prototype.getOnScreenSize=function(e,t){var n=e.globalTransformation;var r=t.viewMatrix;var i=t.projectionMatrix;var s=M4x4.mul(i,M4x4.mul(r,n));var o=V3.transform(this.min,s);var u=V3.transform(this.max,s);var a=V3.sub(o,u);var f=V3.length(a);return f};AABB.prototype.setColor=function(e){this.color=e};AABB.prototype.render=function(e,t){this.material.setColor(this.color);this.material.render(this,e,t)};AABB.prototype.getPositive=function(t){var n=this.min;var r=this.max;var i=[n[0],n[1],n[2]];if(t[0]>=0){i[0]=r[0]}if(t[1]>=0){i[1]=r[1]}if(t[2]>=0){i[2]=r[2]}return i};AABB.prototype.getNegative=function(e){var t=this.min;var n=this.max;var r=[n[0],n[1],n[2]];if(e[0]>=0){r[0]=t[0]}if(e[1]>=0){r[1]=t[1]}if(e[2]>=0){r[2]=t[2]}return r};Object.defineProperty(SceneNode.prototype,"visible",{set:function(e){this._visible=e},get:function(){return this._visible}});Object.defineProperty(SceneNode.prototype,"scene",{set:function(e){this._scene=e},get:function(){return this._scene}});Object.defineProperty(SceneNode.prototype,"transform",{get:function(){return this._transform},set:function(e){this._transform=e}});Object.defineProperty(SceneNode.prototype,"localTransformation",{get:function(){return this._transform}});Object.defineProperty(SceneNode.prototype,"globalTransformation",{get:function(){var e=this;var t=this.tmpMatrix1;var n=this.tmpMatrix2;M4x4.copy(e._transform,t);while(e.parent!=null){e=e.parent;M4x4.mul(e._transform,t,n);var r=t;t=n;n=r}return t}});Object.defineProperty(SceneNode.prototype,"localPosition",{get:function(){return V3.transform(V3.$(0,0,0),this._transform)}});Object.defineProperty(SceneNode.prototype,"globalPosition",{get:function(){V3.transform(V3.$(0,0,0),this.globalTransformation,this._globalPosition);return this._globalPosition}});Object.defineProperty(SceneNode.prototype,"descendants",{get:function(){var e=new Array;var t=new Array;t.push(this);while(t.length!=0){var n=t.pop();e.push(n);for(var r in n.children){t.push(n.children[r])}}return e}});SceneNode.prototype.getLocalDirection=function(){var e=V3.transform(V3.$(0,0,0),this._transform);var t=V3.transform(V3.$(0,0,-1),this._transform);var n=V3.normalize(V3.sub(t,e));return n};SceneNode.prototype.getGlobalDirection=function(){var e=this.globalTransformation;var t=V3.transform(V3.$(0,0,0),e);var n=V3.transform(V3.$(0,0,-1),e);var r=V3.normalize(V3.sub(n,t));return r};SceneNode.prototype.getUpVector=function(){var e=V3.transform(V3.$(0,0,0),this._transform);var t=V3.transform(V3.$(0,1,0),this._transform);var n=V3.sub(t,e);return n};SceneNode.prototype.getSideVector=function(){var e=V3.transform(V3.$(0,0,0),this._transform);var t=V3.transform(V3.$(1,0,0),this._transform);var n=V3.sub(t,e);return n};SceneNode.prototype.getViewVector=function(){var e=V3.transform(V3.$(0,0,0),this._transform);var t=V3.transform(V3.$(1,0,0),this._transform);var n=V3.sub(t,e);return n};SceneNode.prototype.addTime=function(e){this.age+=e;for(var t in this.children){this.children[t].addTime(e)}};SceneNode.prototype.setParent=function(e){if(this.parent!=null){delete this.parent.children[this.name]}this.parent=e;if(e!=null){e.children[this.name]=this;this.scene=e.scene}};SceneNode.prototype.addChild=function(e){if(e.parent!=null){delete e.parent.children[e.name]}e.parent=this;e.scene=this.scene;this.children[e.name]=e};SceneNode.prototype.getInverseLocalTransformation=function(){var e=this.localPosition;var t=M4x4.translate3(-e[0],-e[1],-e[2],M4x4.I);var n=M4x4.mul(t,this._transform);var r=M4x4.inverseOrthonormal(n);return M4x4.mul(r,t)};SceneNode.prototype.getInverseGlobalTransformation=function(){var e=this.globalPosition;M4x4.translate3(-e[0],-e[1],-e[2],M4x4.I,this.tmpMatrix1);var t=this.tmpMatrix1;M4x4.mul(t,this.globalTransformation,this.tmpMatrix2);M4x4.inverseOrthonormal(this.tmpMatrix2,this.tmpMatrix3);M4x4.mul(this.tmpMatrix3,t,this.tmpMatrix2);return this.tmpMatrix2};SceneNode.prototype.translate=function(e,t,n){this._transform=M4x4.mul(M4x4.makeTranslate3(e,t,n),this._transform)};SceneNode.prototype.rotate=function(e,t){this._transform=M4x4.mul(M4x4.rotate(e,t,M4x4.I),this._transform)};SceneNode.prototype.rotateX=function(e){this._transform=M4x4.mul(M4x4.rotate(e,V3.$(1,0,0),M4x4.I),this._transform)};SceneNode.prototype.rotateY=function(e){this._transform=M4x4.mul(M4x4.rotate(e,V3.$(0,1,0),M4x4.I),this._transform)};SceneNode.prototype.rotateZ=function(e){this._transform=M4x4.mul(M4x4.rotate(e,V3.$(0,0,1),M4x4.I),this._transform)};SceneNode.prototype.scale=function(e,t,n){this._transform=M4x4.scale3(e,t,n,this._transform)};SceneNode.prototype.lookAt=function(e){var t=this.globalPosition;var n=V3.direction(t,e);var r=V3.$(0,1,0);var i=V3.cross(r,n);r=V3.cross(n,i);i=V3.neg(i);r=V3.neg(r);n=V3.neg(n);var s=M4x4.$(i.x,i.y,i.z,0,r.x,r.y,r.z,0,n.x,n.y,n.z,0,0,0,0,1);var o=M4x4.makeTranslate3(t.x,t.y,t.z);this.transform=M4x4.mul(o,s)};SceneNode.prototype.render=function(e){};SceneNode.prototype.toString=function(){return this.asTreeString(0)};SceneNode.prototype.asTreeString=function(e){var t=" ".repeat(e*3)+this.name+"	"+this.globalPosition+"\n";for(var n in this.children){t+=this.children[n].asTreeString(e+1)}return t};Camera.prototype=new SceneNode(inheriting);Camera.base=SceneNode.prototype;Object.defineProperties(Camera.prototype,{farClipPlane:{set:function(e){this._farClipPlane=e;this.updateProjectionMatrix()},get:function(){return this._farClipPlane}},nearClipPlane:{set:function(e){this._nearClipPlane=e;this.updateProjectionMatrix()},get:function(){return this._nearClipPlane}},transform:{set:function(e){Object.getOwnPropertyDescriptor(Camera.base,"transform").set.call(this,e);this.updateViewMatrix()},get:function(){return this._transform}},frustum:{get:function(){return Frustum.fromCamera(this)}},projectionMatrix:{get:function(){return this._projectionMatrix}},inverseProjectionMatrix:{get:function(){return this._inverseProjectionMatrix}},viewMatrix:{get:function(){return this._viewMatrix},set:function(e){this._viewMatrix=e}},fieldOfView:{set:function(e){this._fieldOfView=e;this.updateProjectionMatrix()},get:function(){return this._fieldOfView}},aspectRatio:{set:function(e){this._aspectRatio=e;this.updateProjectionMatrix()},get:function(){return this._aspectRatio}}});Camera.prototype.updateProjectionMatrix=function(){this._projectionMatrix=M4x4.makePerspective(this.fieldOfView,this.aspectRatio,this.nearClipPlane,this.farClipPlane);this._inverseProjectionMatrix=M4x4.makeInversePerspective(this.fieldOfView,this.aspectRatio,this.nearClipPlane,this.farClipPlane)};Camera.prototype.updateViewMatrix=function(){this.viewMatrix=this.getInverseGlobalTransformation()};Camera.prototype.translate=function(e,t,n){Camera.base.translate.call(this,e,t,n);this.updateViewMatrix()};Camera.prototype.getDirection=function(e,t){var n=this.nearClipPlane*Math.tan(this.fieldOfView*Math.PI/360);var r=-n;var i=r*this.aspectRatio;var s=n*this.aspectRatio;var o=(1-e)*i+e*s;var u=(1-t)*r+t*n;var a=this.nearClipPlane;var f=V3.normalize(V3.$(o,u,-a));f=V3.transform(f,this.globalTransformation);f=V3.sub(f,this.globalPosition);return V3.normalize(f)};Object.defineProperty(Scene.prototype,"nodes",{get:function(){var e=new Array;e.push(this.rootNode);e.push(this.rootNode.descendants)}});MeshNode.prototype=new SceneNode(inheriting);MeshNode.prototype.render=function(e){if(this.visible){this.mesh.render(this,e)}};LightType.OMNI=0;LightType.SPOT=1;LightType.DIRECTIONAL=2;Light.prototype=new SceneNode(inheriting);Light.prototype.notifyChildAttachedToParent=function(){this.scene.lights[this.name]=this};Object.defineProperty(Light.prototype,"red",{get:function(){return this.colour[0]},set:function(e){this.colour[0]=e}});Object.defineProperty(Light.prototype,"green",{get:function(){return this.colour[1]},set:function(e){this.colour[1]=e}});Object.defineProperty(Light.prototype,"blue",{get:function(){return this.colour[2]},set:function(e){this.colour[2]=e}});Sphere.prototype=new SceneNode(inheriting);Object.defineProperty(Sphere.prototype,"mesh",{get:function(){if(this._mesh==null){this._mesh=new Mesh("sphere");var e=new SubMesh(this._mesh);this._mesh.addSubMesh(e);var t=[];var n=[];var r=[];var i=[];var s=Math.PI/this.tesselation;var o=2*Math.PI/s;var u=this.tesselation;var a=0;for(var f=0;f<=u;f++){for(var l=0;l<o;l++){var c=l*s;var h=Math.cos(Math.PI*f/u);var p=Math.cos(c)*Math.sqrt(1-h*h);var d=Math.sin(c)*Math.sqrt(1-h*h);var v=h;t.push(p);t.push(d);t.push(v);n.push(p);n.push(d);n.push(v);r.push(p/2+.5);r.push(d/2*.5);if(a>=o){i.push(a-o);i.push(a);if(l==o-1){i.push(a+1-o)}else{i.push(a+1)}if(l==o-1){var m=Math.max(0,a+1-o-o);i.push(m)}else{i.push(a-o+1)}i.push(a-o);if(l==o-1){i.push(a+1-o)}else{i.push(a+1)}}a++}}e.setVertexBufferData("POSITION",new Float32Array(t));e.setVertexBufferData("NORMAL",new Float32Array(n));e.setVertexBufferData("TEXCOORD_0",new Float32Array(r));e.setIndexBufferData(new Uint16Array(i));e.vertexCount=t.length/3;var g=MaterialManager.getMaterial("default");this._mesh.material=g}return this._mesh}});Sphere.prototype.render=function(e){this.mesh.render(this,e)};Object.defineProperty(Sphere.prototype,"material",{get:function(){return this.mesh.material},set:function(e){this.mesh.material=e}});MeshType={TRIANGLES:0,LINES:1,POINTS:2};Mesh.prototype.setType=function(e){this.type=e;if(e==MeshType.TRIANGLES){this.glType=gl.TRIANGLES}else if(e==MeshType.LINES){this.glType=gl.LINES}else if(e==MeshType.POINTS){this.glType=gl.POINTS}else{throw"unknown mesh type: "+e+". use one of the MeshType members."}};Mesh.prototype.render=function(e,t){for(var n=0;n<this.subMeshes.length;n++){var r=this.subMeshes[n];r.render(e,t)}};Mesh.prototype.addSubMesh=function(e){this.subMeshes.push(e)};Mesh.prototype.setMaterial=function(e){this.material=e};Object.defineProperty(Mesh.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e;for(var t=0;t<this.subMeshes.length;t++){var n=this.subMeshes[t];n.material=e}}});SubMesh.prototype.setMaterial=function(e){this.material=e};Object.defineProperty(SubMesh.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e}});SubMesh.prototype.setVertexBufferData=function(e,t){if(this.vbos[e]==null){this.vbos[e]=gl.createBuffer()}gl.bindBuffer(gl.ARRAY_BUFFER,this.vbos[e]);gl.bufferData(gl.ARRAY_BUFFER,t,gl.STATIC_DRAW)};SubMesh.prototype.setIndexBufferData=function(e){if(this.ibo==null){this.ibo=gl.createBuffer()}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,e,gl.STATIC_DRAW);this.indices=e};SubMesh.prototype.render=function(e,t){this.material.renderSubMesh(this,e,t)};Viewport.prototype.setCamera=function(e){this.camera=e;this.camera.aspectRatio=this.width/this.height};Viewport.prototype.setCanvas=function(e){this.canvas=e;if(e!=null){this.width=e.width;this.height=e.height}if(this.camera!=null){this.camera.aspectRatio=this.width/this.height}};Viewport.prototype.setDimension=function(e,t,n,r){this.x=0;this.y=0;this.width=n;this.height=r;if(this.camera!=null){this.camera.aspectRatio=this.width/this.height}};Viewport.prototype.addTime=function(e){this.velocity[0]=.2*this.velocity[0]+.8*this.targetVelocity[0]*this.targetVelocityMultiplicator;this.velocity[1]=.2*this.velocity[1]+.8*this.targetVelocity[1]*this.targetVelocityMultiplicator;this.velocity[2]=.2*this.velocity[2]+.8*this.targetVelocity[2]*this.targetVelocityMultiplicator;var t=[this.velocity[0]*e,this.velocity[1]*e,this.velocity[2]*e];this.camera.translate(t[0],t[1],t[2])};Viewport.prototype.invokeKeyDown=function(e){if(e.which==83){this.targetVelocity[2]=1}else if(e.which==87){this.targetVelocity[2]=-1}else if(e.which==68){this.targetVelocity[0]=1}else if(e.which==65){this.targetVelocity[0]=-1}};Viewport.prototype.invokeKeyUp=function(e){if(e.which==83){this.targetVelocity[2]=0}else if(e.which==87){this.targetVelocity[2]=0}else if(e.which==68){this.targetVelocity[0]=0}else if(e.which==65){this.targetVelocity[0]=0}};Viewport.prototype.invokeKeyPress=function(e){};Viewport.prototype.invokeMouseDown=function(e){};Viewport.prototype.invokeMouseUp=function(e){};Viewport.prototype.invokeMouseMove=function(e,t,n){};Viewport.prototype.invokeMouseDrag=function(e,t,n,r){if(t.length==1&&t.contains(1)){if(e.altKey){var i=this.camera.localPosition;var s=M4x4.translate3(-i[0],-i[1],-i[2],M4x4.I);var o=M4x4.rotate(-n/100,this.camera.getUpVector(),M4x4.I);var u=M4x4.rotate(-r/100,this.camera.getSideVector(),M4x4.I);var o=M4x4.rotate(-n/100,[0,1,0],M4x4.I);var u=M4x4.rotate(-r/100,this.camera.getSideVector(),M4x4.I);var a=M4x4.translate3(i[0],i[1],i[2],M4x4.I);var f=M4x4.mul(s,this.camera.transform);f=M4x4.mul(u,f);f=M4x4.mul(a,f);this.camera.setTransform(f);this.camera.resolveTransformation();var f=M4x4.mul(s,this.camera.transform);f=M4x4.mul(o,f);f=M4x4.mul(a,f);this.camera.setTransform(f);this.camera.resolveTransformation()}else{this.camera.translate(-n/10,r/10,0)}}};Viewport.prototype.invokeMouseWheel=function(e){var t=-e/100;this.camera.translate(0,0,t);var n=this.camera.scene;var r=n.rootNode};CamHandler.prototype.addTime=function(e){};CamHandler.prototype.invokeKeyDown=function(e){};CamHandler.prototype.invokeKeyUp=function(e){};CamHandler.prototype.invokeKeyPress=function(e){};CamHandler.prototype.invokeMouseDown=function(e){};CamHandler.prototype.invokeMouseUp=function(e){};CamHandler.prototype.invokeMouseMove=function(e,t,n){};CamHandler.prototype.invokeMouseDrag=function(e,t,n,r){};CamHandler.prototype.invokeMouseWheel=function(e){};FreeFlightCamHandler.prototype=new CamHandler;FreeFlightCamHandler.prototype.addTime=function(e){this.update(e)};FreeFlightCamHandler.prototype.update=function(e){this.velocity[0]=.2*this.velocity[0]+.8*this.targetVelocity[0]*this.targetVelocityMultiplicator;this.velocity[1]=.2*this.velocity[1]+.8*this.targetVelocity[1]*this.targetVelocityMultiplicator;this.velocity[2]=.2*this.velocity[2]+.8*this.targetVelocity[2]*this.targetVelocityMultiplicator;var t=[this.velocity[0]*e,this.velocity[1]*e,this.velocity[2]*e];this.camera.transform=M4x4.translate3(t[0],t[1],t[2],this.camera.transform);if(this.qualityToggle>0){this.qualityToggle-=e}};FreeFlightCamHandler.prototype.invokeKeyDown=function(e){if(e.which==83){this.targetVelocity[2]=1*this.speedMultiplier}else if(e.which==87){this.targetVelocity[2]=-1*this.speedMultiplier}else if(e.which==68){this.targetVelocity[0]=1*this.speedMultiplier}else if(e.which==65){this.targetVelocity[0]=-1*this.speedMultiplier}};FreeFlightCamHandler.prototype.invokeKeyUp=function(e){if(e.which==83){this.targetVelocity[2]=0}else if(e.which==87){this.targetVelocity[2]=0}else if(e.which==68){this.targetVelocity[0]=0}else if(e.which==65){this.targetVelocity[0]=0}};FreeFlightCamHandler.prototype.invokeKeyPress=function(e){};FreeFlightCamHandler.prototype.invokeMouseDown=function(e){};FreeFlightCamHandler.prototype.invokeMouseUp=function(e){};FreeFlightCamHandler.prototype.invokeMouseMove=function(e,t,n){};FreeFlightCamHandler.prototype.invokeMouseDrag=function(e,t,n,r){if(t.length==1&&t.contains(0)&&KeyListener.pressedKeys.contains(18)){this.camera.transform=M4x4.translate3(this.speedMultiplier*-n/10,this.speedMultiplier*r/10,0,this.camera.transform);this.qualityToggle=.1}else if(t.length==1&&t.contains(0)){var i=this.camera.localPosition;var s=M4x4.translate3(-i[0],-i[1],-i[2],M4x4.I);var o=M4x4.rotate(-n/100,[0,1,0],M4x4.I);var u=M4x4.rotate(-r/100,this.camera.getSideVector(),M4x4.I);var a=M4x4.translate3(i[0],i[1],i[2],M4x4.I);var f=M4x4.mul(s,this.camera.transform);f=M4x4.mul(u,f);f=M4x4.mul(a,f);this.camera.transform=f;var f=M4x4.mul(s,this.camera.transform);f=M4x4.mul(o,f);f=M4x4.mul(a,f);this.camera.transform=f;this.qualityToggle=.1}};FreeFlightCamHandler.prototype.invokeMouseWheel=function(e){var t=e/2e3;this.speedMultiplier+=t;this.speedMultiplier=Math.max(.01,Math.min(10,this.speedMultiplier))};OrbitCamHandler.prototype=new CamHandler;OrbitCamHandler.prototype.update=function(e){};OrbitCamHandler.prototype.invokeMouseDrag=function(e,t,n,r){if(t.length==1&&t.contains(0)&&KeyListener.pressedKeys.contains(18)){this.camera.transform=M4x4.translate3(this.speedMultiplier*-n/10,this.speedMultiplier*r/10,0,this.camera.transform);this.qualityToggle=.1}else if(t.length==1&&t.contains(0)){this.aY+=.2*timeSinceLastFrame*n;this.update()}};OrbitCamHandler.prototype.invokeMouseWheel=function(e){this.distance-=.05*e*timeSinceLastFrame;this.distance=Math.max(this.distance,2);this.distance=Math.min(this.distance,20);this.update()};OrbitCamHandler.prototype.update=function(){var e=M4x4.I;e=M4x4.rotate(this.aY,[0,1,0],e);e=M4x4.translate3(0,3,this.distance,e);this.camera.transform=e};Framebuffer.getSystemBuffer=function(){if(Framebuffer.systemBuffer==null){Framebuffer.systemBuffer=new Framebuffer("system")}return Framebuffer.systemBuffer};Framebuffer.getActiveBuffer=function(){if(Framebuffer.activeBuffer==null){Framebuffer.activeBuffer=Framebuffer.getSystemBuffer()}return Framebuffer.activeBuffer};Framebuffer.setActiveBuffer=function(e){Framebuffer.activeBuffer=e};Framebuffer.prototype.setSize=function(e,t){this.initBufferStuff(e,t)};Framebuffer.prototype.initOtherStuff=function(){this.vbo=gl.createBuffer();this.texcoordvbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);var e=new Float32Array([0,0,0,1,0,0,1,1,0,0,0,0,1,1,0,0,1,0]);gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.texcoordvbo);var e=new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]);gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW)};Framebuffer.prototype.updateScreenQuad=function(e,t){gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);var n=new Float32Array([e[0],e[1],0,t[0],e[1],0,t[0],t[1],0,e[0],e[1],0,t[0],t[1],0,e[0],t[1],0]);gl.bufferData(gl.ARRAY_BUFFER,n,gl.STATIC_DRAW)};Framebuffer.prototype.initBufferStuff=function(e,t){if(this.width==e&&this.height==t){return}this.width=e;this.height=t;gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.texture!=null){gl.deleteTexture(this.texture.glid);this.texture=null}if(this.renderbuffer!=null){gl.deleteRenderbuffer(this.renderbuffer);this.renderbuffer=null}if(this.framebuffer!=null){gl.deleteFramebuffer(this.framebuffer);this.framebuffer=null}this.framebuffer=gl.createFramebuffer();this.texture=new Texture;this.renderbuffer=gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);this.framebuffer.width=e;this.framebuffer.height=t;this.initColorbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderbuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.framebuffer.width,this.framebuffer.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.glid,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.renderbuffer);this.checkBuffer();gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null)};Framebuffer.prototype.initColorbuffer=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture.glid);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.framebuffer.width,this.framebuffer.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)};Framebuffer.prototype.checkBuffer=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);var t=gl.checkFramebufferStatus(gl.FRAMEBUFFER);switch(t){case gl.FRAMEBUFFER_COMPLETE:break;case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:Logger.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");throw"";break;case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:Logger.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");throw"";break;case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:Logger.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");throw"";break;case gl.FRAMEBUFFER_UNSUPPORTED:Logger.error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");throw"";break;default:Logger.error("Incomplete framebuffer: "+t);throw""}};Framebuffer.bindDefault=function(){Framebuffer.activeBuffer=Framebuffer.getSystemBuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,null)};Framebuffer.prototype.bind=function(){Framebuffer.activeBuffer=this;gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer)};Framebuffer.prototype.drawTexture=function(e,t,n){this.bind();var r=ShaderManager.getShader("drawTexture");gl.useProgram(r.program);this.updateScreenQuad(t,n);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);if(this.framebuffer==null){var i=document.getElementById("canvas");gl.uniform1f(r.uniforms.uWidth,i.width);gl.uniform1f(r.uniforms.uHeight,i.height)}else{gl.uniform1f(r.uniforms.uWidth,this.width);gl.uniform1f(r.uniforms.uHeight,this.height)}gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,e.glid);gl.uniform1i(r.uniforms.uTexture,0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.renderbuffer);gl.uniform1i(r.uniforms.uDepth,0);gl.enableVertexAttribArray(r.attributes.aVertexPosition);gl.enableVertexAttribArray(r.attributes.aTexcoords);gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);gl.vertexAttribPointer(r.attributes.aVertexPosition,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.texcoordvbo);gl.vertexAttribPointer(r.attributes.aTexcoords,2,gl.FLOAT,false,0,0);gl.disable(gl.DEPTH_TEST);gl.drawArrays(gl.TRIANGLES,0,6);gl.disableVertexAttribArray(r.attributes.aVertexPosition);gl.disableVertexAttribArray(r.attributes.aTexcoords)};Framebuffer.prototype.drawFullscreenQuad=function(e){gl.useProgram(e.program);this.updateScreenQuad([-1,-1],[1,1]);gl.enableVertexAttribArray(e.attributes.aVertexPosition);gl.enableVertexAttribArray(e.attributes.aTexcoord);gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);gl.vertexAttribPointer(e.attributes.aVertexPosition,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.texcoordvbo);gl.vertexAttribPointer(e.attributes.aTexcoord,2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,6);gl.disableVertexAttribArray(e.attributes.aVertexPosition);gl.disableVertexAttribArray(e.attributes.aTexcoord)};FramebufferFloat32.prototype=new Framebuffer(inheriting);FramebufferFloat32.base=Framebuffer.prototype;FramebufferFloat32.prototype.initColorbuffer=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture.glid);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.framebuffer.width,this.framebuffer.height,0,gl.RGBA,gl.FLOAT,null)};ShaderManager.vertexShader=new Object;ShaderManager.fragmentShader=new Object;ShaderManager.shader=new Array;ShaderManager.loadVertexShader=function(e,t){var n=ShaderManager.loadShader(e,gl.VERTEX_SHADER,t);ShaderManager.vertexShader[e]=n};ShaderManager.loadFragmentShader=function(e,t){var n=ShaderManager.loadShader(e,gl.FRAGMENT_SHADER,t);ShaderManager.fragmentShader[e]=n};ShaderManager.getVertexShader=function(e){if(ShaderManager.vertexShader[e]==null){ShaderManager.loadVertexShader(e,ShaderManager.getShaderSource(e))}return ShaderManager.vertexShader[e]};ShaderManager.getFragmentShader=function(e){if(ShaderManager.fragmentShader[e]==null){ShaderManager.loadFragmentShader(e,ShaderManager.getShaderSource(e))}return ShaderManager.fragmentShader[e]};ShaderManager.loadShader=function(e,t,n){var r=gl.createShader(t);if(!r){return null}gl.shaderSource(r,n);gl.compileShader(r);if(!gl.getShaderParameter(r,gl.COMPILE_STATUS)){var i="compiling shader '"+e+"' failed: "+gl.getShaderInfoLog(r);alert(i);return null}return r};ShaderManager.getShaderSource=function(e){var t=Potree.shaderDir+"/"+e;return load_binary_resource(t)};ShaderManager.addShader=function(e){if(ShaderManager.getShader(e.name)!=null){var t="shader has already been created: "+e.name;throw t}ShaderManager.shader.push(e)};ShaderManager.getShader=function(e){for(var t=0;t<this.shader.length;t++){var n=this.shader[t];if(n.name==e){return n}}return null};MeshUtils.createRectangle=function(){var e=new Mesh;var t=new SubMesh;e.addSubMesh(t);var n=new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1]);var r=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]);var i=new Float32Array([1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]);var s=new Uint8Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);t.setVertexBufferData("POSITION",n);t.setVertexBufferData("NORMAL",r);t.setVertexBufferData("TEXCOORD_0",i);t.setIndexBufferData(s);var o=MaterialManager.getMaterial("grid");e.setMaterial(o);return e};MeshUtils.createGrid=function(e,t,n){var r=new Mesh;var i=new SubMesh;r.addSubMesh(i);var s=t+n+2;var o=new Float32Array(s*2*3);{var u=-(e*n/2);var a=-(e*t/2);for(var f=0;f<=n;f++){var l=f*6;o[l+0]=u;o[l+1]=0;o[l+2]=a;o[l+3]=u;o[l+4]=0;o[l+5]=-a;u+=e}}{var u=-(e*t/2);var a=-(e*n/2);for(var f=n+1;f<=t+n+1;f++){var l=f*6;o[l+0]=u;o[l+1]=0;o[l+2]=a;o[l+3]=-u;o[l+4]=0;o[l+5]=a;a+=e}}i.setVertexBufferData("POSITION",o);i.vertexCount=s*2;r.setType(MeshType.LINES);var c=new FlatMaterial("grid",[.7,.7,.7,1]);r.setMaterial(c);return r};MeshUtils.createLine=function(e,t){var n=new Mesh;var r=new SubMesh;n.addSubMesh(r);var i=new Float32Array([e[0],e[1],e[2],t[0],t[1],t[2]]);r.setVertexBufferData("POSITION",i);r.vertexCount=2;n.setType(MeshType.LINES);var s=ShaderManager.getShader("defaultFlat");n.setMaterial(s);return n};MeshUtils.createQuad=function(e,t,n,r){var i=new Mesh;var s=new SubMesh;i.addSubMesh(s);var o=new Float32Array([e[0],e[1],e[2],t[0],t[1],t[2],n[0],n[1],n[2],e[0],e[1],e[2],n[0],n[1],n[2],r[0],r[1],r[2]]);s.setVertexBufferData("POSITION",o);s.vertexCount=6;i.setType(MeshType.TRIANGLES);var u=ShaderManager.getShader("defaultFlat");i.setMaterial(u);return i};PointcloudOctreeSceneNode.prototype=new SceneNode(inheriting);PointcloudOctreeSceneNode.base=SceneNode.prototype;PointcloudOctreeSceneNode.prototype.render=function(e,t){if(this.mno==null){return}if(!this.visible){return}this.mno.render(this,e,t)};PointcloudOctreeSceneNode.prototype.addTime=function(t){this.age+=t;this.mno.addTime(t)};Object.defineProperty(PointcloudOctreeSceneNode.prototype,"minDepth",{get:function(){return this.mno.minDepth},set:function(e){this.mno.minDepth=e}});PointCloudSceneNode.prototype=new SceneNode(inheriting);PointCloudSceneNode.base=SceneNode.prototype;Object.defineProperty(PointCloudSceneNode.prototype,"aabb",{get:function(){var e=new AABB;e.setDimensionByMinMax(this.pointCloud.aabb.min,this.pointCloud.aabb.max);e.setTransform(this.transform);return e}});PointCloudSceneNode.prototype.render=function(e){if(this.pointCloud==null){return}if(!this.visible){return}this.material.render(this,e)};PointCloudSceneNode.prototype.addTime=function(t){};PointCloud.prototype.unload=function(){if(this.vbo!=null){gl.bindBuffer(gl.ARRAY_BUFFER,null);gl.deleteBuffer(this.vbo)}};PointCloud.prototype.setVertexBufferData=function(e){if(this.vbo==null){this.vbo=gl.createBuffer()}gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW)};PointcloudOctreeNode.useFading=true;PointcloudOctreeNode.loadingNodes=new Array;PointcloudOctreeNode.memoryThreshold=300*1e3*1e3;PointcloudOctreeNode.nodesLoadedThisFrame=0;PointcloudOctreeNode.lruNodes=null;PointcloudOctreeNode.prototype.shouldBeRendered=false;PointcloudOctreeNode.prototype.sizeInBytes=function(){return this.poc.pointAttributes.byteSize*this.points};PointcloudOctreeNode.prototype.fadeIn=function(){if(PointcloudOctreeNode.useFading){this.fade=1}else{this.opacity=1}};PointcloudOctreeNode.prototype.isFadingOut=function(){return this.fade<0};PointcloudOctreeNode.prototype.fadeOut=function(){if(PointcloudOctreeNode.useFading){this.fade=-1}else{this.opacity=0}};PointcloudOctreeNode.prototype.isVisible=function(){return true};PointcloudOctreeNode.prototype.setOpacity=function(e){this.fade=0;this.opacity=e};PointcloudOctreeNode.prototype.setPointCloud=function(e){this.pointCloud=e;this.age=0};PointcloudOctreeNode.prototype.addTime=function(t){};PointcloudOctreeNode.prototype.setAABB=function(e){this.aabb=e};PointcloudOctreeNode.prototype.addChild=function(e){var t=e.name.replace(this.name,"");if(t.length==1){if(this.children[t]==null){this.children[t]=e;e.parent=this}else{}}else if(t.length>1){var n=t[0];if(this.children[n]!=null){this.children[n].addChild(e)}else{this.children[n]=e;e.parent=this}}else{logError("something is wrong with the path: ");logError("this.name: "+this.name);logError("child.name: "+e.name);logError("path: "+t)}};PointcloudOctreeNode.prototype.unload=function(){if(this.pointCloud!=null){this.pointCloud.unload();this.pointCloud=null}else{Logger.error("tried to unload node but it is not loaded")}};PointcloudOctreeNode.loadCloudAjax=function(t){if(t.isLoading){console.log("node is already loading: "+t.name);return}t.isLoading=true;PointcloudOctreeNode.loadingNodes.push(t);t.poc.nodesBeeingLoaded.push(t);var n=t.poc.octreeDir+"/"+t.name;var r=new XMLHttpRequest;r.open("GET",n,true);r.responseType="arraybuffer";r.overrideMimeType("text/plain; charset=x-user-defined");r.onreadystatechange=function(){if(r.readyState==4){if(r.status==200||r.status==0){var e=r.response;PointcloudOctreeNode.loadCloudData(t,e,n)}else{console.log("Failed to load file! HTTP status: "+r.status+", file: "+n)}}};try{r.send(null)}catch(i){console.log("fehler beim laden der punktwolke: "+i)}};PointcloudOctreeNode.loadCloudData=function(e,t,n){PointcloudOctreeNode.nodesLoadedThisFrame++;var r=new PointCloud(n,e.poc.pointAttributes);r.setVertexBufferData(t);r.size=t.byteLength/e.poc.pointAttributes.byteSize;e.setPointCloud(r);PointcloudOctreeNode.lruNodes.touch(e);e.isLoading=false;PointcloudOctreeNode.loadingNodes.remove(e);e.poc.nodesBeeingLoaded.remove(e)};POCRenderQueue.prototype.add=function(e){this.nodes[e.id]=e;this.nodeList.push(e);this.byteSize+=e.sizeInBytes();this.points+=e.points;this.length++};POCRenderQueue.prototype.contains=function(e){return this.nodes[e.id]!=null};POCRenderQueue.prototype.get=function(e){return this.nodeList[e]};POCRenderQueue.prototype.cap=function(e){var t=0;var n=this.byteSize;while(n>e){var r=this.nodeList[this.nodeList.length-t-1];t++;n-=r.sizeInBytes()}if(t<0){this.nodeList.splice(-t,t)}this.length=this.nodeList.length};POCRenderQueue.prototype.capNodeCount=function(e){var t=Math.min(e,this.length);this.nodeList=this.nodeList.splice(0,t);this.length=this.nodeList.length};POCRenderQueue.prototype.clear=function(){this.byteSize=0;this.nodes=new Object;this.nodeList.length=0;this.length=0;this.points=0};PointcloudOctree.prototype.setMaterial=function(e){this.material=e};PointcloudOctree.prototype.setRootNode=function(e){this.rootNode=e};PointcloudOctree.prototype.setPointAttributes=function(e){this.pointAttributes=e};PointcloudOctree.visibilityToggle=0;PointcloudOctree.prototype.prepareRender=function(t,n){PointcloudOctree.visibilityToggle=PointcloudOctree.visibilityToggle+1;this.renderQueue.clear();var r=this.tmpStack;r.length=0;r.push(this.rootNode);var i=n.viewMatrix;var s=null;if(Potree.Settings.frustumCulling){s=n.frustum}while(r.length>0){var o=new Array;while(r.length>0){var u=r.pop();var a=true;var f=this.aabbVersion>u.aabb.version;f=f&&(Potree.Settings.frustumCulling||a&&Potree.Settings.LOD);if(f){u.aabb.setTransform(t.globalTransformation);u.aabb.version=this.aabbVersion}if(Potree.Settings.frustumCulling){if(s.isOutside(u.aabb)){a=false}}if(a&&Potree.Settings.LOD){var l=V3.transform(u.aabb.center,i);var c=l[0]*l[0]+l[1]*l[1]+l[2]*l[2];if(u.level>this.minDepth&&c>10*Potree.Settings.LODMultiplicator*u.aabb.radius*u.aabb.radius){u.fadeOut();a=false}}if(a&&u.pointCloud==null){if(!u.isLoading){this.loadQueue.push(u)}continue}if(u.isLoading){continue}if(!u.isVisible()){if(a){u.fadeIn()}continue}if(a){for(var h in u.children){o.push(u.children[h])}this.renderQueue.add(u);PointcloudOctreeNode.lruNodes.touch(u)}u.shouldBeRendered=a}r=o}this.processLoadQueue()};PointcloudOctree.cleanupCache=function(e,t){var n=PointcloudOctreeNode.lruNodes;for(var r=0;r<6;r++){if(n.byteSize+e>PointcloudOctreeNode.memoryThreshold){var i=n.getLRUItem();if(i!=null&&!t.contains(i)){i=n.removeLRUItem();i.unload()}}}};PointcloudOctree.prototype.render=function(e,t){this.prepareRender(e,t.camera);this.material.render(e,t)};PointcloudOctree.prototype.addTime=function(e){this.rootNode.addTime(e)};PointcloudOctree.prototype.processLoadQueue=function(){var e=PointcloudOctreeNode.lruNodes;var t=5;var n=0;if(this.loadQueue.length>0){for(var r=0;r<Math.min(t,this.loadQueue.length);r++){n+=this.loadQueue[r].sizeInBytes()}}PointcloudOctree.cleanupCache(n,this.renderQueue);if(this.loadQueue.length>0){for(var r=0;r<Math.min(t,this.loadQueue.length);r++){if(e.byteSize+this.loadQueue[r].sizeInBytes()<PointcloudOctreeNode.memoryThreshold){if(this.nodesBeeingLoaded.length<this.loadingNodesLimit){PointcloudOctreeNode.loadCloudAjax(this.loadQueue[r])}}}}this.loadQueue.length=0};Material.count=0;WeightedPointSizeMaterial.prototype=new Material(inheriting);WeightedPointSizeMaterial.prototype.render=function(e,t){var n=e.globalTransformation;var r=new Array;if(e instanceof PointCloudSceneNode){r.push(e.pointCloud)}else if(e instanceof PointcloudOctreeSceneNode){var i=e.mno.renderQueue;for(var s=0;s<i.length;s++){var o=i.get(s);r.push(o.pointCloud)}}if(t.fboColor!=null){this.renderPointClouds(n,r,t)}if(t.fboPosition!=null){this.renderPointCloudsPosition(n,r,t)}if(t.fboDepthAsRGBA!=null){this.renderPointCloudsDepthAsRGBA(n,r,t)}};WeightedPointSizeMaterial.prototype.renderPointCloudsDepthAsRGBA=function(t,n,r){var i=r.camera;var s=r.lights;r.fboDepthAsRGBA.bind();gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var o=this.rgbaDepthShader;var u=o.uniforms;var a=o.attributes;for(var f=0;f<n.length;f++){var l=n[f];var c=l.pointAttributes;gl.useProgram(o.program);{gl.uniformMatrix4fv(u.uWorld,false,t);gl.uniformMatrix4fv(u.uView,false,i.viewMatrix);gl.uniformMatrix4fv(u.uProj,false,i.projectionMatrix);gl.uniform1f(u.uPointSizeMultiplicator,this.pointSize);gl.uniform2f(u.uViewportSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight)}gl.bindBuffer(gl.ARRAY_BUFFER,l.vbo);var h=0;for(var p=0;p<c.size;p++){var d=c.attributes[p];if(d==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(a.aVertexPosition);gl.vertexAttribPointer(a.aVertexPosition,3,gl.FLOAT,false,c.byteSize,h)}h+=d.byteSize}gl.drawArrays(gl.POINTS,0,l.size);gl.disableVertexAttribArray(a.aNormal)}};WeightedPointSizeMaterial.prototype.renderPointCloudsPosition=function(t,n,r){var i=r.camera;var s=r.lights;r.fboPosition.bind();gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);for(var o=0;o<n.length;o++){var u=n[o];var a=u.pointAttributes;gl.useProgram(this.posShader.program);{gl.uniformMatrix4fv(this.posShader.uniforms.uWorld,false,t);gl.uniformMatrix4fv(this.posShader.uniforms.uView,false,i.viewMatrix);gl.uniformMatrix4fv(this.posShader.uniforms.uProj,false,i.projectionMatrix);gl.uniform1f(this.posShader.uniforms.uPointSizeMultiplicator,this.pointSize);gl.uniform2f(this.posShader.uniforms.uViewportSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight)}gl.bindBuffer(gl.ARRAY_BUFFER,u.vbo);var f=0;for(var l=0;l<a.size;l++){var c=a.attributes[l];if(c==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.posShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.posShader.attributes.aVertexPosition,3,gl.FLOAT,false,a.byteSize,f)}f+=c.byteSize}gl.drawArrays(gl.POINTS,0,u.size);gl.disableVertexAttribArray(this.posShader.attributes.aNormal)}};WeightedPointSizeMaterial.prototype.renderPointClouds=function(t,n,r){var i=r.camera;var s=r.lights;r.fboColor.bind();gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);for(var o=0;o<n.length;o++){var u=n[o];var a=u.pointAttributes;gl.useProgram(this.shader.program);{gl.uniformMatrix4fv(this.shader.uniforms.uWorld,false,t);gl.uniformMatrix4fv(this.shader.uniforms.uView,false,i.viewMatrix);gl.uniformMatrix4fv(this.shader.uniforms.uProj,false,i.projectionMatrix);gl.uniform1f(this.shader.uniforms.uPointSizeMultiplicator,this.pointSize);gl.uniform2f(this.shader.uniforms.uViewportSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight)}gl.bindBuffer(gl.ARRAY_BUFFER,u.vbo);var f=0;for(var l=0;l<a.size;l++){var c=a.attributes[l];if(c==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.shader.attributes.aVertexPosition);gl.vertexAttribPointer(this.shader.attributes.aVertexPosition,3,gl.FLOAT,false,a.byteSize,f)}else if(c==PointAttribute.RGBA_PACKED){if(this.shader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.shader.attributes.aVertexColour);gl.vertexAttribPointer(this.shader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,a.byteSize,f)}}else if(c==PointAttribute.RGB_PACKED){if(this.shader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.shader.attributes.aVertexColour);gl.vertexAttribPointer(this.shader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,a.byteSize,f)}}else if(c==PointAttribute.NORMAL_FLOATS){if(this.shader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.shader.attributes.aNormal);gl.vertexAttribPointer(this.shader.attributes.aNormal,3,gl.FLOAT,false,a.byteSize,f)}}f+=c.byteSize}gl.drawArrays(gl.POINTS,0,u.size);gl.disableVertexAttribArray(this.shader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.shader.attributes.aVertexColour);gl.disableVertexAttribArray(this.shader.attributes.aNormal)}};FixedPointSizeMaterial.prototype=new Material(inheriting);FixedPointSizeMaterial.prototype.render=function(e,t,n){var r=e.renderQueue.nodeList;for(var i=0;i<r.size();i++){var s=r[i];var o=s.pointCloud;var u=t.mno.pointAttributes;gl.useProgram(this.shader.program);{gl.uniformMatrix4fv(this.shader.uWorld,false,t.globalTransformation);gl.uniformMatrix4fv(this.shader.uView,false,n.viewMatrix);gl.uniformMatrix4fv(this.shader.uProjection,false,n.projectionMatrix);gl.uniform1f(this.shader.uPointSize,s.opacity*this.pointSize);gl.uniform2f(this.shader.uViewportSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight)}gl.bindBuffer(gl.ARRAY_BUFFER,o.vbo);var a=0;for(var f=0;f<u.numAttributes;f++){var l=u.attributes[f];if(l.name==PointAttributeNames.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.shader.aVertexPosition);gl.vertexAttribPointer(this.shader.aVertexPosition,3,gl.FLOAT,false,u.bytesPerPoint,a)}else if(l.name==PointAttributeNames.COLOR_PACKED){if(this.shader.aVertexColour!=null){gl.enableVertexAttribArray(this.shader.aVertexColour);gl.vertexAttribPointer(this.shader.aVertexColour,3,gl.UNSIGNED_BYTE,false,u.bytesPerPoint,a)}}else if(l.name==PointAttributeNames.NORMAL_FLOATS){if(this.shader.aNormal!=null){gl.enableVertexAttribArray(this.shader.aNormal);gl.vertexAttribPointer(this.shader.aNormal,3,gl.FLOAT,false,u.bytesPerPoint,a)}}a+=l.type.size*l.numElements}gl.drawArrays(gl.POINTS,0,s.points);Potree.drawnPoints+=s.points;Potree.drawCalls+=1;gl.disableVertexAttribArray(this.shader.aVertexPosition);gl.disableVertexAttribArray(this.shader.aVertexColour);gl.disableVertexAttribArray(this.shader.aNormal)}};var IlluminationMode={FLAT:{value:0,name:"Flat"},PHONG:{value:1,name:"Phong"},NORMALS:{value:2,name:"Normals"},POSITION:{value:3,name:"Position"}};var PointCloudRenderMode={FIXED_CIRCLE:{value:0,name:"fixed circle"},WEIGHTED_CIRCLE:{value:1,name:"weighted circle"},FILTERED_SPLAT:{value:3,name:"filtered splat"},GAUSS_FILL:{value:4,name:"gauss fill"}};PointCloudMaterial.prototype=new Material(inheriting);PointCloudMaterial.prototype.render=function(e,t){if(t.fboDepthAsRGBA!=null){this.weightedMaterial.render(e,t)}else{this.activeMaterial.render(e,t)}};Object.defineProperty(PointCloudMaterial.prototype,"renderMode",{set:function(e){this._renderMode=e;if(this.renderMode==PointCloudRenderMode.FIXED_CIRCLE){this.activeMaterial=this.fixedMaterial}else if(this.renderMode==PointCloudRenderMode.WEIGHTED_CIRCLE){this.activeMaterial=this.weightedMaterial}else if(this.renderMode==PointCloudRenderMode.FILTERED_SPLAT){this.activeMaterial=this.filteredMaterial}else if(this.renderMode==PointCloudRenderMode.GAUSS_FILL){this.activeMaterial=this.gaussFillMaterial}},get:function(){return this._renderMode}});Object.defineProperty(PointCloudMaterial.prototype,"pointSize",{set:function(e){this._pointSize=e;this.filteredMaterial.pointSize=e;this.weightedMaterial.pointSize=e;this.fixedMaterial.pointSize=e;this.gaussFillMaterial.pointSize=e},get:function(){return this._pointSize}});Object.defineProperty(PointCloudMaterial.prototype,"blendDepth",{set:function(e){this._blendDepth=e;this.filteredMaterial.blendDepth=e},get:function(){return this._blendDepth}});Object.defineProperty(PointCloudMaterial.prototype,"illuminationMode",{set:function(e){this._illuminationMode=e;this.filteredMaterial.illuminationMode=e;this.weightedMaterial.illuminationMode=e;this.fixedMaterial.illuminationMode=e},get:function(){return this._illuminationMode}});FlatMaterial.prototype=new Material(inheriting);FlatMaterial.prototype.setColor=function(e){this.color=e};FlatMaterial.prototype.render=function(e,t,n){if(e instanceof AABB){this.renderAABB(e,t,n)}else if(e instanceof SubMesh){this.renderSubMesh(e,t,n)}};FlatMaterial.prototype.renderSubMesh=function(e,t,n){var r=n.camera;var i=n.lights;var s=this.flatShader;var o=r.scene;var u=t.mesh;gl.useProgram(s.program);gl.uniformMatrix4fv(s.uniforms.uWorld,false,t.globalTransformation);gl.uniformMatrix4fv(s.uniforms.uView,false,r.viewMatrix);gl.uniformMatrix4fv(s.uniforms.uProj,false,r.projectionMatrix);var a=r.globalPosition;gl.uniform3f(s.uniforms.uViewPos,a[0],a[1],a[2]);gl.uniform4f(s.uniforms.uColor,this.color[0],this.color[1],this.color[2],this.color[3]);gl.enableVertexAttribArray(s.attributes.aVertexPosition);gl.bindBuffer(gl.ARRAY_BUFFER,e.vbos["POSITION"]);gl.vertexAttribPointer(s.attributes.aVertexPosition,3,gl.FLOAT,false,0,0);if(e.vbos["TEXCOORD_0"]!=null&&s.attributes.aTextureCoord!=null){gl.enableVertexAttribArray(s.attributes.aTextureCoord);gl.bindBuffer(gl.ARRAY_BUFFER,e.vbos["TEXCOORD_0"]);gl.vertexAttribPointer(s.attributes.aTextureCoord,2,gl.FLOAT,false,0,0)}if(e.ibo!=null){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.ibo);gl.drawElements(u.glType,e.indices.length,gl.UNSIGNED_SHORT,0)}else if(e.vertexCount!=null){gl.lineWidth(10);gl.drawArrays(u.glType,0,e.vertexCount)}};PhongMaterial.prototype=new Material(inheriting);PhongMaterial.prototype.setColor=function(e){this.color=e};PhongMaterial.prototype.render=function(e,t,n){if(e instanceof AABB){this.renderAABB(e,t,n)}else if(e instanceof SubMesh){this.renderSubMesh(e,t,n)}};PhongMaterial.prototype.renderSubMesh=function(e,t,n,r){var i=this.flatShader;var s=n.scene;var o=t.mesh;gl.useProgram(i.program);gl.uniformMatrix4fv(i.uniforms.uWorld,false,t.globalTransformation);gl.uniformMatrix4fv(i.uniforms.uView,false,n.viewMatrix);gl.uniformMatrix4fv(i.uniforms.uProj,false,n.projectionMatrix);var u=n.globalPosition;gl.uniform3f(i.uniforms.uViewPos,u[0],u[1],u[2]);gl.uniform4f(i.uniforms.uColor,this.color[0],this.color[1],this.color[2],this.color[3]);{gl.enableVertexAttribArray(i.attributes.aVertexPosition);gl.bindBuffer(gl.ARRAY_BUFFER,e.vbos["POSITION"]);gl.vertexAttribPointer(i.attributes.aVertexPosition,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(i.attributes.aVertexNormal);gl.bindBuffer(gl.ARRAY_BUFFER,e.vbos["NORMAL"]);gl.vertexAttribPointer(i.attributes.aVertexNormal,3,gl.FLOAT,false,0,0)}if(e.ibo!=null){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.ibo);gl.drawElements(o.glType,e.indices.length,gl.UNSIGNED_SHORT,0)}else if(e.vertexCount!=null){gl.lineWidth(10);gl.drawArrays(o.glType,0,e.vertexCount)}gl.disableVertexAttribArray(i.attributes.aVertexNormal);gl.disableVertexAttribArray(i.attributes.aVertexPosition)};FilteredSplatsMaterial.prototype=new Material(inheriting);FilteredSplatsMaterial.prototype.render=function(e,t){var n=e.globalTransformation;var r=new Array;if(e instanceof PointCloudSceneNode){r.push(e.pointCloud)}else if(e instanceof PointcloudOctreeSceneNode){var i=e.mno.renderQueue;for(var s=0;s<i.length;s++){var o=i.get(s);r.push(o.pointCloud)}}this.renderPointClouds(n,r,t)};FilteredSplatsMaterial.prototype.renderPointClouds=function(e,t,n){var r=Framebuffer.getActiveBuffer();this.depthPass(e,t,n);this.colorPass(e,t,n);if(this.illuminationMode==IlluminationMode.PHONG||this.illuminationMode==IlluminationMode.NORMALS){this.normalPass(e,t,n)}this.shadingPass(r,n)};FilteredSplatsMaterial.prototype.depthPass=function(e,t,n){var r=n.camera;var i=n.lights;this.depthFBO.bind();this.depthFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);{gl.useProgram(this.depthShader.program);gl.uniformMatrix4fv(this.depthShader.uniforms.uWorld,false,e);gl.uniformMatrix4fv(this.depthShader.uniforms.uView,false,r.viewMatrix);gl.uniformMatrix4fv(this.depthShader.uniforms.uProj,false,r.projectionMatrix);gl.uniform1f(this.depthShader.uniforms.uPointSize,this.pointSize);gl.uniform1f(this.depthShader.uniforms.uNear,r.nearClipPlane);gl.uniform1f(this.depthShader.uniforms.uFar,r.farClipPlane);gl.uniform1f(this.depthShader.uniforms.uBlendDepth,this.blendDepth);gl.uniform2f(this.depthShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);var s=2*r.nearClipPlane*Math.tan(r.fieldOfView*Math.PI/360);var o=s*r.aspectRatio;gl.uniform2f(this.depthShader.uniforms.uNearWindowSize,o,s)}for(var u=0;u<t.length;u++){var a=t[u];var f=a.pointAttributes;gl.bindBuffer(gl.ARRAY_BUFFER,a.vbo);var l=0;for(var c=0;c<f.size;c++){var h=f.attributes[c];if(h==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.depthShader.attributes.aVertexPosition,3,gl.FLOAT,false,f.byteSize,l)}else if(h==PointAttribute.RGBA_PACKED){if(this.depthShader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.vertexAttribPointer(this.depthShader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,f.byteSize,l)}}else if(h==PointAttribute.NORMAL_FLOATS){if(this.depthShader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.depthShader.attributes.aNormal);gl.vertexAttribPointer(this.depthShader.attributes.aNormal,3,gl.FLOAT,false,f.byteSize,l)}}l+=h.byteSize}gl.drawArrays(gl.POINTS,0,a.size);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.disableVertexAttribArray(this.depthShader.attributes.aNormal)}};FilteredSplatsMaterial.prototype.colorPass=function(e,t,n){var r=n.camera;this.colorFBO.bind();this.colorFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthFBO.renderbuffer);this.colorFBO.checkBuffer();gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(false);{gl.useProgram(this.colorShader.program);gl.uniformMatrix4fv(this.colorShader.uniforms.uWorld,false,e);gl.uniformMatrix4fv(this.colorShader.uniforms.uView,false,r.viewMatrix);gl.uniformMatrix4fv(this.colorShader.uniforms.uProj,false,r.projectionMatrix);gl.uniform1f(this.colorShader.uniforms.uPointSize,this.pointSize);gl.uniform1f(this.colorShader.uniforms.uNear,r.nearClipPlane);gl.uniform1f(this.colorShader.uniforms.uFar,r.farClipPlane);gl.uniform2f(this.depthShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);var i=2*r.nearClipPlane*Math.tan(r.fieldOfView*Math.PI/360);var s=i*r.aspectRatio;gl.uniform2f(this.depthShader.uniforms.uNearWindowSize,s,i)}for(var o=0;o<t.length;o++){var u=t[o];var a=u.pointAttributes;gl.bindBuffer(gl.ARRAY_BUFFER,u.vbo);var f=0;for(var l=0;l<a.size;l++){var c=a.attributes[l];if(c==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.colorShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.colorShader.attributes.aVertexPosition,3,gl.FLOAT,false,a.byteSize,f)}else if(c==PointAttribute.RGBA_PACKED){if(this.colorShader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.colorShader.attributes.aVertexColour);gl.vertexAttribPointer(this.colorShader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,a.byteSize,f)}}else if(c==PointAttribute.NORMAL_FLOATS){if(this.colorShader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.colorShader.attributes.aNormal);gl.vertexAttribPointer(this.colorShader.attributes.aNormal,3,gl.FLOAT,false,a.byteSize,f)}}f+=c.byteSize}gl.drawArrays(gl.POINTS,0,u.size);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.disableVertexAttribArray(this.depthShader.attributes.aNormal)}gl.depthFunc(gl.LESS);gl.depthMask(true)};FilteredSplatsMaterial.prototype.normalPass=function(e,t,n){var r=n.camera;this.normalFBO.bind();this.normalFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthFBO.renderbuffer);this.normalFBO.checkBuffer();gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(false);{gl.useProgram(this.normalShader.program);gl.uniformMatrix4fv(this.normalShader.uniforms.uWorld,false,e);gl.uniformMatrix4fv(this.normalShader.uniforms.uView,false,r.viewMatrix);gl.uniformMatrix4fv(this.normalShader.uniforms.uProj,false,r.projectionMatrix);gl.uniform1f(this.normalShader.uniforms.uPointSize,this.pointSize);gl.uniform1f(this.normalShader.uniforms.uNear,r.nearClipPlane);gl.uniform1f(this.normalShader.uniforms.uFar,r.farClipPlane);gl.uniform2f(this.depthShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);var i=2*r.nearClipPlane*Math.tan(r.fieldOfView*Math.PI/360);var s=i*r.aspectRatio;gl.uniform2f(this.depthShader.uniforms.uNearWindowSize,s,i)}for(var o=0;o<t.length;o++){var u=t[o];var a=u.pointAttributes;gl.bindBuffer(gl.ARRAY_BUFFER,u.vbo);var f=0;for(var l=0;l<a.size;l++){var c=a.attributes[l];if(c==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.normalShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.normalShader.attributes.aVertexPosition,3,gl.FLOAT,false,a.byteSize,f)}else if(c==PointAttribute.RGBA_PACKED){if(this.normalShader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.normalShader.attributes.aVertexColour);gl.vertexAttribPointer(this.normalShader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,a.byteSize,f)}}else if(c==PointAttribute.NORMAL_FLOATS){if(this.normalShader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.normalShader.attributes.aNormal);gl.vertexAttribPointer(this.normalShader.attributes.aNormal,3,gl.FLOAT,false,a.byteSize,f)}}f+=c.byteSize}gl.drawArrays(gl.POINTS,0,u.size);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.disableVertexAttribArray(this.depthShader.attributes.aNormal)}gl.depthFunc(gl.LESS);gl.depthMask(true)};var startTime=(new Date).getTime();FilteredSplatsMaterial.prototype.shadingPass=function(e,t){var n=t.camera;var r=t.lights;e.bind();gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.normalizationShader.program);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.normalFBO.texture.glid);gl.uniform1i(this.normalizationShader.uniforms.uNormal,0);gl.activeTexture(gl.TEXTURE0+1);gl.bindTexture(gl.TEXTURE_2D,this.colorFBO.texture.glid);gl.uniform1i(this.normalizationShader.uniforms.uColor,1);gl.activeTexture(gl.TEXTURE0+2);gl.bindTexture(gl.TEXTURE_2D,this.depthFBO.texture.glid);gl.uniform1i(this.normalizationShader.uniforms.uPosition,2);gl.uniform1i(this.normalizationShader.uniforms.uIlluminationMode,this.illuminationMode.value);if(this.illuminationMode==IlluminationMode.PHONG){for(var i=0;i<r.length;i++){var s=r[i];var o=s.globalPosition;gl.uniform3f(this.normalizationShader.uniforms.uLightPos,o.x,o.y,o.z);gl.uniform3f(this.normalizationShader.uniforms.uLightColor,s.red,s.green,s.blue);e.drawFullscreenQuad(this.normalizationShader)}}else{e.drawFullscreenQuad(this.normalizationShader)}};GaussFillMaterial.prototype=new Material(inheriting);GaussFillMaterial.prototype.render=function(e,t){var n=e.globalTransformation;var r=new Array;if(e instanceof PointCloudSceneNode){r.push(e.pointCloud)}else if(e instanceof PointcloudOctreeSceneNode){var i=e.mno.renderQueue;for(var s=0;s<i.length;s++){var o=i.get(s);r.push(o.pointCloud)}}this.renderPointClouds(n,r,t)};GaussFillMaterial.prototype.renderPointClouds=function(e,t,n){var r=Framebuffer.getActiveBuffer();var i=n.camera;var s=n.lights;this.depthPass(e,t,i);this.pointsPass(e,t,i);this.spreadXPass(e,t,i);this.spreadYPass(e,t,i);this.normalizationPass(r,i,s)};GaussFillMaterial.prototype.depthPass=function(e,t,n){this.depthFBO.bind();this.depthFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);{gl.useProgram(this.depthShader.program);gl.uniformMatrix4fv(this.depthShader.uniforms.uWorld,false,e);gl.uniformMatrix4fv(this.depthShader.uniforms.uView,false,n.viewMatrix);gl.uniformMatrix4fv(this.depthShader.uniforms.uProj,false,n.projectionMatrix);gl.uniform1f(this.depthShader.uniforms.uPointSize,this.pointSize);gl.uniform1f(this.depthShader.uniforms.uNear,n.nearClipPlane);gl.uniform1f(this.depthShader.uniforms.uFar,n.farClipPlane);gl.uniform1f(this.depthShader.uniforms.uBlendDepth,this.blendDepth);gl.uniform2f(this.depthShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);var r=2*n.nearClipPlane*Math.tan(n.fieldOfView*Math.PI/360);var i=r*n.aspectRatio;gl.uniform2f(this.depthShader.uniforms.uNearWindowSize,i,r)}for(var s=0;s<t.length;s++){var o=t[s];var u=o.pointAttributes;gl.bindBuffer(gl.ARRAY_BUFFER,o.vbo);var a=0;for(var f=0;f<u.size;f++){var l=u.attributes[f];if(l==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.depthShader.attributes.aVertexPosition,3,gl.FLOAT,false,u.byteSize,a)}else if(l==PointAttribute.RGBA_PACKED){if(this.depthShader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.vertexAttribPointer(this.depthShader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,u.byteSize,a)}}else if(l==PointAttribute.NORMAL_FLOATS){if(this.depthShader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.depthShader.attributes.aNormal);gl.vertexAttribPointer(this.depthShader.attributes.aNormal,3,gl.FLOAT,false,u.byteSize,a)}}a+=l.byteSize}gl.drawArrays(gl.POINTS,0,o.size);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.disableVertexAttribArray(this.depthShader.attributes.aNormal)}};GaussFillMaterial.prototype.pointsPass=function(e,t,n){this.colorFBO.bind();this.colorFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthFBO.renderbuffer);this.colorFBO.checkBuffer();gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);gl.depthMask(false);{gl.useProgram(this.colorShader.program);gl.uniformMatrix4fv(this.colorShader.uniforms.uWorld,false,e);gl.uniformMatrix4fv(this.colorShader.uniforms.uView,false,n.viewMatrix);gl.uniformMatrix4fv(this.colorShader.uniforms.uProj,false,n.projectionMatrix);gl.uniform1f(this.colorShader.uniforms.uNear,n.nearClipPlane);gl.uniform1f(this.colorShader.uniforms.uFar,n.farClipPlane);gl.uniform1f(this.colorShader.uniforms.uPointSize,this.pointSize)}for(var r=0;r<t.length;r++){var i=t[r];var s=i.pointAttributes;gl.bindBuffer(gl.ARRAY_BUFFER,i.vbo);var o=0;for(var u=0;u<s.size;u++){var a=s.attributes[u];if(a==PointAttribute.POSITION_CARTESIAN){gl.enableVertexAttribArray(this.colorShader.attributes.aVertexPosition);gl.vertexAttribPointer(this.colorShader.attributes.aVertexPosition,3,gl.FLOAT,false,s.byteSize,o)}else if(a==PointAttribute.RGBA_PACKED){if(this.colorShader.attributes.aVertexColour!=null){gl.enableVertexAttribArray(this.colorShader.attributes.aVertexColour);gl.vertexAttribPointer(this.colorShader.attributes.aVertexColour,3,gl.UNSIGNED_BYTE,false,s.byteSize,o)}}else if(a==PointAttribute.NORMAL_FLOATS){if(this.colorShader.attributes.aNormal!=null){gl.enableVertexAttribArray(this.colorShader.attributes.aNormal);gl.vertexAttribPointer(this.colorShader.attributes.aNormal,3,gl.FLOAT,false,s.byteSize,o)}}o+=a.byteSize}gl.drawArrays(gl.POINTS,0,i.size);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexPosition);gl.disableVertexAttribArray(this.depthShader.attributes.aVertexColour);gl.disableVertexAttribArray(this.depthShader.attributes.aNormal)}gl.depthFunc(gl.LESS);gl.depthMask(true)};GaussFillMaterial.prototype.spreadXPass=function(e,t,n){this.spreadXFBO.bind();this.spreadXFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.disable(gl.BLEND);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.spreadXShader.program);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.activeTexture(gl.TEXTURE0+1);gl.bindTexture(gl.TEXTURE_2D,this.colorFBO.texture.glid);gl.uniform1i(this.spreadXShader.uniforms.uColor,1);gl.uniform2f(this.spreadXShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.uniform1fv(this.spreadXShader.uniforms["uKernel[0]"],this.gaussKernel);this.spreadXFBO.drawFullscreenQuad(this.spreadXShader)};GaussFillMaterial.prototype.spreadYPass=function(e,t,n){this.spreadYFBO.bind();this.spreadYFBO.setSize(Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.disable(gl.BLEND);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.spreadYShader.program);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.activeTexture(gl.TEXTURE0+1);gl.bindTexture(gl.TEXTURE_2D,this.spreadXFBO.texture.glid);gl.uniform1i(this.spreadYShader.uniforms.uColor,1);gl.uniform2f(this.spreadYShader.uniforms.uWindowSize,Potree.canvas.clientWidth,Potree.canvas.clientHeight);gl.uniform1fv(this.spreadYShader.uniforms["uKernel[0]"],this.gaussKernel);this.spreadYFBO.drawFullscreenQuad(this.spreadYShader)};var startTime=(new Date).getTime();GaussFillMaterial.prototype.normalizationPass=function(e,t,n){e.bind();gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.normalizationShader.program);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.activeTexture(gl.TEXTURE0+1);gl.bindTexture(gl.TEXTURE_2D,this.spreadYFBO.texture.glid);gl.uniform1i(this.normalizationShader.uniforms.uColor,1);e.drawFullscreenQuad(this.normalizationShader)};POCLoader.load=function(t){try{var n=new PointcloudOctree;var r=new XMLHttpRequest;r.open("GET",t,false);r.send(null);if(r.status==200||r.status==0){var i=JSON.parse(r.responseText);n.octreeDir=t+"/../data";var s=POCLoader.loadPointAttributes(i);n.setPointAttributes(s);{var o=new PointcloudOctreeNode("r",n);var u=new AABB;u.setDimensionByMinMax([i.boundingBox.lx,i.boundingBox.ly,i.boundingBox.lz],[i.boundingBox.ux,i.boundingBox.uy,i.boundingBox.uz]);o.setAABB(u);o.points=i.hierarchy[0][1];n.rootNode=o}for(var a=1;a<i.hierarchy.length;a++){var f=i.hierarchy[a][0];var l=i.hierarchy[a][1];var c=new PointcloudOctreeNode(f,n);c.points=l;n.rootNode.addChild(c);var h=c.name.charAt(c.name.length-1);var p=POCLoader.createChildAABB(c.parent.aabb,h);c.setAABB(p)}}var d=new PointcloudOctreeSceneNode(n);return d}catch(v){console.log("loading failed: '"+t+"'");console.log(v)}};POCLoader.loadPointAttributes=function(e){var t=e.pointAttributes;var n=new PointAttributes;for(var r=0;r<t.length;r++){var i=PointAttribute[t[r]];n.add(i)}return n};POCLoader.createChildAABB=function(e,t){var n=e.objectSpaceMin;var r=e.objectSpaceMax;var i=new AABB;var s=V3.scale(V3.sub(r,n),.5);var o=[s[0],0,0];var u=[0,s[1],0];var a=[0,0,s[2]];{var f=n;var l=V3.add(n,s);var i=new AABB;i.setDimensionByMinMax(f,l)}if(t==1){var n=V3.add(i.min,a);var r=V3.add(i.max,a);i.setDimensionByMinMax(n,r);i.setColor([0,0,1,1])}else if(t==3){var n=V3.add(V3.add(i.min,a),u);var r=V3.add(V3.add(i.max,a),u);i.setDimensionByMinMax(n,r);i.setColor([1,1,0,1])}else if(t==0){i.setColor([1,0,0,1])}else if(t==2){var n=V3.add(i.min,u);var r=V3.add(i.max,u);i.setDimensionByMinMax(n,r);i.setColor([0,1,0,1])}else if(t==5){var n=V3.add(V3.add(i.min,a),o);var r=V3.add(V3.add(i.max,a),o);i.setDimensionByMinMax(n,r);i.setColor([1,1,1,1])}else if(t==7){var n=V3.add(i.min,s);var r=V3.add(i.max,s);i.setDimensionByMinMax(n,r);i.setColor([0,0,0,1])}else if(t==4){var n=V3.add(i.min,o);var r=V3.add(i.max,o);i.setDimensionByMinMax(n,r);i.setColor([1,0,1,1])}else if(t==6){var n=V3.add(V3.add(i.min,o),u);var r=V3.add(V3.add(i.max,o),u);i.setDimensionByMinMax(n,r);i.setColor([0,1,1,1])}return i};var PointAttributeNames={POSITION_CARTESIAN:0,COLOR_PACKED:1,COLOR_FLOATS_1:2,COLOR_FLOATS_255:3,NORMAL_FLOATS:4,FILLER:5};var i=0;for(obj in PointAttributeNames){PointAttributeNames[i]=PointAttributeNames[obj];i++}var PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}};var i=0;for(obj in PointAttributeTypes){PointAttributeTypes[i]=PointAttributeTypes[obj];i++}PointAttribute.POSITION_CARTESIAN=new PointAttribute(PointAttributeNames.POSITION_CARTESIAN,PointAttributeTypes.DATA_TYPE_FLOAT,3);PointAttribute.RGBA_PACKED=new PointAttribute(PointAttributeNames.COLOR_PACKED,PointAttributeTypes.DATA_TYPE_INT8,4);PointAttribute.COLOR_PACKED=PointAttribute.RGBA_PACKED;PointAttribute.RGB_PACKED=new PointAttribute(PointAttributeNames.COLOR_PACKED,PointAttributeTypes.DATA_TYPE_INT8,3);PointAttribute.NORMAL_FLOATS=new PointAttribute(PointAttributeNames.NORMAL_FLOATS,PointAttributeTypes.DATA_TYPE_FLOAT,3);PointAttribute.FILLER_1B=new PointAttribute(PointAttributeNames.FILLER,PointAttributeTypes.DATA_TYPE_UINT8,1);PointAttributes.prototype.add=function(e){this.attributes.push(e);this.byteSize+=e.byteSize;this.size++};PointAttributes.prototype.hasColors=function(){for(var e in this.attributes){var t=this.attributes[e];if(t.name==PointAttributeNames.COLOR_PACKED){return true}}return false};PointAttributes.prototype.hasNormals=function(){for(var e in this.attributes){var t=this.attributes[e];if(t==PointAttribute.NORMAL_FLOATS){return true}}return false};ProceduralPointcloudGenerator.generate=function(e,t,n,r,i,s,o){var u=(t-e)/n*((i-r)/s);var a=new ArrayBuffer(u*16);var f=new Float32Array(a);var l=new Uint8Array(a);var c=new PointAttributes;c.add(PointAttribute.POSITION_CARTESIAN);c.add(PointAttribute.RGBA_PACKED);var h=0;for(var p=e;p<=t;p+=n){for(var d=r;d<=i;d+=s){var v=o(p,d);var m=v[0];var g=v[1];var y=v[2];var b=v[3];var w=255;var E=h/4;f[E+0]=p+.01;f[E+1]=m+.01;f[E+2]=d+.01;l[h+12]=g;l[h+13]=y;l[h+14]=b;l[h+15]=w;h+=16}}var S=new PointCloud("test",c);S.setVertexBufferData(a);S.size=u;return S};PlyFileType.ASCII="ascii";PlyFileType.BINARY_LITTLE_ENDIAN="binary_little_endian";PlyFileType.BINARY_BIG_ENDIAN="binary_big_endian";PlyPropertyDataType.char=new PlyPropertyDataType("char",1);PlyPropertyDataType.uchar=new PlyPropertyDataType("uchar",1);PlyPropertyDataType.short=new PlyPropertyDataType("short",2);PlyPropertyDataType.ushort=new PlyPropertyDataType("ushort",2);PlyPropertyDataType.int=new PlyPropertyDataType("int",4);PlyPropertyDataType.uint=new PlyPropertyDataType("uint",4);PlyPropertyDataType.float=new PlyPropertyDataType("float",4);PlyPropertyDataType.double=new PlyPropertyDataType("double",8);PlyLoaderListener.prototype.finishedLoading=function(e){};PlyLoaderListener.prototype.pointsLoaded=function(e,t){};PlyLoaderListener.prototype.onProgress=function(e){};PlyLoader.load=function(e,t){var n=new PlyFile;var r=new Worker("src/loader/PlyLoaderWorker.js");r.onmessage=function(e){if(e.data.type=="header"){n.header=PlyLoader.parseHeader(e.data.header)}else if(e.data.type=="progress"){t.pointsLoaded(e.data.pointsLoaded,n.header.elements[0].size)}else if(e.data.type=="result"){var r=e.data.buffer;var i=e.data.aabb;var s=n.header.elements[0];var o=PlyLoader.pointAttributesFromProperties(s.properties,true);var u=r.byteLength/o.byteSize;var a=new PointCloud("test",o);a.setVertexBufferData(r);a.size=u;a.aabb=new AABB;var f=V3.$(i.lx,i.ly,i.lz);var l=V3.$(i.ux,i.uy,i.uz);a.aabb.setDimensionByMinMax(f,l);t.finishedLoading(a)}else if(e.data.type=="log"){console.log(e.data.message)}else if(e.data.type=="fileLoadProgress"){t.fileLoadProgress(e.data.percentage)}else{alert(e.data)}};r.postMessage(e)};PlyLoader.parseHeader=function(t){var n=t.split("\n");var r=new PlyHeader;r.byteSize=t.length;var i=new PlyElement("vertex");r.elements.push(i);var s=/^format (ascii|binary_little_endian).*/;var o=/element (\w*) (\d*)/;var u=/property (char|uchar|short|ushort|int|uint|float|double) (\w*)/;while(n.length>0){var a=n.shift();if(a=="ply"){}else if(a.search(s)>=0){var f=a.match(s);r.type=PlyFileType[f[1].toUpperCase()]}else if(a.search(o)>=0){var f=a.match(o);var l=f[1];var c=parseInt(f[2]);if(l!="vertex"){throw"As of now, only ply files with 'vertex' as the first element are supported."}i.size=c;while(n[0].search(u)>=0){var f=n.shift().match(u);var l=f[2];var h=PlyPropertyDataType[f[1]];var p=new PlyProperty(l,h);i.properties.push(p)}break}}return r};PlyLoader.pointAttributesFromProperties=function(t,n){if(n===undefined){n=false}var r=new PointAttributes;var i=0;while(i<t.length){var s=t[i];if(s.name=="x"){var o=s;var u=t[i+1];var a=t[i+2];if(u.name!="y"||a.name!="z"){throw"unsupported ply format"}if(o.type.name+u.type.name+a.type.name!="floatfloatfloat"){throw"unsupported ply format"}r.add(PointAttribute.POSITION_CARTESIAN);i+=3}else if(s.name=="nx"){var o=s;var u=t[i+1];var a=t[i+2];if(u.name!="ny"||a.name!="nz"){throw"unsupported ply format"}if(o.type.name+u.type.name+a.type.name!="floatfloatfloat"){throw"unsupported ply format"}r.add(PointAttribute.NORMAL_FLOATS);i+=3}else if(s.name=="red"){if(t[i+3]!=null&&t[i+3].name=="alpha"){var f=s;var l=t[i+1];var c=t[i+2];var h=t[i+3];if(l.name!="green"||c.name!="blue"||h.name!="alpha"){throw"unsupported ply format"}if(f.type.name+l.type.name+c.type.name+h.type.name!="ucharucharucharuchar"){throw"unsupported ply format"}r.add(PointAttribute.RGBA_PACKED);i+=4}else{var f=s;var l=t[i+1];var c=t[i+2];if(l.name!="green"||c.name!="blue"){throw"unsupported ply format"}if(f.type.name+l.type.name+c.type.name!="ucharucharuchar"){throw"unsupported ply format"}if(n){r.add(PointAttribute.RGBA_PACKED)}else{r.add(PointAttribute.RGB_PACKED)}i+=3}}else{if(!n){var p=new PointAttribute(PointAttributeNames.FILLER,PointAttributeTypes.DATA_TYPE_INT8,s.size);r.add(p)}i++}}return r};LRU.prototype.size=function(){return this.elements};LRU.prototype.contains=function(e){return this.items[e.id]==null};LRU.prototype.touch=function(e){if(this.items[e.id]==null){var t=new LRUItem(e);t.previous=this.last;this.last=t;if(t.previous!=null){t.previous.next=t}this.items[e.id]=t;this.elements++;if(this.first==null){this.first=t}this.byteSize+=e.sizeInBytes()}else{var t=this.items[e.id];if(t.previous==null){if(t.next!=null){this.first=t.next;this.first.previous=null;t.previous=this.last;t.next=null;this.last=t;t.previous.next=t}}else if(t.next==null){}else{t.previous.next=t.next;t.next.previous=t.previous;t.previous=this.last;t.next=null;this.last=t;t.previous.next=t}}};LRU.prototype.removeLRUItem=function(){if(this.first==null){return null}var t=this.first;if(t.next!=null){this.first=t.next;this.first.previous=null}else{this.first=null;this.last=null}delete this.items[t.node.id];this.elements--;this.byteSize-=t.node.sizeInBytes();return t.node};LRU.prototype.getLRUItem=function(){if(this.first==null){return null}var e=this.first;return e.node};LRU.prototype.toString=function(){var e="{ ";var t=this.first;while(t!=null){e+=t.node.id;if(t.next!=null){e+=", "}t=t.next}e+="}";e+="("+this.size()+")";return e};var gl=null;Potree.shaderDir="resources/shader";Potree.includes=["libs/mjs/mjs.js","libs/WebglDebug/webgl-debug.js","libs/other/other.js","src/extensions/Array.js","src/extensions/mjs.js","src/extensions/String.js","src/extensions/ArrayBuffer.js","src/extensions/Float32Array.js","src/utils/utils.js","src/KeyListener.js","src/KeyCodes.js","src/MouseListener.js","src/Mouse.js","src/ResourceManager/TextureManager.js","src/ResourceManager/MaterialManager.js","src/shader/Shader.js","src/utils/Plane.js","src/utils/Frustum.js","src/rendering/Renderer.js","src/scenegraph/AABB.js","src/scenegraph/SceneNode.js","src/scenegraph/Camera.js","src/scenegraph/Scene.js","src/scenegraph/MeshNode.js","src/scenegraph/Light.js","src/scenegraph/Sphere.js","src/objects/Mesh.js","src/Viewport.js","src/navigation/CamHandler.js","src/navigation/FreeFlightCamHandler.js","src/navigation/OrbitCamHandler.js","src/Framebuffer.js","src/FramebufferFloat32.js","src/ResourceManager/ShaderManager.js","src/utils/MeshUtils.js","src/scenegraph/PointcloudOctreeSceneNode.js","src/scenegraph/PointCloudSceneNode.js","src/objects/PointCloud.js","src/objects/PointcloudOctreeNode.js","src/objects/PointcloudOctree.js","src/materials/Material.js","src/materials/WeightedPointSizeMaterial.js","src/materials/FixedPointSizeMaterial.js","src/materials/PointCloudMaterial.js","src/materials/FlatMaterial.js","src/materials/PhongMaterial.js","src/materials/FilteredSplatsMaterial.js","src/materials/GaussFillMaterial.js","src/loader/POCLoader.js","src/loader/PointAttributes.js","src/loader/ProceduralPointcloudGenerator.js","src/loader/PlyLoader.js","src/utils/LRU.js"];Potree.Settings=new Object;Potree.Settings.showBoundingBoxes=false;Potree.Settings.LOD=true;Potree.Settings.LODMultiplicator=10;Potree.Settings.pointSize=1;Potree.Settings.backgroundColor=[0,0,0,1];Potree.Settings.showGrid=false;Potree.Settings.frustumCulling=true;Potree.Settings.useDebugContext=false;Potree.gridSceneNode=null;Potree.canvas=null;Potree.initialized=false;Potree.updateHandlers=new Array;Potree.drawHandlers=new Array;var renderer=null;Potree.fpsHistory=new Array;Potree.fps=0;Potree.importScripts=function(e){var t="";for(var n=0;n<Potree.includes.length;n++){var r=Potree.includes[n];t+="<scri"+'pt type="text/javascript" src="'+e+"/"+r+'"></scri'+"pt>\n"}document.write(t)};Potree.isWebGLEnabled=function(e){var t=["webgl","experimental-webgl","moz-webgl","webkit-3d"];for(var n=0;t.length>n;n++){try{gl=e.getContext(t[n],{antialias:false});if(gl){break}}catch(r){}}if(!gl){console.log("No known OpenGL context detected! Is it enabled?");return false}return true};Potree.init=function(e){if(Potree.initialized){console.log("Potree has already been initialized");return true}Potree.canvas=e;Potree.currentScene=new Scene("default");if(!Potree.initGL()){var t=document.createElement("div");var n="<br>Could not create a WebGL context. ";n+="<br><br>Try using <a href='http://www.mozilla.org' style='color: red'>Firefox</a> ";n+="or <a href='www.google.com/chrome/' style='color: red'>Chrome</a>.";n+="<br>Other WebGL enabled browsers are not supported but they might work as well.";t.innerHTML=n;t.style.fontSize="large";t.style.fontWeight="bold";t.style.color="#FFF";t.style.textShadow="black 0 0 4px, black 0 0 4px, black 0 0 4px, black 0 0 4px, black 0 0 4px, black 0 0 4px";t.style.textAlign="center";t.style.verticalAlign="bottom";t.style.height="100%";e.parentNode.replaceChild(t,e);return false}{var r=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";if(document.attachEvent){document.attachEvent("on"+r,MouseListener.mouseWheel)}else if(document.addEventListener){document.addEventListener(r,MouseListener.mouseWheel,false)}document.onkeydown=KeyListener.keyDown;document.onkeyup=KeyListener.keyUp;document.onkeypress=KeyListener.keyPress;document.onmousedown=MouseListener.mouseDown;document.onmouseup=MouseListener.mouseUp;document.onmousemove=MouseListener.mouseMove}{Potree.camHandler=new FreeFlightCamHandler(Potree.currentScene.activeCamera)}Potree.initialized=true;var i=new Shader("drawTexture","drawTexture.vs","drawTexture.fs");var s=new PointCloudMaterial("pointCloud");var o=new FlatMaterial("default");setInterval(Potree.mainLoop,33);return Potree.initialized};Object.defineProperty(Potree,"camHandler",{get:function(){return Potree._camHandler},set:function(e){KeyListener.removeListener(Potree._camHandler);MouseListener.removeListener(Potree._camHandler);Potree._camHandler=e;KeyListener.addListener(Potree._camHandler);MouseListener.addListener(Potree._camHandler)}});Potree.initGL=function(){viewportWidth=Potree.canvas.width;viewportHeight=Potree.canvas.height;var e=["webgl","experimental-webgl","moz-webgl","webkit-3d"];for(var t=0;e.length>t;t++){try{gl=Potree.canvas.getContext(e[t],{antialias:false});if(gl){break}}catch(n){}}if(!gl){console.log("No known OpenGL context detected! Is it enabled?");return false}if(Potree.Settings.useDebugContext){console.log("using WebGLDebugUtils - debugcontext. Performance may suffer.");gl=WebGLDebugUtils.makeDebugContext(gl)}if(!gl.getExtension("OES_texture_float")){console.log("some functions require OES_texture_float extension");return false}var r=Potree.Settings.backgroundColor;gl.clearColor(r.r,r.g,r.b,r.a);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);return true};Potree.draw=function(){if(renderer==null){renderer=new Renderer(Potree.currentScene,Framebuffer.getSystemBuffer())}Potree.canvas.width=Potree.canvas.clientWidth;Potree.canvas.height=Potree.canvas.clientHeight;var e=renderer.scene.activeCamera;e.aspectRatio=Potree.canvas.clientWidth/Potree.canvas.clientHeight;renderer.viewport(0,0,Potree.canvas.clientWidth,Potree.canvas.clientHeight);renderer.render();for(var t=0;t<Potree.drawHandlers.length;t++){var n=Potree.drawHandlers[t];n()}};Potree.mainLoop=function(){Potree.calculateTimeSinceLastFrame();Potree.update(timeSinceLastFrame);Potree.draw()};var lastLoopTime=null;var timeSinceLastFrame=null;Potree.calculateTimeSinceLastFrame=function(){var t=(new Date).getTime();if(lastLoopTime!=null){timeSinceLastFrame=(t-lastLoopTime)/1e3}else{timeSinceLastFrame=0}lastLoopTime=(new Date).getTime()};Potree.update=function(t){var n=1/t;Potree.fpsHistory.push(n);if(Potree.fpsHistory.length>10){Potree.fpsHistory.splice(0,1)}var r=0;for(var i=0;i<Potree.fpsHistory.length;i++){r+=Potree.fpsHistory[i]}r=r/Potree.fpsHistory.length;Potree.fps=r.toFixed(2);Potree.currentScene.rootNode.addTime(t);PointcloudOctreeNode.nodesLoadedThisFrame=0;Potree.camHandler.addTime(t);for(var i=0;i<Potree.updateHandlers.length;i++){var s=Potree.updateHandlers[i];s(t)}}