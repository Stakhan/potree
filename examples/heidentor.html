<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/three.js/build/three.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
		<input id="tiffTest" type="button" value="tiff test" />
	</div>

	
	
	<script>
	
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
		
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1*1000*1000);
		viewer.setMinNodeSize(0);
		viewer.loadSettingsFromURL();
		
		viewer.setDescription("");
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
		});
		
		// Sigeom
		Potree.loadPointCloud("http://5.9.65.151/mschuetz/potree/resources/pointclouds/archpro/heidentor/cloud.js", "Heidentor", function(e){
			viewer.scene.addPointCloud(e.pointcloud);
			e.pointcloud.position.z = 0;
			let material = e.pointcloud.material;
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

			//viewer.setCameraMode(Potree.CameraMode.ORTHOGRAPHIC);

			viewer.scene.view.position.set(13.856734292740617, -9.125174923658731, 14.563928417406354);
			viewer.scene.view.lookAt(-3.5482630104475366, 2.728596783815762, 6.1406044783018725);

			//viewer.clippingTool.setClipMode(Potree.ClipMode.INSIDE);
			//viewer.fitToScreen();

			//viewer.useHQ = true;

			//Potree.measureTimings = true;
		});
		
	</script>
	
	<script>

		let button = $("#tiffTest");
		button.css("left", "400px");
		button.css("top", "100px");
		button.css("z-index", "1000");
		button.css("position", "absolute");

		button.click( () => {

			let image = new GeoTIFF.Image();
			{
				let {width, height, buffer} = viewer.edlRenderer.makeScreenshot();

				image.width = width;
				image.height = height;
				image.buffer = buffer;
			}

			{
				let ifdEntries = [
					new GeoTIFF.IFDEntry(
						GeoTIFF.Tag.MODEL_PIXEL_SCALE, 
						GeoTIFF.Type.DOUBLE, 3, null, 
						new Float64Array([60.02213698319374, 60.02213698319374, 0])),
					new GeoTIFF.IFDEntry(
						GeoTIFF.Tag.MODEL_TIEPOINT, 
						GeoTIFF.Type.DOUBLE, 6, null, 
						new Float64Array([ 0, 0, 0, -28493.166784412522, 4255884.5438021915, 0 ])),
					new GeoTIFF.IFDEntry(
						GeoTIFF.Tag.GEO_KEY_DIRECTORY, 
						GeoTIFF.Type.SHORT, 60, null, 
						new Uint16Array([1, 1, 0, 14, 1024, 0, 1, 1, 1025, 0, 1, 1, 1026, 34737, 8, 0, 2048, 0, 1, 4267, 2049, 34737, 6, 8, 2054, 0, 1, 9102, 3072, 0, 1, 32767, 3074, 0, 1, 32767, 3075, 0, 1, 28, 3076, 0, 1, 9001, 3078, 34736, 1, 1, 3080, 34736, 1, 0, 3082, 34736, 1, 2, 3083, 34736, 1, 3])),
					new GeoTIFF.IFDEntry(
						GeoTIFF.Tag.GEO_DOUBLE_PARAMS, 
						GeoTIFF.Type.DOUBLE, 4, null, 
						new Float64Array([ -117.333333333333, 33.75, 0, 0 ])),
					new GeoTIFF.IFDEntry(
						GeoTIFF.Tag.GEO_ASCII_PARAMS, 
						GeoTIFF.Type.ASCII, 15, null, 
						'unnamed|NAD27|\u0000'),
				];
				
				let {buffer} = GeoTIFF.Exporter.toTiffBuffer(image, {ifdEntries: ifdEntries});
				let blob = new Blob([buffer], {type: "application/octet-binary"});

				let content = $(`<a href="#" download="test.tif">download</a>`);

				content[0].href = URL.createObjectURL(blob);

				viewer.postMessage(content);
			}
		});

		
	</script>
	
  </body>
</html>
