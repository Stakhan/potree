

<html>
<head>
	<title>My first Three.js app</title>
	<style>canvas { width: 100%; height: 100% }</style>
</head>
<body style="margin: 0; padding: 0">
	<script src="libs/three.js/build/three.js"></script>
	<script src="libs/other/OrbitControls.js"></script>
	<script src="src/Potree.js"></script>
	<script src="src/PointCloudOctree.js"></script>
	<script src="src/loader/POCLoader.js"></script>
	<script src="src/loader/PointAttributes.js"></script>
	<script src="src/utils.js"></script>
	<script src="src/CustomBoxHelper.js"></script>
	<script>
		var renderer;
		var camera;
		var cube;
		var scene;
		var octreeNodesVisible = 0;
		var pointsVisible = 0;
		var pointCloud;
		var raycaster = new THREE.Raycaster();
		var projector = new THREE.Projector();
		var pointClouds = [];
		
		function loadSkybox(){
			// load skybox
			var cubeMap = new THREE.Texture( [] );
			cubeMap.format = THREE.RGBFormat;
			cubeMap.flipY = false;

			var loader = new THREE.ImageLoader();
			loader.load( 'resources/textures/skyboxsun25degtest.png', function ( image ) {

				var getSide = function ( x, y ) {

					var size = 1024;

					var canvas = document.createElement( 'canvas' );
					canvas.width = size;
					canvas.height = size;

					var context = canvas.getContext( '2d' );
					context.drawImage( image, - x * size, - y * size );

					return canvas;

				};

				cubeMap.image[ 0 ] = getSide( 2, 1 ); // px
				cubeMap.image[ 1 ] = getSide( 0, 1 ); // nx
				cubeMap.image[ 2 ] = getSide( 1, 0 ); // py
				cubeMap.image[ 3 ] = getSide( 1, 2 ); // ny
				cubeMap.image[ 4 ] = getSide( 1, 1 ); // pz
				cubeMap.image[ 5 ] = getSide( 3, 1 ); // nz
				cubeMap.needsUpdate = true;

			} );

			var cubeShader = THREE.ShaderLib['cube'];
			cubeShader.uniforms['tCube'].value = cubeMap;

			var skyBoxMaterial = new THREE.ShaderMaterial( {
				fragmentShader: cubeShader.fragmentShader,
				vertexShader: cubeShader.vertexShader,
				uniforms: cubeShader.uniforms,
				depthWrite: false,
				side: THREE.BackSide
			});

			var skyBox = new THREE.Mesh(
				new THREE.BoxGeometry( 10000, 10000, 10000 ),
				skyBoxMaterial
			);
			
			scene.add( skyBox );
		}
		
		function initThree(){
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100000);

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);
			
			loadSkybox();

			camera.position.z = 60;
			camera.position.y = 4;
			camera.position.x = 4;
			
			var pointLight = new THREE.PointLight(0xffffff);
			pointLight.position.set(10, 10, 10);
			scene.add(pointLight);
			
			var ambientLight = new THREE.AmbientLight(0x111111);
		     scene.add(ambientLight);
			
			controls = new THREE.OrbitControls(camera);
			controls.target.set( 0, 3, 0 );
			camera.lookAt(new THREE.Vector3(0,3,0));
			
			var material = new THREE.PointCloudMaterial( { size: 0.03, vertexColors: true } );
//			var pco = POCLoader.load("resources/pointclouds/lion_takanawa/cloud.js");
			var pco = POCLoader.load("../../../pointclouds/converted/skatepark/cloud.js");
			
			var pointCloud = new Potree.PointCloudOctree(pco, material);
			pointCloud.LODDistance = 1280;
			pointCloud.rotation.x = -Math.PI/2;
			pointCloud.position.y = -200;
			scene.add(pointCloud);
			pointClouds.push(pointCloud);
			
			scene.add(createGrid(8,8,1));
		}
		
		function onDocumentMouseMove( event ) {
			event.preventDefault();
	
			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
		}
		
		function createGrid(width, length, spacing){
			var material = new THREE.LineBasicMaterial({
		        color: 0x666666
		    });
			
			var geometry = new THREE.Geometry();
		    for(var i = 0; i <= length; i++){
		    	 geometry.vertices.push(new THREE.Vector3(-(spacing*width)/2, 0, i*spacing-(spacing*length)/2));
				 geometry.vertices.push(new THREE.Vector3(+(spacing*width)/2, 0, i*spacing-(spacing*length)/2));
		    }
		    
		    for(var i = 0; i <= width; i++){
		    	 geometry.vertices.push(new THREE.Vector3(i*spacing-(spacing*width)/2, 0, -(spacing*length)/2));
				 geometry.vertices.push(new THREE.Vector3(i*spacing-(spacing*width)/2, 0, +(spacing*length)/2));
		    }
		    
		    var line = new THREE.Line(geometry, material, THREE.LinePieces);
		    line.receiveShadow = true;
		    return line;
		}
		
		
		var toggle = 0;
		var mouse = { x: 1, y: 1 };
		function render() {
					
			requestAnimationFrame(render);
			
			vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 );
			projector.unprojectVector( vector, camera );
			
			toggle += 0.1;
			if(toggle > 0.2){
				octreeNodesVisible = 0;
				pointsVisible = 0;
				scene.traverse( function ( object ) {
					if ( object instanceof Potree.PointCloudOctree ) {
						object.update( camera );
					}
				} );
				toggle = 0;
			}

				
			renderer.render(scene, camera);
			
			document.getElementById("lblNumVisibleNodes").innerHTML = "visible nodes: " + octreeNodesVisible;
			document.getElementById("lblNumVisiblePoints").innerHTML = "visible points: " + pointsVisible;
			
		};
		
		initThree();
		render();
		
	</script>
	
	<div id="lblNumVisibleNodes" style="position:absolute; left: 10px; top: 30px; width: 200px; color: black">visible nodes: 0</div>
	<div id="lblNumVisiblePoints" style="position:absolute; left: 10px; top: 50px; width: 200px; color: black">visible nodes: 0</div>
	<div id="lblInfo" style="position:absolute; left: 0px; top: 00px; right: 0px; height: 20px; background-color: #aaaaaa">
	Rewriting <a href="http://potree.org/" target="_blank">potree</a> point cloud renderer from scratch using <a href="http://threejs.org/" target="_blank">three.js</a>
	</div>
	<div id="lblControl" style="position:absolute; left: 10px; top: 80px; width: 400px; color: black">
	Orbit Controls:<br>
	left mouse button: rotate object<br>
	right mouse button: pan the screen<br>
	scrool wheel: zoom in and out
	</div>
	
</body>
</html>