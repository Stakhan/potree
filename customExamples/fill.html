

<html>
<head>
	<title>Lion</title>
	<style>canvas { width: 100%; height: 100% }</style>
</head>
<body style="margin: 0; padding: 0">

	<style type="text/css">
	
	.info{
		color:white;
		font-weight: bold;
		text-shadow:  1px  1px 1px black,
					  1px -1px 1px black,
					 -1px  1px 1px black,
					 -1px -1px 1px black;
	}
	
	a:hover, a:visited, a:link, a:active{
		color: #ccccff;
		text-decoration: none;
	}
	
	</style>

	<script src="../libs/three.js/build/three.js"></script>
	<script src="../libs/other/OrbitControls.js"></script>
	<script src="../libs/other/stats.min.js"></script>
	<script src="../libs/other/dat.gui.min.js"></script>
	
	<script src="../build/js/potree.js"></script>
	<script src="../src/materials/PointCloudMaterial.js"></script>
	<script src="../src/PointCloudOctree.js"></script>
		
	<div id="lblNumVisibleNodes" class="info" style="position: absolute; left: 10px; top: 80px; width: 400px; color:white"></div>
	<div id="lblNumVisiblePoints" class="info" style="position: absolute; left: 10px; top: 100px; width: 400px; color:white"></div>
	
	<script>
		var defaultPointSize = 170;
		var defaultBlendDepth = 0.01;
		var defaultPointCountTarget = 1;
		var pointcloudPath = "../resources/pointclouds/lion_takanawa/cloud_bin.js";
		var pointcloudPath = "../../../../pointclouds/pix4d/matterhorn/cloud.js";
		//var pointcloudPath = "../../../../pointclouds/3dlasermapping/whitby_sample_geom/cloud_bin.js";
	
		var renderer;
		var camera;
		var scene;
		var pointcloud;
		var skybox;
		var stats;
		var clock = new THREE.Clock();
		var materials = {};
		var sphere;
		var mouse = {x: 0, y: 0};
		
		function initGUI(){
		
			// dat.gui
			var gui = new dat.GUI({
				height : 5 * 32 - 1
			});
			
			var params = {
				"points(m)": defaultPointCountTarget,
				PointSize: defaultPointSize,
				"opacity": 1.0,
				"SizeType" : "Adaptive",
				BlendDepth: defaultBlendDepth,
				"show octree" : false,
				"Materials" : "RGB",
				"interpolate": false,
				"circles": false
			};
			
			var pPoints = gui.add(params, 'points(m)', 0.02, 5);
			pPoints.onChange(function(value){
				pointcloud.visiblePointsTarget = value * 1000 * 1000;
			});
			
			var pPointSize = gui.add(params, 'PointSize', 0, 200);
			pPointSize.onChange(function(value){
				pointcloud.material.size = value;
			});
			
			var pOpacity = gui.add(params, 'opacity', 0, 1);
			pOpacity.onChange(function(value){
				pointcloud.material.opacity = value;
			});
			
			var pSizeType = gui.add(params, 'SizeType', [ "Fixed", "Attenuated", "Adaptive"]);
			pSizeType.onChange(function(value){
				if(value === "Fixed"){
					pointcloud.material.pointSizeType = Potree.PointSizeType.FIXED;
				}else if(value === "Attenuated"){
					pointcloud.material.pointSizeType = Potree.PointSizeType.ATTENUATED;
				}else if(value === "Adaptive"){
					pointcloud.material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
				}
			});
			
			var pMaterial = gui.add(params, 'Materials', [ "RGB", "Color", "Height", "Octree Depth"]);
			pMaterial.onChange(function(value){
				if(value === "RGB"){
					pointcloud.material.pointColorType = Potree.PointColorType.RGB;
				}else if(value === "Color"){
					pointcloud.material.pointColorType = Potree.PointColorType.COLOR;
				}else if(value === "Height"){
					pointcloud.material.pointColorType = Potree.PointColorType.HEIGHT;
					pointcloud.material.heightMin = 3000;
					pointcloud.material.heightMax = 5000;
				}else if(value === "Octree Depth"){
					pointcloud.material.pointColorType = Potree.PointColorType.OCTREE_DEPTH;
				}else if(value === "Point Index"){
					pointcloud.material.pointColorType = Potree.PointColorType.POINT_INDEX;
				}
			});
			
			var pInterpolate = gui.add(params, 'interpolate');
			pInterpolate.onChange(function(value){
				pointcloud.material.interpolate = value;
			});
			
			var pCircular = gui.add(params, 'circles');
			pCircular.onChange(function(value){
				if(value){
					pointcloud.material.pointShape = Potree.PointShape.CIRCLE;
				}else{
					pointcloud.material.pointShape = Potree.PointShape.SQUARE;
				}
			});

			var pBoundingBox = gui.add(params, 'show octree');
			pBoundingBox.onChange(function(value){
				pointcloud.showBoundingBox = value;
			});
			
			// stats
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			stats.domElement.style.margin = '5px';
			document.body.appendChild( stats.domElement );
		}
		
		function initThree(){
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 100000);

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.autoClear = false;
			document.body.appendChild(renderer.domElement);
			
			renderer.context.getExtension("EXT_frag_depth");
			
			//skybox = Potree.utils.loadSkybox("../resources/textures/skybox/");

			// camera and controls
			camera.position.set(3, 7, 6);
			camera.position.set(2400, 4700, -2100);
			camera.position.set(-444.62, 5979.2, 1177.0);
			
			//controls = new THREE.OrbitControls(camera, renderer.domElement);
			//controls.target.set( 0, 5, 0 );
			//camera.lookAt(controls.target);
			controls = new THREE.FirstPersonControls(camera, renderer.domElement);
			camera.rotation.order = 'ZYX';
			camera.lookAt(new THREE.Vector3(0,0,0));
			camera.lookAt(new THREE.Vector3(1407, 3309, -2178));
			camera.lookAt(new THREE.Vector3(-449.51, 5725.0, 1023.9));
			controls.moveSpeed *= 100;
			
			// load pointcloud
			var pco = POCLoader.load(pointcloudPath, {toOrigin: true});
			
			pointcloud = new Potree.PointCloudOctree(pco, new Potree.PointCloudMaterial());
			pointcloud.material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			pointcloud.material.size = defaultPointSize;
			pointcloud.visiblePointsTarget = defaultPointCountTarget * 1000 * 1000;
			pointcloud.rotation.set(Math.PI/2, 0.85* -Math.PI/2, -0.0);
			pointcloud.applyMatrix(new THREE.Matrix4().set(
				1,0,0,0,
				0,0,1,0,
				0,-1,0,0,
				0,0,0,1
			));
			pointcloud.moveToOrigin();
			pointcloud.moveToGroundPlane();
			
			scene.add(pointcloud);
			
			
			var sphereGeometry = new THREE.SphereGeometry(20);
			sphere = new THREE.Mesh(sphereGeometry);
			scene.add(sphere);
			
			
			renderer.domElement.addEventListener( 'mousemove', onMouseMove, false );
		}
		
		function onMouseMove(event){
			mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;
		}
		
		function render() {
			requestAnimationFrame(render);
			
			//var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
			//vector.unproject(camera);
			//var direction = vector.sub(camera.position).normalize();
			//var ray = new THREE.Ray(camera.position, direction);
			//var point = pointcloud.pick(renderer, camera, ray, {accuracy: 0.2});
			//if(point){
			//	sphere.position.copy(point.position);
			//}
			
			
			pointcloud.update(camera);
			
			document.getElementById("lblNumVisibleNodes").innerHTML = "visible nodes: " + pointcloud.numVisibleNodes;
			document.getElementById("lblNumVisiblePoints").innerHTML = "visible points: " + Potree.utils.addCommas(pointcloud.numVisiblePoints);
			stats.update();
			
			controls.update(clock.getDelta());
			
			// render skybox
			//skybox.camera.rotation.copy(camera.rotation);
			//renderer.render(skybox.scene, skybox.camera);
			
			// render scene
			renderer.render(scene, camera);
		};
		
		initThree();
		initGUI();
		render();
		
	</script>
	
</body>
</html>