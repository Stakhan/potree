function Potree(){}function POCLoader(){}function PointAttribute(e,t,o){this.name=e,this.type=t,this.numElements=o,this.byteSize=this.numElements*this.type.size}function PointAttributes(e){if(this.attributes=new Array,this.byteSize=0,this.size=0,null!=e)for(var t=0;t<e.length;t++){var o=e[t],i=PointAttribute[o];this.attributes.push(i),this.byteSize+=i.byteSize,this.size++}}function LRUItem(e){this.previous=null,this.next=null,this.node=e}function LRU(){this.first=null,this.last=null,this.items={},this.elements=0,this.numPoints=0}function getMousePointCloudIntersection(e,t,o,i){var n=new THREE.Vector3(e.x,e.y,.5);n.unproject(t);for(var r=n.sub(t.position).normalize(),s=new THREE.Ray(t.position,r),a=null,l=null,c=0;c<i.length;c++){var d=i[c],h=d.pick(o,t,s);if(h){var u=t.position.distanceTo(h.position);(!a||l>u)&&(a=h,l=u)}}return a?a.position:null}function pixelsArrayToImage(e,t,o){var i=document.createElement("canvas");i.width=t,i.height=o;var n=i.getContext("2d");e=new e.constructor(e);for(var r=0;r<e.length;r++)e[4*r+3]=255;var s=n.createImageData(t,o);s.data.set(e),n.putImageData(s,0,0);var a=new Image;return a.src=i.toDataURL(),a.style.transform="scaleY(-1)",a}function projectedRadius(e,t,o,i){var n=1/Math.tan(t/2)/o;return n=n*i/2,e*n}Potree.pointLoadLimit=5e6,Potree.workers={},Potree.WorkerManager=function(e){this.code=e,this.instances=[],this.createdInstances=0},Potree.WorkerManager.prototype.getWorker=function(){var e=this.instances.pop();return void 0===e&&(e=Potree.utils.createWorker(this.code),this.createdInstances++),e},Potree.WorkerManager.prototype.returnWorker=function(e){this.instances.push(e)},Potree.WorkerManager.fromUrls=function(e){for(var t="",o=0;o<e.length;o++){var i=e[o],n=new XMLHttpRequest;n.open("GET",i,!1),n.responseType="text",n.overrideMimeType("text/plain; charset=x-user-defined"),n.send(null),200===n.status&&(t+=n.responseText+"\n")}return new Potree.WorkerManager(t)},Potree.workers.binaryDecoder=new Potree.WorkerManager(atob("Ci8vIGh0dHA6Ly9qc3BlcmYuY29tL3VpbnQ4YXJyYXktdnMtZGF0YXZpZXczLzMKZnVuY3Rpb24gQ3VzdG9tVmlldyhidWZmZXIpIHsKCXRoaXMuYnVmZmVyID0gYnVmZmVyOwoJdGhpcy51OCA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CgkKCXZhciB0bXAgPSBuZXcgQXJyYXlCdWZmZXIoNCk7Cgl2YXIgdG1wZiA9IG5ldyBGbG9hdDMyQXJyYXkodG1wKTsKCXZhciB0bXB1OCA9IG5ldyBVaW50OEFycmF5KHRtcCk7CgkKCXRoaXMuZ2V0VWludDMyID0gZnVuY3Rpb24gKGkpIHsKCQlyZXR1cm4gKHRoaXMudThbaSszXSA8PCAyNCkgfCAodGhpcy51OFtpKzJdIDw8IDE2KSB8ICh0aGlzLnU4W2krMV0gPDwgOCkgfCB0aGlzLnU4W2ldOwoJfQoJCgl0aGlzLmdldFVpbnQxNiA9IGZ1bmN0aW9uIChpKSB7CgkJcmV0dXJuICh0aGlzLnU4W2krMV0gPDwgOCkgfCB0aGlzLnU4W2ldOwoJfQoJCgl0aGlzLmdldEZsb2F0ID0gZnVuY3Rpb24oaSl7CgkJdG1wdThbMF0gPSB0aGlzLnU4W2krMF07CgkJdG1wdThbMV0gPSB0aGlzLnU4W2krMV07CgkJdG1wdThbMl0gPSB0aGlzLnU4W2krMl07CgkJdG1wdThbM10gPSB0aGlzLnU4W2krM107CgkJCgkJcmV0dXJuIHRtcGZbMF07Cgl9CgkKCXRoaXMuZ2V0VWludDggPSBmdW5jdGlvbihpKXsKCQlyZXR1cm4gdGhpcy51OFtpXTsKCX0KfQoKUG90cmVlID0ge307CgoKb25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIGJ1ZmZlciA9IGV2ZW50LmRhdGEuYnVmZmVyOwoJdmFyIHBvaW50QXR0cmlidXRlcyA9IGV2ZW50LmRhdGEucG9pbnRBdHRyaWJ1dGVzOwoJdmFyIG51bVBvaW50cyA9IGJ1ZmZlci5ieXRlTGVuZ3RoIC8gcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplOwoJdmFyIGN2ID0gbmV3IEN1c3RvbVZpZXcoYnVmZmVyKTsKCXZhciB2ZXJzaW9uID0gbmV3IFBvdHJlZS5WZXJzaW9uKGV2ZW50LmRhdGEudmVyc2lvbik7Cgl2YXIgbWluID0gZXZlbnQuZGF0YS5taW47Cgl2YXIgbm9kZU9mZnNldCA9IGV2ZW50LmRhdGEub2Zmc2V0OwoJdmFyIHNjYWxlID0gZXZlbnQuZGF0YS5zY2FsZTsKCQoJdmFyIGF0dHJpYnV0ZUJ1ZmZlcnMgPSB7fTsKCQoJdmFyIG9mZnNldCA9IDA7Cglmb3IodmFyIGkgPSAwOyBpIDwgcG9pbnRBdHRyaWJ1dGVzLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCXZhciBwb2ludEF0dHJpYnV0ZSA9IHBvaW50QXR0cmlidXRlcy5hdHRyaWJ1dGVzW2ldOwoJCgkJaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG9pbnRBdHRyaWJ1dGUuUE9TSVRJT05fQ0FSVEVTSUFOLm5hbWUpewoJCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBwb3NpdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCWlmKHZlcnNpb24ubmV3ZXJUaGFuKCIxLjMiKSl7CgkJCQkJcG9zaXRpb25zWzMqaiswXSA9IChjdi5nZXRVaW50MzIob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrMCkgKiBzY2FsZSkgKyBtaW5bMF07CgkJCQkJcG9zaXRpb25zWzMqaisxXSA9IChjdi5nZXRVaW50MzIob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrNCkgKiBzY2FsZSkgKyBtaW5bMV07CgkJCQkJcG9zaXRpb25zWzMqaisyXSA9IChjdi5nZXRVaW50MzIob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrOCkgKiBzY2FsZSkgKyBtaW5bMl07CgkJCQl9ZWxzZXsKCQkJCQlwb3NpdGlvbnNbMypqKzBdID0gY3YuZ2V0RmxvYXQoaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrMCkgKyBub2RlT2Zmc2V0WzBdOwoJCQkJCXBvc2l0aW9uc1szKmorMV0gPSBjdi5nZXRGbG9hdChqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSs0KSArIG5vZGVPZmZzZXRbMV07CgkJCQkJcG9zaXRpb25zWzMqaisyXSA9IGN2LmdldEZsb2F0KGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzgpICsgbm9kZU9mZnNldFsyXTsKCQkJCX0KCQkJfQoJCQkKCQkJYXR0cmlidXRlQnVmZmVyc1twb2ludEF0dHJpYnV0ZS5uYW1lXSA9IHsgYnVmZmVyOiBidWZmLCBhdHRyaWJ1dGU6IHBvaW50QXR0cmlidXRlfTsKCQkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VELm5hbWUpewoJCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBjb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCWNvbG9yc1szKmorMF0gPSBjdi5nZXRVaW50OChvZmZzZXQgKyBqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDApIC8gMjU1OwoJCQkJY29sb3JzWzMqaisxXSA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgMSkgLyAyNTU7CgkJCQljb2xvcnNbMypqKzJdID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAyKSAvIDI1NTsKCQkJfQoJCQkKCQkJYXR0cmlidXRlQnVmZmVyc1twb2ludEF0dHJpYnV0ZS5uYW1lXSA9IHsgYnVmZmVyOiBidWZmLCBhdHRyaWJ1dGU6IHBvaW50QXR0cmlidXRlfTsKCQkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG9pbnRBdHRyaWJ1dGUuSU5URU5TSVRZLm5hbWUpewoKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQpOwoJCQl2YXIgaW50ZW5zaXRpZXMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBpbnRlbnNpdHkgPSBjdi5nZXRVaW50MTYob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUpOwoJCQkJaW50ZW5zaXRpZXNbal0gPSBpbnRlbnNpdHk7CgkJCX0KCQkJCgkJCWF0dHJpYnV0ZUJ1ZmZlcnNbcG9pbnRBdHRyaWJ1dGUubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBwb2ludEF0dHJpYnV0ZX07CgkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT04ubmFtZSl7CgoJCQl2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1Qb2ludHMqNCk7CgkJCXZhciBjbGFzc2lmaWNhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBjbGFzc2lmaWNhdGlvbiA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKTsKCQkJCWNsYXNzaWZpY2F0aW9uc1tqXSA9IGNsYXNzaWZpY2F0aW9uOwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQoJCX0KCQkKCQlvZmZzZXQgKz0gcG9pbnRBdHRyaWJ1dGUuYnl0ZVNpemU7Cgl9CgkKCXZhciBpbmRpY2VzID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KTsKCXZhciBpSW5kaWNlcyA9IG5ldyBVaW50MzJBcnJheShpbmRpY2VzKTsKCWZvcih2YXIgaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKyl7CgkJaUluZGljZXNbaV0gPSBpOwoJfQoJCgl2YXIgbWVzc2FnZSA9IHsKCQlhdHRyaWJ1dGVCdWZmZXJzOiBhdHRyaWJ1dGVCdWZmZXJzLAoJCWluZGljZXM6IGluZGljZXMKCX07CgkJCgl2YXIgdHJhbnNmZXJhYmxlcyA9IFtdOwoJCglmb3IodmFyIHByb3BlcnR5IGluIG1lc3NhZ2UuYXR0cmlidXRlQnVmZmVycyl7CgkJaWYobWVzc2FnZS5hdHRyaWJ1dGVCdWZmZXJzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSl7CgkJCXRyYW5zZmVyYWJsZXMucHVzaChtZXNzYWdlLmF0dHJpYnV0ZUJ1ZmZlcnNbcHJvcGVydHldLmJ1ZmZlcik7CgkJfQoJfQoJCgl0cmFuc2ZlcmFibGVzLnB1c2gobWVzc2FnZS5pbmRpY2VzKTsKCQkKCXBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRyYW5zZmVyYWJsZXMpOwoJCn07ClBvdHJlZS5WZXJzaW9uID0gZnVuY3Rpb24odmVyc2lvbil7Cgl0aGlzLnZlcnNpb24gPSB2ZXJzaW9uOwoJdmFyIHZtTGVuZ3RoID0gKHZlcnNpb24uaW5kZXhPZigiLiIpID09PSAtMSkgPyB2ZXJzaW9uLmxlbmd0aCA6IHZlcnNpb24uaW5kZXhPZigiLiIpOwoJdGhpcy52ZXJzaW9uTWFqb3IgPSBwYXJzZUludCh2ZXJzaW9uLnN1YnN0cigwLCB2bUxlbmd0aCkpOwoJdGhpcy52ZXJzaW9uTWlub3IgPSBwYXJzZUludCh2ZXJzaW9uLnN1YnN0cih2bUxlbmd0aCArIDEpKTsKCWlmKHRoaXMudmVyc2lvbk1pbm9yLmxlbmd0aCA9PT0gMCl7CgkJdGhpcy52ZXJzaW9uTWlub3IgPSAwOwoJfQoJCn07CgpQb3RyZWUuVmVyc2lvbi5wcm90b3R5cGUubmV3ZXJUaGFuID0gZnVuY3Rpb24odmVyc2lvbil7Cgl2YXIgdiA9IG5ldyBQb3RyZWUuVmVyc2lvbih2ZXJzaW9uKTsKCQoJaWYoIHRoaXMudmVyc2lvbk1ham9yID4gdi52ZXJzaW9uTWFqb3IpewoJCXJldHVybiB0cnVlOwoJfWVsc2UgaWYoIHRoaXMudmVyc2lvbk1ham9yID09PSB2LnZlcnNpb25NYWpvciAmJiB0aGlzLnZlcnNpb25NaW5vciA+IHYudmVyc2lvbk1pbm9yKXsKCQlyZXR1cm4gdHJ1ZTsKCX1lbHNlewoJCXJldHVybiBmYWxzZTsKCX0KfTsKClBvdHJlZS5WZXJzaW9uLnByb3RvdHlwZS5lcXVhbE9ySGlnaGVyID0gZnVuY3Rpb24odmVyc2lvbil7Cgl2YXIgdiA9IG5ldyBQb3RyZWUuVmVyc2lvbih2ZXJzaW9uKTsKCQoJaWYoIHRoaXMudmVyc2lvbk1ham9yID4gdi52ZXJzaW9uTWFqb3IpewoJCXJldHVybiB0cnVlOwoJfWVsc2UgaWYoIHRoaXMudmVyc2lvbk1ham9yID09PSB2LnZlcnNpb25NYWpvciAmJiB0aGlzLnZlcnNpb25NaW5vciA+PSB2LnZlcnNpb25NaW5vcil7CgkJcmV0dXJuIHRydWU7Cgl9ZWxzZXsKCQlyZXR1cm4gZmFsc2U7Cgl9Cn07CgpQb3RyZWUuVmVyc2lvbi5wcm90b3R5cGUudXBUbyA9IGZ1bmN0aW9uKHZlcnNpb24pewoJcmV0dXJuICF0aGlzLm5ld2VyVGhhbih2ZXJzaW9uKTsKfQoKCi8vZnVuY3Rpb24gUG9pbnRBdHRyaWJ1dGVOYW1lcygpewovLwkKLy99Cgp2YXIgUG9pbnRBdHRyaWJ1dGVOYW1lcyA9IHt9OwoKUG9pbnRBdHRyaWJ1dGVOYW1lcy5QT1NJVElPTl9DQVJURVNJQU4gCT0gMDsJLy8gZmxvYXQgeCwgeSwgejsKUG9pbnRBdHRyaWJ1dGVOYW1lcy5DT0xPUl9QQUNLRUQJCT0gMTsJLy8gYnl0ZSByLCBnLCBiLCBhOyAJSSA9IFswLDFdClBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfRkxPQVRTXzEJCT0gMjsJLy8gZmxvYXQgciwgZywgYjsgCQlJID0gWzAsMV0KUG9pbnRBdHRyaWJ1dGVOYW1lcy5DT0xPUl9GTE9BVFNfMjU1CT0gMzsJLy8gZmxvYXQgciwgZywgYjsgCQlJID0gWzAsMjU1XQpQb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9GTE9BVFMJCT0gNDsgIAkvLyBmbG9hdCB4LCB5LCB6OwpQb2ludEF0dHJpYnV0ZU5hbWVzLkZJTExFUgkJCQk9IDU7ClBvaW50QXR0cmlidXRlTmFtZXMuSU5URU5TSVRZCQkJPSA2OwpQb2ludEF0dHJpYnV0ZU5hbWVzLkNMQVNTSUZJQ0FUSU9OCQk9IDc7CgovKioKICogU29tZSB0eXBlcyBvZiBwb3NzaWJsZSBwb2ludCBhdHRyaWJ1dGUgZGF0YSBmb3JtYXRzCiAqIAogKiBAY2xhc3MKICovCnZhciBQb2ludEF0dHJpYnV0ZVR5cGVzID0gewoJREFUQV9UWVBFX0RPVUJMRQk6IHtvcmRpbmFsIDogMCwgc2l6ZTogOH0sCglEQVRBX1RZUEVfRkxPQVQJCToge29yZGluYWwgOiAxLCBzaXplOiA0fSwKCURBVEFfVFlQRV9JTlQ4CQk6IHtvcmRpbmFsIDogMiwgc2l6ZTogMX0sCglEQVRBX1RZUEVfVUlOVDgJCToge29yZGluYWwgOiAzLCBzaXplOiAxfSwKCURBVEFfVFlQRV9JTlQxNgkJOiB7b3JkaW5hbCA6IDQsIHNpemU6IDJ9LAoJREFUQV9UWVBFX1VJTlQxNgk6IHtvcmRpbmFsIDogNSwgc2l6ZTogMn0sCglEQVRBX1RZUEVfSU5UMzIJCToge29yZGluYWwgOiA2LCBzaXplOiA0fSwKCURBVEFfVFlQRV9VSU5UMzIJOiB7b3JkaW5hbCA6IDcsIHNpemU6IDR9LAoJREFUQV9UWVBFX0lOVDY0CQk6IHtvcmRpbmFsIDogOCwgc2l6ZTogOH0sCglEQVRBX1RZUEVfVUlOVDY0CToge29yZGluYWwgOiA5LCBzaXplOiA4fQp9OwoKdmFyIGkgPSAwOwpmb3IodmFyIG9iaiBpbiBQb2ludEF0dHJpYnV0ZVR5cGVzKXsKCVBvaW50QXR0cmlidXRlVHlwZXNbaV0gPSBQb2ludEF0dHJpYnV0ZVR5cGVzW29ial07CglpKys7Cn0KCi8qKgogKiBBIHNpbmdsZSBwb2ludCBhdHRyaWJ1dGUgc3VjaCBhcyBjb2xvci9ub3JtYWwvLi4gYW5kIGl0cyBkYXRhIGZvcm1hdC9udW1iZXIgb2YgZWxlbWVudHMvLi4uIAogKiAKICogQGNsYXNzCiAqIEBwYXJhbSBuYW1lIAogKiBAcGFyYW0gdHlwZQogKiBAcGFyYW0gc2l6ZQogKiBAcmV0dXJucwogKi8KZnVuY3Rpb24gUG9pbnRBdHRyaWJ1dGUobmFtZSwgdHlwZSwgbnVtRWxlbWVudHMpewoJdGhpcy5uYW1lID0gbmFtZTsKCXRoaXMudHlwZSA9IHR5cGU7IAoJdGhpcy5udW1FbGVtZW50cyA9IG51bUVsZW1lbnRzOwoJdGhpcy5ieXRlU2l6ZSA9IHRoaXMubnVtRWxlbWVudHMgKiB0aGlzLnR5cGUuc2l6ZTsKfQoKUG9pbnRBdHRyaWJ1dGUuUE9TSVRJT05fQ0FSVEVTSUFOID0gbmV3IFBvaW50QXR0cmlidXRlKAoJCVBvaW50QXR0cmlidXRlTmFtZXMuUE9TSVRJT05fQ0FSVEVTSUFOLAoJCVBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX0ZMT0FULCAzKTsKClBvaW50QXR0cmlidXRlLlJHQkFfUEFDS0VEID0gbmV3IFBvaW50QXR0cmlidXRlKAoJCVBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfUEFDS0VELAoJCVBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX0lOVDgsIDQpOwoKUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VEID0gUG9pbnRBdHRyaWJ1dGUuUkdCQV9QQUNLRUQ7CgpQb2ludEF0dHJpYnV0ZS5SR0JfUEFDS0VEID0gbmV3IFBvaW50QXR0cmlidXRlKAoJCVBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfUEFDS0VELAoJCVBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX0lOVDgsIDMpOwoKUG9pbnRBdHRyaWJ1dGUuTk9STUFMX0ZMT0FUUyA9IG5ldyBQb2ludEF0dHJpYnV0ZSgKCQlQb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9GTE9BVFMsCgkJUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDMpOwoKUG9pbnRBdHRyaWJ1dGUuRklMTEVSXzFCID0gbmV3IFBvaW50QXR0cmlidXRlKAoJCVBvaW50QXR0cmlidXRlTmFtZXMuRklMTEVSLAoJCVBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX1VJTlQ4LCAxKTsKCQkKUG9pbnRBdHRyaWJ1dGUuSU5URU5TSVRZID0gbmV3IFBvaW50QXR0cmlidXRlKAoJCVBvaW50QXR0cmlidXRlTmFtZXMuSU5URU5TSVRZLAoJCVBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX1VJTlQxNiwgMSk7CQkKCQkKUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT04gPSBuZXcgUG9pbnRBdHRyaWJ1dGUoCgkJUG9pbnRBdHRyaWJ1dGVOYW1lcy5DTEFTU0lGSUNBVElPTiwKCQlQb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UOCwgMSk7CQoKLyoqCiAqIE9yZGVyZWQgbGlzdCBvZiBQb2ludEF0dHJpYnV0ZXMgdXNlZCB0byBpZGVudGlmeSBob3cgcG9pbnRzIGFyZSBhbGlnbmVkIGluIGEgYnVmZmVyLgogKiAKICogQGNsYXNzCiAqIAogKi8KZnVuY3Rpb24gUG9pbnRBdHRyaWJ1dGVzKHBvaW50QXR0cmlidXRlcyl7Cgl0aGlzLmF0dHJpYnV0ZXMgPSBuZXcgQXJyYXkoKTsKCXRoaXMuYnl0ZVNpemUgPSAwOwoJdGhpcy5zaXplID0gMDsKCQoJaWYocG9pbnRBdHRyaWJ1dGVzICE9IG51bGwpewoJCS8vIGRvZXMgbm90IHdvcmsgaW4gY2hyb21lIHYyNAovLwkJZm9yKHZhciBwb2ludEF0dHJpYnV0ZSBvZiBwb2ludEF0dHJpYnV0ZXMpewovLwkJCXRoaXMuYXR0cmlidXRlcy5wdXNoKHBvaW50QXR0cmlidXRlKTsKLy8JCQl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwovLwkJCXRoaXMuc2l6ZSsrOwovLwkJfQoJCQoJCWZvcih2YXIgaSA9IDA7IGkgPCBwb2ludEF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCQl2YXIgcG9pbnRBdHRyaWJ1dGVOYW1lID0gcG9pbnRBdHRyaWJ1dGVzW2ldOwoJCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSBQb2ludEF0dHJpYnV0ZVtwb2ludEF0dHJpYnV0ZU5hbWVdOwoJCQl0aGlzLmF0dHJpYnV0ZXMucHVzaChwb2ludEF0dHJpYnV0ZSk7CgkJCXRoaXMuYnl0ZVNpemUgKz0gcG9pbnRBdHRyaWJ1dGUuYnl0ZVNpemU7CgkJCXRoaXMuc2l6ZSsrOwoJCX0KCX0KfQoKUG9pbnRBdHRyaWJ1dGVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihwb2ludEF0dHJpYnV0ZSl7Cgl0aGlzLmF0dHJpYnV0ZXMucHVzaChwb2ludEF0dHJpYnV0ZSk7Cgl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwoJdGhpcy5zaXplKys7Cn07CgpQb2ludEF0dHJpYnV0ZXMucHJvdG90eXBlLmhhc0NvbG9ycyA9IGZ1bmN0aW9uKCl7Cglmb3IodmFyIG5hbWUgaW4gdGhpcy5hdHRyaWJ1dGVzKXsKCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CgkJaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG9pbnRBdHRyaWJ1dGVOYW1lcy5DT0xPUl9QQUNLRUQpewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgkKCXJldHVybiBmYWxzZTsKfTsKClBvaW50QXR0cmlidXRlcy5wcm90b3R5cGUuaGFzTm9ybWFscyA9IGZ1bmN0aW9uKCl7Cglmb3IodmFyIG5hbWUgaW4gdGhpcy5hdHRyaWJ1dGVzKXsKCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CgkJaWYocG9pbnRBdHRyaWJ1dGUgPT09IFBvaW50QXR0cmlidXRlLk5PUk1BTF9GTE9BVFMpewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgkKCXJldHVybiBmYWxzZTsKfTsKCgo=")),THREE.PerspectiveCamera.prototype.zoomTo=function(e,t){if(e.geometry||e.boundingSphere){e.geometry&&null===e.geometry.boundingSphere&&e.geometry.computeBoundingSphere(),e.updateMatrixWorld();var o=t||1,i=e.boundingSphere||e.geometry.boundingSphere;i=i.clone().applyMatrix4(e.matrixWorld);var n=i.radius,r=this.fov*Math.PI/180;this.aspect<1&&(r*=this.aspect);var s=Math.abs(n/Math.sin(r/2))*o,a=new THREE.Vector3(0,0,-1).applyQuaternion(this.quaternion),l=a.multiplyScalar(-s);this.position.copy(i.center.clone().add(l))}},THREE.Ray.prototype.distanceToPlaneWithNegative=function(e){var t=e.normal.dot(this.direction);if(0==t)return 0==e.distanceToPoint(this.origin)?0:null;var o=-(this.origin.dot(e.normal)+e.constant)/t;return o},POCLoader.load=function(e,t){try{var o=new Potree.PointCloudOctreeGeometry;o.url=e;var i=new XMLHttpRequest;i.open("GET",e,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){var n=JSON.parse(i.responseText),r=new Potree.Version(n.version);o.octreeDir=0===n.octreeDir.indexOf("http")?n.octreeDir:e+"/../"+n.octreeDir,o.spacing=n.spacing,o.hierarchyStepSize=n.hierarchyStepSize,o.pointAttributes=n.pointAttributes;var s=new THREE.Vector3(n.boundingBox.lx,n.boundingBox.ly,n.boundingBox.lz),a=new THREE.Vector3(n.boundingBox.ux,n.boundingBox.uy,n.boundingBox.uz),l=new THREE.Box3(s,a),c=l.clone();n.tightBoundingBox&&(c.min.copy(new THREE.Vector3(n.tightBoundingBox.lx,n.tightBoundingBox.ly,n.tightBoundingBox.lz)),c.max.copy(new THREE.Vector3(n.tightBoundingBox.ux,n.tightBoundingBox.uy,n.tightBoundingBox.uz)));var d=new THREE.Vector3(0,0,0);d.set(-s.x,-s.y,-s.z),l.min.add(d),l.max.add(d),c.min.add(d),c.max.add(d),o.boundingBox=l,o.tightBoundingBox=c,o.boundingSphere=l.getBoundingSphere(),o.tightBoundingSphere=c.getBoundingSphere(),o.offset=d,"LAS"===n.pointAttributes?o.loader=new Potree.LasLazLoader(n.version):"LAZ"===n.pointAttributes?o.loader=new Potree.LasLazLoader(n.version):(o.loader=new Potree.BinaryLoader(n.version,l,n.scale),o.pointAttributes=new PointAttributes(o.pointAttributes));var h={},u="r",p=new Potree.PointCloudOctreeGeometryNode(u,o,l);if(p.level=0,p.hasChildren=!0,p.numPoints=r.upTo("1.5")?n.hierarchy[0][1]:0,o.root=p,o.root.load(),h[u]=p,r.upTo("1.4"))for(var m=1;m<n.hierarchy.length;m++){var u=n.hierarchy[m][0],v=n.hierarchy[m][1],E=parseInt(u.charAt(u.length-1)),f=u.substring(0,u.length-1),g=h[f],y=u.length-1,l=POCLoader.createChildAABB(g.boundingBox,E),b=new Potree.PointCloudOctreeGeometryNode(u,o,l);b.level=y,b.numPoints=v,g.addChild(b),h[u]=b}o.nodes=h,t(o)}},i.send(null)}catch(n){console.log("loading failed: '"+e+"'"),console.log(n)}},POCLoader.loadPointAttributes=function(e){for(var t=e.pointAttributes,o=new PointAttributes,i=0;i<t.length;i++){var n=PointAttribute[t[i]];o.add(n)}return o},POCLoader.createChildAABB=function(e,t){var o,i,o=(THREE.Vector3,e.min),i=e.max,n=(new THREE.Vector3).copy(i).sub(o).multiplyScalar(.5),r=new THREE.Vector3(n.x,0,0),s=new THREE.Vector3(0,n.y,0),a=new THREE.Vector3(0,0,n.z),l=o,c=(new THREE.Vector3).add(o).add(n);return 1===t?(o=(new THREE.Vector3).copy(l).add(a),i=(new THREE.Vector3).copy(c).add(a)):3===t?(o=(new THREE.Vector3).copy(l).add(a).add(s),i=(new THREE.Vector3).copy(c).add(a).add(s)):0===t?(o=l,i=c):2===t?(o=(new THREE.Vector3).copy(l).add(s),i=(new THREE.Vector3).copy(c).add(s)):5===t?(o=(new THREE.Vector3).copy(l).add(a).add(r),i=(new THREE.Vector3).copy(c).add(a).add(r)):7===t?(o=(new THREE.Vector3).copy(l).add(n),i=(new THREE.Vector3).copy(c).add(n)):4===t?(o=(new THREE.Vector3).copy(l).add(r),i=(new THREE.Vector3).copy(c).add(r)):6===t&&(o=(new THREE.Vector3).copy(l).add(r).add(s),i=(new THREE.Vector3).copy(c).add(r).add(s)),new THREE.Box3(o,i)};var PointAttributeNames={};PointAttributeNames.POSITION_CARTESIAN=0,PointAttributeNames.COLOR_PACKED=1,PointAttributeNames.COLOR_FLOATS_1=2,PointAttributeNames.COLOR_FLOATS_255=3,PointAttributeNames.NORMAL_FLOATS=4,PointAttributeNames.FILLER=5,PointAttributeNames.INTENSITY=6,PointAttributeNames.CLASSIFICATION=7;var PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}},i=0;for(var obj in PointAttributeTypes)PointAttributeTypes[i]=PointAttributeTypes[obj],i++;PointAttribute.POSITION_CARTESIAN=new PointAttribute(PointAttributeNames.POSITION_CARTESIAN,PointAttributeTypes.DATA_TYPE_FLOAT,3),PointAttribute.RGBA_PACKED=new PointAttribute(PointAttributeNames.COLOR_PACKED,PointAttributeTypes.DATA_TYPE_INT8,4),PointAttribute.COLOR_PACKED=PointAttribute.RGBA_PACKED,PointAttribute.RGB_PACKED=new PointAttribute(PointAttributeNames.COLOR_PACKED,PointAttributeTypes.DATA_TYPE_INT8,3),PointAttribute.NORMAL_FLOATS=new PointAttribute(PointAttributeNames.NORMAL_FLOATS,PointAttributeTypes.DATA_TYPE_FLOAT,3),PointAttribute.FILLER_1B=new PointAttribute(PointAttributeNames.FILLER,PointAttributeTypes.DATA_TYPE_UINT8,1),PointAttribute.INTENSITY=new PointAttribute(PointAttributeNames.INTENSITY,PointAttributeTypes.DATA_TYPE_UINT16,1),PointAttribute.CLASSIFICATION=new PointAttribute(PointAttributeNames.CLASSIFICATION,PointAttributeTypes.DATA_TYPE_UINT8,1),PointAttributes.prototype.add=function(e){this.attributes.push(e),this.byteSize+=e.byteSize,this.size++},PointAttributes.prototype.hasColors=function(){for(var e in this.attributes){var t=this.attributes[e];if(t.name===PointAttributeNames.COLOR_PACKED)return!0}return!1},PointAttributes.prototype.hasNormals=function(){for(var e in this.attributes){var t=this.attributes[e];if(t===PointAttribute.NORMAL_FLOATS)return!0}return!1},Potree.BinaryLoader=function(e,t,o){this.version="string"==typeof e?new Potree.Version(e):e,this.boundingBox=t,this.scale=o},Potree.BinaryLoader.prototype.load=function(e){if(!e.loaded){var t=this,o=e.getURL();this.version.equalOrHigher("1.4")&&(o+=".bin");var i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){var n=i.response;t.parse(e,n)}else console.log("Failed to load file! HTTP status: "+i.status+", file: "+o)};try{i.send(null)}catch(n){console.log("fehler beim laden der punktwolke: "+n)}}},Potree.BinaryLoader.prototype.parse=function(e,t){var o=t.byteLength/e.pcoGeometry.pointAttributes.byteSize,i=e.pcoGeometry.pointAttributes;this.version.upTo("1.5")&&(e.numPoints=o);var n=Potree.workers.binaryDecoder.getWorker();n.onmessage=function(t){var o=t.data,i=o.attributeBuffers;Potree.workers.binaryDecoder.returnWorker(n);var r=new THREE.BufferGeometry;for(var s in i)if(i.hasOwnProperty(s)){{var a=i[s].buffer,l=i[s].attribute;l.numElements}parseInt(s)===PointAttributeNames.POSITION_CARTESIAN?r.addAttribute("position",new THREE.BufferAttribute(new Float32Array(a),3)):parseInt(s)===PointAttributeNames.COLOR_PACKED?r.addAttribute("color",new THREE.BufferAttribute(new Float32Array(a),3)):parseInt(s)===PointAttributeNames.INTENSITY?r.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(a),1)):parseInt(s)===PointAttributeNames.CLASSIFICATION&&r.addAttribute("classification",new THREE.BufferAttribute(new Float32Array(a),1))}r.addAttribute("indices",new THREE.BufferAttribute(new Float32Array(o.indices),1)),r.boundingBox=e.boundingBox,e.geometry=r,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--};var r={buffer:t,pointAttributes:i,version:this.version.version,min:[e.boundingBox.min.x,e.boundingBox.min.y,e.boundingBox.min.z],offset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z],scale:this.scale};n.postMessage(r,[r.buffer])},Potree.LasLazLoader=function(e){this.version="string"==typeof e?new Potree.Version(e):e},Potree.LasLazLoader.prototype.load=function(e){if(!e.loaded){var t=e.pcoGeometry.pointAttributes,o=e.getURL();this.version.equalOrHigher("1.4")&&(o+="."+t.toLowerCase());var i=this,n=new XMLHttpRequest;n.open("GET",o,!0),n.responseType="arraybuffer",n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=n.response;i.parse(e,t)}else console.log("Failed to load file! HTTP status: "+n.status+", file: "+o)},n.send(null)}},Potree.LasLazLoader.progressCB=function(){},Potree.LasLazLoader.prototype.parse=function(e,t){var o=new LASFile(t),i=new Potree.LasLazBatcher(e);return Promise.resolve(o).cancellable().then(function(e){return e.open().then(function(){return e.isOpen=!0,e})["catch"](Promise.CancellationError,function(t){return e.close().then(function(){throw t})})}).then(function(e){return e.getHeader().then(function(t){return[e,t]})}).then(function(e){var t=e[0],o=e[1],n=1,r=0,s=1>=n?o.pointsCount:o.pointsCount/n,a=function(){var e=t.readData(1e6,0,n);return e.then(function(e){return i.push(new LASDecoder(e.buffer,o.pointsFormatId,o.pointsStructSize,e.count,o.scale,o.offset,o.mins,o.maxs)),r+=e.count,Potree.LasLazLoader.progressCB(r/s),e.hasMoreData?a():(o.totalRead=r,o.versionAsString=t.versionAsString,o.isCompressed=t.isCompressed,[t,o,i])})};return a()}).then(function(e){var t=e[0];return Potree.LasLazLoader.progressCB(1),t.close().then(function(){return t.isOpen=!1,Promise.delay(200).cancellable()}).then(function(){return e.slice(1)})})["catch"](Promise.CancellationError,function(e){if(o.isOpen)return o.close().then(function(){throw o.isOpen=!1,e});throw e})},Potree.LasLazLoader.prototype.handle=function(){},Potree.LasLazBatcher=function(e){this.push=function(t){var o=Potree.workers.lasdecoder.getWorker(),i=new THREE.Vector3(t.mins[0],t.mins[1],t.mins[2]),n=new THREE.Vector3(t.maxs[0],t.maxs[1],t.maxs[2]);i.add(e.pcoGeometry.offset),n.add(e.pcoGeometry.offset),o.onmessage=function(r){for(var s=new THREE.BufferGeometry,a=t.pointsCount,l=r.data.position,c=r.data.color,d=r.data.intensity,h=new Uint8Array(r.data.classification),u=new Float32Array(h.byteLength),p=new Uint8Array(r.data.returnNumber),m=new Float32Array(p.byteLength),v=new Uint16Array(r.data.pointSourceID),E=new Float32Array(v.length),f=new ArrayBuffer(4*a),g=new Uint32Array(f),y=new THREE.Box3,b=new Float32Array(l),T=0;a>T;T++)u[T]=h[T],m[T]=p[T],E[T]=v[T],g[T]=T,y.expandByPoint(new THREE.Vector3(b[3*T+0],b[3*T+1],b[3*T+2]));s.addAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),s.addAttribute("color",new THREE.BufferAttribute(new Float32Array(c),3)),s.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(d),1)),s.addAttribute("classification",new THREE.BufferAttribute(new Float32Array(u),1)),s.addAttribute("returnNumber",new THREE.BufferAttribute(new Float32Array(m),1)),s.addAttribute("pointSourceID",new THREE.BufferAttribute(new Float32Array(E),1)),s.addAttribute("indices",new THREE.BufferAttribute(f,1)),s.boundingBox=new THREE.Box3(i,n),e.boundingBox=s.boundingBox,e.geometry=s,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--,Potree.workers.lasdecoder.returnWorker(o)};var r={buffer:t.arrayb,numPoints:t.pointsCount,pointSize:t.pointSize,pointFormatID:2,scale:t.scale,offset:t.offset,mins:[e.pcoGeometry.boundingBox.min.x,e.pcoGeometry.boundingBox.min.y,e.pcoGeometry.boundingBox.min.z],maxs:[e.pcoGeometry.boundingBox.max.x,e.pcoGeometry.boundingBox.max.y,e.pcoGeometry.boundingBox.max.z],bbOffset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z]};o.postMessage(r,[r.buffer])}},Potree.PointSizeType={FIXED:0,ATTENUATED:1,ADAPTIVE:2},Potree.PointShape={SQUARE:0,CIRCLE:1},Potree.PointColorType={RGB:0,COLOR:1,DEPTH:2,HEIGHT:3,INTENSITY:4,INTENSITY_GRADIENT:5,OCTREE_DEPTH:6,POINT_INDEX:7,CLASSIFICATION:8,RETURN_NUMBER:9,SOURCE:10},Potree.ClipMode={DISABLED:0,CLIP_OUTSIDE:1,HIGHLIGHT_INSIDE:2},Potree.PointCloudMaterial=function(e){e=e||{};var t=new THREE.Color(0),o=THREE.ImageUtils.generateDataTexture(2048,1,t);o.magFilter=THREE.NearestFilter,this.visibleNodesTexture=o;var i=e.size||1,n=e.minSize||1,r=1;this._pointSizeType=Potree.PointSizeType.ATTENUATED,this._pointShape=Potree.PointShape.SQUARE,this._interpolate=!1,this._pointColorType=Potree.PointColorType.RGB,this._octreeLevels=6,this._useClipBox=!1,this.numClipBoxes=0,this._clipMode=Potree.ClipMode.DISABLED,this._weighted=!1,this._blendDepth=.1,this._depthMap,this.gradientTexture=Potree.PointCloudMaterial.generateGradient();var s={},a={spacing:{type:"f",value:1},fov:{type:"f",value:1},screenWidth:{type:"f",value:1},screenHeight:{type:"f",value:1},near:{type:"f",value:.1},far:{type:"f",value:1},uColor:{type:"c",value:new THREE.Color(16711680)},opacity:{type:"f",value:1},size:{type:"f",value:10},minSize:{type:"f",value:2},nodeSize:{type:"f",value:r},heightMin:{type:"f",value:0},heightMax:{type:"f",value:1},intensityMin:{type:"f",value:0},intensityMax:{type:"f",value:1},visibleNodes:{type:"t",value:this.visibleNodesTexture},pcIndex:{type:"f",value:0},gradient:{type:"t",value:this.gradientTexture},clipBoxes:{type:"Matrix4fv",value:[]},blendDepth:{type:"f",value:this._blendDepth},depthMap:{type:"t",value:null}};this.setValues({uniforms:a,attributes:s,vertexShader:this.getDefines()+Potree.PointCloudMaterial.vs_points.join("\n"),fragmentShader:this.getDefines()+Potree.PointCloudMaterial.fs_points_rgb.join("\n"),vertexColors:THREE.VertexColors,size:i,minSize:n,nodeSize:r,pcIndex:0,alphaTest:.9})},Potree.PointCloudMaterial.prototype=new THREE.RawShaderMaterial,Potree.PointCloudMaterial.prototype.updateShaderSource=function(){var e={};this.pointColorType===Potree.PointColorType.INTENSITY||this.pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e.intensity={type:"f",value:[]}:this.pointColorType===Potree.PointColorType.CLASSIFICATION?e.classification={type:"f",value:[]}:this.pointColorType===Potree.PointColorType.RETURN_NUMBER?e.returnNumber={type:"f",value:[]}:this.pointColorType===Potree.PointColorType.SOURCE&&(e.pointSourceID={type:"f",value:[]}),this.setValues({attributes:e,vertexShader:this.getDefines()+Potree.PointCloudMaterial.vs_points.join("\n"),fragmentShader:this.getDefines()+Potree.PointCloudMaterial.fs_points_rgb.join("\n")}),this.depthMap&&(this.uniforms.depthMap.value=this.depthMap,this.setValues({depthMap:this.depthMap})),this.setValues(1===this.opacity?{blending:THREE.NoBlending,transparent:!1,depthTest:!0,depthWrite:!0}:{blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1,depthWrite:!0}),this.weighted&&this.setValues({blending:THREE.AdditiveBlending,transparent:!0,depthTest:!0,depthWrite:!1}),this.needsUpdate=!0},Potree.PointCloudMaterial.prototype.getDefines=function(){var e="";return this.pointSizeType===Potree.PointSizeType.FIXED?e+="#define fixed_point_size\n":this.pointSizeType===Potree.PointSizeType.ATTENUATED?e+="#define attenuated_point_size\n":this.pointSizeType===Potree.PointSizeType.ADAPTIVE&&(e+="#define adaptive_point_size\n",e+="#define octreeLevels "+Math.max(0,this._octreeLevels-2).toFixed(1)+"\n"),this.pointShape===Potree.PointShape.SQUARE?e+="#define square_point_shape\n":this.pointShape===Potree.PointShape.CIRCLE&&(e+="#define circle_point_shape\n"),this._interpolate&&(e+="#define use_interpolation\n"),this._pointColorType===Potree.PointColorType.RGB?e+="#define color_type_rgb\n":this._pointColorType===Potree.PointColorType.COLOR?e+="#define color_type_color\n":this._pointColorType===Potree.PointColorType.DEPTH?e+="#define color_type_depth\n":this._pointColorType===Potree.PointColorType.HEIGHT?e+="#define color_type_height\n":this._pointColorType===Potree.PointColorType.INTENSITY?e+="#define color_type_intensity\n":this._pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e+="#define color_type_intensity_gradient\n":this._pointColorType===Potree.PointColorType.OCTREE_DEPTH?e+="#define color_type_octree_depth\n":this._pointColorType===Potree.PointColorType.POINT_INDEX?e+="#define color_type_point_index\n":this._pointColorType===Potree.PointColorType.CLASSIFICATION?e+="#define color_type_classification\n":this._pointColorType===Potree.PointColorType.RETURN_NUMBER?e+="#define color_type_return_number\n":this._pointColorType===Potree.PointColorType.SOURCE&&(e+="#define color_type_source\n"),this.clipMode===Potree.ClipMode.DISABLED?e+="#define clip_disabled\n":this.clipMode===Potree.ClipMode.CLIP_OUTSIDE?e+="#define clip_outside\n":this.clipMode===Potree.ClipMode.HIGHLIGHT_INSIDE&&(e+="#define clip_highlight_inside\n"),this.weighted&&(e+="#define weighted_splats\n"),this.numClipBoxes>0&&(e+="#define use_clip_box\n",e+="#define clip_box_count "+this.numClipBoxes+"\n"),e},Potree.PointCloudMaterial.prototype.setClipBoxes=function(e){var t=e.length;this.numClipBoxes=t,this.uniforms.clipBoxes.value.length/16!==t&&(this.uniforms.clipBoxes.value=new Float32Array(16*t),this.updateShaderSource());for(var o=0;t>o;o++){var i=e[o];this.uniforms.clipBoxes.value.set(i.elements,16*o)}},Object.defineProperty(Potree.PointCloudMaterial.prototype,"spacing",{get:function(){return this.uniforms.spacing.value},set:function(e){this.uniforms.spacing.value!==e&&(this.uniforms.spacing.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"blendDepth",{get:function(){return this.uniforms.blendDepth.value},set:function(e){this.uniforms.blendDepth.value!==e&&(this.uniforms.blendDepth.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useClipBox",{get:function(){return this._useClipBox},set:function(e){this._useClipBox!==e&&(this._useClipBox=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"weighted",{get:function(){return this._weighted},set:function(e){this._weighted!==e&&(this._weighted=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"fov",{get:function(){return this.uniforms.fov.value},set:function(e){this.uniforms.fov.value!==e&&(this.uniforms.fov.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenWidth",{get:function(){return this.uniforms.screenWidth.value
},set:function(e){this.uniforms.screenWidth.value!==e&&(this.uniforms.screenWidth.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenHeight",{get:function(){return this.uniforms.screenHeight.value},set:function(e){this.uniforms.screenHeight.value!==e&&(this.uniforms.screenHeight.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"near",{get:function(){return this.uniforms.near.value},set:function(e){this.uniforms.near.value!==e&&(this.uniforms.near.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"far",{get:function(){return this.uniforms.far.value},set:function(e){this.uniforms.far.value!==e&&(this.uniforms.far.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"opacity",{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value!==e&&(this.uniforms.opacity.value=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"octreeLevels",{get:function(){return this._octreeLevels},set:function(e){this._octreeLevels!==e&&(this._octreeLevels=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointColorType",{get:function(){return this._pointColorType},set:function(e){this._pointColorType!==e&&(this._pointColorType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"depthMap",{get:function(){return this._depthMap},set:function(e){this._depthMap!==e&&(this._depthMap=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointSizeType",{get:function(){return this._pointSizeType},set:function(e){this._pointSizeType!==e&&(this._pointSizeType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"clipMode",{get:function(){return this._clipMode},set:function(e){this._clipMode!==e&&(this._clipMode=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"interpolate",{get:function(){return this._interpolate},set:function(e){this._interpolate!==e&&(this._interpolate=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"color",{get:function(){return this.uniforms.uColor.value},set:function(e){this.uniforms.uColor.value!==e&&(this.uniforms.uColor.value.copy(e),this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointShape",{get:function(){return this._pointShape},set:function(e){this._pointShape!==e&&(this._pointShape=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"size",{get:function(){return this.uniforms.size.value},set:function(e){this.uniforms.size.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"minSize",{get:function(){return this.uniforms.minSize.value},set:function(e){this.uniforms.minSize.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMin",{get:function(){return this.uniforms.heightMin.value},set:function(e){this.uniforms.heightMin.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMax",{get:function(){return this.uniforms.heightMax.value},set:function(e){this.uniforms.heightMax.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"intensityMin",{get:function(){return this.uniforms.intensityMin.value},set:function(e){this.uniforms.intensityMin.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"intensityMax",{get:function(){return this.uniforms.intensityMax.value},set:function(e){this.uniforms.intensityMax.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pcIndex",{get:function(){return this.uniforms.pcIndex.value},set:function(e){this.uniforms.pcIndex.value=e}}),Potree.PointCloudMaterial.generateGradient=function(){var e=64;canvas=document.createElement("canvas"),canvas.width=e,canvas.height=e;var t=canvas.getContext("2d");t.rect(0,0,e,e);var o=t.createLinearGradient(0,0,e,e);o.addColorStop(0,"#4700b6"),o.addColorStop(1/6,"blue"),o.addColorStop(2/6,"aqua"),o.addColorStop(.5,"green"),o.addColorStop(4/6,"yellow"),o.addColorStop(5/6,"orange"),o.addColorStop(1,"red"),t.fillStyle=o,t.fill();var i=new THREE.Texture(canvas);return i.needsUpdate=!0,textureImage=i.image,i},Potree.PointCloudMaterial.vs_points=["precision mediump float;                                                           ","precision mediump int;                                                             ","                                                                                   ","attribute vec3 position;                                                           ","attribute vec3 color;                                                              ","attribute float intensity;                                                         ","attribute float classification;                                                    ","attribute float returnNumber;                                                      ","attribute float pointSourceID;                                                     ","attribute vec4 indices;                                                            ","                                                                                   ","uniform mat4 modelMatrix;                                                          ","uniform mat4 modelViewMatrix;                                                      ","uniform mat4 projectionMatrix;                                                     ","uniform mat4 viewMatrix;                                                           ","uniform mat3 normalMatrix;                                                         ","uniform vec3 cameraPosition;                                                       ","uniform float screenWidth;                                                         ","uniform float screenHeight;                                                        ","uniform float fov;                                                                 ","uniform float spacing;                                                             ","uniform float blendDepth;                                                             ","uniform float near;                                                                ","uniform float far;                                                                 ","                                                                                   ","#if defined use_clip_box                                                                                   ","	uniform mat4 clipBoxes[clip_box_count];                                                                                   ","#endif                                                                                   ","                                                                                   ","                                                                                   ","uniform float heightMin;                                                           ","uniform float heightMax;                                                           ","uniform float intensityMin;                                                        ","uniform float intensityMax;                                                        ","uniform float size;                                                                ","uniform float minSize;                                                             ","uniform float nodeSize;                                                            ","uniform vec3 uColor;                                                               ","uniform float opacity;                                                                                   ","                                                                                   ","                                                                                   ","uniform sampler2D visibleNodes;                                                    ","uniform sampler2D gradient;                                                        ","uniform sampler2D depthMap;                                                        ","                                                                                   ","varying float vOpacity;                                                                                   ","varying vec3 vColor;                                                               ","varying float vDepth;                                                                                   ","varying float vLinearDepth;                                                                                   ","varying vec3 vViewPos;                                                                                   ","varying float vRadius;                                                                                   ","                                                                                   ","                                                                                   ","#if defined(adaptive_point_size) || defined(color_type_octree_depth)               ","/**                                                                                "," * number of 1-bits up to inclusive index position                                 "," * number is treated as if it were an integer in the range 0-255                   "," *                                                                                 "," */                                                                                ","float numberOfOnes(float number, float index){                                     ","	float tmp = mod(number, pow(2.0, index + 1.0));                                  ","	float numOnes = 0.0;                                                             ","	for(float i = 0.0; i < 8.0; i++){                                                ","		if(mod(tmp, 2.0) != 0.0){                                                    ","			numOnes++;                                                               ","		}                                                                            ","		tmp = floor(tmp / 2.0);                                                      ","	}                                                                                ","	return numOnes;                                                                  ","}                                                                                  ","                                                                                   ","                                                                                   ","/**                                                                                "," * checks whether the bit at index is 1                                            "," * number is treated as if it were an integer in the range 0-255                   "," *                                                                                 "," */                                                                                ","bool isBitSet(float number, float index){                                          ","	return mod(floor(number / pow(2.0, index)), 2.0) != 0.0;                         ","}                                                                                  ","                                                                                   ","                                                                                   ","/**                                                                                "," * find the octree depth at the point position                                     "," */                                                                                ","float getOctreeDepth(){                                                            ","	vec3 offset = vec3(0.0, 0.0, 0.0);                                               ","	float iOffset = 0.0;                                                             ","	float depth = 0.0;                                                               ","	for(float i = 0.0; i <= octreeLevels + 1.0; i++){                                ","		                                                                             ","		float nodeSizeAtLevel = nodeSize / pow(2.0, i);                              ","		vec3 index3d = (position - offset) / nodeSizeAtLevel;                        ","		index3d = floor(index3d + 0.5);                                              ","		float index = 4.0*index3d.x + 2.0*index3d.y + index3d.z;                     ","		                                                                             ","		vec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));           ","		float mask = value.r * 255.0;                                                ","		if(isBitSet(mask, index)){                                                   ","			// there are more visible child nodes at this position                   ","			iOffset = iOffset + value.g * 255.0 + numberOfOnes(mask, index - 1.0);   ","			depth++;                                                                 ","		}else{                                                                       ","			// no more visible child nodes at this position                          ","			return depth;                                                            ","		}                                                                            ","		offset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;   ","	}                                                                                ","		                                                                             ","	return depth;                                                                    ","}                                                                                  ","                                                                                   ","#endif                                                                             ","                                                                                   ","vec3 classificationColor(float classification){                                                                                   ","	vec3 color = vec3(0.0, 0.0, 0.0);                                                                                   ","  float c = mod(classification, 16.0);                                                                                   ","	if(c == 0.0){ ","	   color = vec3(0.5, 0.5, 0.5); ","	}else if(c == 1.0){ ","	   color = vec3(0.5, 0.5, 0.5); ","	}else if(c == 2.0){ ","	   color = vec3(0.63, 0.32, 0.18); ","	}else if(c == 3.0){ ","	   color = vec3(0.0, 1.0, 0.0); ","	}else if(c == 4.0){ ","	   color = vec3(0.0, 0.8, 0.0); ","	}else if(c == 5.0){ ","	   color = vec3(0.0, 0.6, 0.0); ","	}else if(c == 6.0){ ","	   color = vec3(1.0, 0.66, 0.0); ","	}else if(c == 7.0){ ","	   color = vec3(1.0, 0, 1.0); ","	}else if(c == 8.0){ ","	   color = vec3(1.0, 0, 0.0); ","	}else if(c == 9.0){ ","	   color = vec3(0.0, 0.0, 1.0); ","	}else if(c == 12.0){ ","	   color = vec3(1.0, 1.0, 0.0); ","	}else{ ","	   color = vec3(0.3, 0.6, 0.6); ","	} ","	                                                                                   ","	return color;                                                                                   ","}                                                                                   ","                                                                                   ","void main() {                                                                      ","                                                                                   ","	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );                       ","  vViewPos = mvPosition.xyz;                                                                                 ","	gl_Position = projectionMatrix * mvPosition;                                     ","  //float pw = gl_Position.w;                                                                                 ","  //float pd = gl_Position.z;                                                                                 ","  //gl_Position = gl_Position / pw;                                                                                 ","  //gl_Position.z = 2.0*((pw - near) / far)-1.0;                                                                                 ","  vOpacity = opacity;                                                                                 ","  vLinearDepth = -mvPosition.z;                                                                                 ","  vDepth = mvPosition.z / gl_Position.w;                                                                                 ","                                                                                   ","  // COLOR TYPES                                                                   ","                                                                                   ","  #ifdef color_type_rgb                                                            ","		vColor = color;                                                              ","  #elif defined color_type_height                                                  ","      vec4 world = modelMatrix * vec4( position, 1.0 );                            ","      float w = (world.y - heightMin) / (heightMax-heightMin);                     ","                                                                                   ","  	vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;                             ","  #elif defined color_type_depth                                                   ","      float d = -mvPosition.z ;                                                                             ","      vColor = vec3(d, vDepth, 0.0);                                                                             ","  #elif defined color_type_intensity                                               ","      float w = (intensity - intensityMin) / (intensityMax - intensityMin);                         ","		vColor = vec3(w, w, w);                                                      ","  #elif defined color_type_intensity_gradient                                      ","      float w = (intensity - intensityMin) / intensityMax;                         ","  	vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;                             ","  #elif defined color_type_color                                                   ","  	vColor = uColor;                                                             ","  #elif defined color_type_octree_depth                                            ","  	float depth = getOctreeDepth();                                              ","      float w = depth / 10.0;                                                      ","  	vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;                             ","  #elif defined color_type_point_index                                             ","  	vColor = indices.rgb;                                                        ","  #elif defined color_type_classification                                             ","  	vColor = classificationColor(classification);                               ","  #elif defined color_type_return_number                                             ","      float w = (returnNumber - 1.0) / 4.0 + 0.1;                                                      ","  	vColor = texture2D(gradient, vec2(w, 1.0 - w)).rgb;                             ","  #elif defined color_type_source                                             ","      float w = mod(pointSourceID, 10.0) / 10.0;                                                                             ","  	vColor = texture2D(gradient, vec2(w,1.0 - w)).rgb;                               ","  #endif                                                                           ","                                                                                   ","                                                                                   ","                                                                                   ","  //                                                                               ","  // POINT SIZE TYPES                                                              ","  //                                                                               ","  float projFactor = 1.0 / tan(fov / 2.0);                                                                             ","  projFactor /= -vViewPos.z;                                                                             ","  projFactor *= screenHeight / 2.0;                                                                              ","  float r = spacing * 1.5;                                                                                 ","  vRadius = r;                                                                                 ","  #if defined fixed_point_size                                                     ","  	gl_PointSize = size;                                                         ","  #elif defined attenuated_point_size                                              ","      gl_PointSize = size * projFactor;                                                                                 ","  #elif defined adaptive_point_size                                                ","      float worldSpaceSize = size * r / pow(1.9, getOctreeDepth());                                                                              ","      gl_PointSize = worldSpaceSize * projFactor;                                                                              ","  #endif                                                                           ","                                                                                    ","	gl_PointSize = max(minSize, gl_PointSize);                                       ","	gl_PointSize = min(50.0, gl_PointSize);                                          ","                                                                                     ","  vRadius = gl_PointSize / projFactor;                                                                                   ","                                                                                     ","                                                                                     ","  // clip box                                                                                  ","  #if defined use_clip_box                                                                                 ","      bool insideAny = false;                                                                               ","      for(int i = 0; i < clip_box_count; i++){                                                                               ","      	vec4 clipPosition = clipBoxes[i] * modelMatrix * vec4( position, 1.0 );                                                                                     ","      	bool inside = -0.5 <= clipPosition.x && clipPosition.x <= 0.5;                                                                             ","      	inside = inside && -0.5 <= clipPosition.y && clipPosition.y <= 0.5;                                                                             ","      	inside = inside && -0.5 <= clipPosition.z && clipPosition.z <= 0.5;                                                                             ","      	insideAny = insideAny || inside;                                                                               ","      }                                                                               ","      if(!insideAny){                                                                               ","                                                                                     ","          #if defined clip_outside                                                                           ","      		gl_Position = vec4(1000.0, 1000.0, 1000.0, 1.0);                                                                               ","          #elif defined clip_highlight_inside && !defined(color_type_depth)                                                                           ","         		float c = (vColor.r + vColor.g + vColor.b) / 6.0;                                                                           ","          	//vColor = vec3(c, c, c);                                                                           ","          #endif                                                                           ","      }else{                                                                               ","      	#if defined clip_highlight_inside                                                                               ","      	vColor.r += 0.5;                                                                               ","          #endif                                                                           ","      }                                                                               ","                                                                                     ","  #endif                                                                                  ","                                                                                   ","                                                                                   ","}                                                                                  "],Potree.PointCloudMaterial.fs_points_rgb=["#if defined use_interpolation                                                      ","	#extension GL_EXT_frag_depth : enable                                            ","#endif                                                                             ","                                                                                   ","precision mediump float;                                                             ","precision mediump int;                                                               ","                                                                                   ","//uniform float opacity;                                                             ","uniform mat4 modelMatrix;                                                          ","uniform mat4 modelViewMatrix;                                                      ","uniform mat4 projectionMatrix;                                                     ","uniform mat4 viewMatrix;                                                           ","uniform mat3 normalMatrix;                                                         ","uniform vec3 cameraPosition;                                                       ","uniform float fov;                                                                 ","uniform float spacing;                                                             ","uniform float near;                                                                ","uniform float far;                                                                 ","                                                                                   ","uniform float pcIndex;                                                             ","uniform float screenWidth;                                                         ","uniform float screenHeight;                                                        ","uniform float blendDepth;                                                          ","                                                                                   ","uniform sampler2D depthMap;                                                        ","                                                                                   ","varying vec3 vColor;                                                               ","varying float vOpacity;                                                            ","varying float vLinearDepth;                                                        ","varying float vDepth;                                                              ","varying vec3 vViewPos;                                                              ","varying float vRadius;                                                             ","                                                                                   ","                                                                                   ","void main() {                                                                      ","	                                                                                 ","	#if defined(circle_point_shape) || defined(use_interpolation) || defined (weighted_splats)                    ","		float u = 2.0 * gl_PointCoord.x - 1.0;                             ","		float v = 2.0 * gl_PointCoord.y - 1.0;                             ","	#endif                                                                           ","		                                                                             ","	#if defined(circle_point_shape) || defined (weighted_splats)	                                                                             ","		float cc = u*u + v*v;                                                     ","		if(cc > 1.0){                                                                 ","			discard;                                                                 ","		}                                                                            ","	#endif	                                                                             ","		                                                                             ","	#if defined weighted_splats                                                      ","		vec2 uv = gl_FragCoord.xy / vec2(screenWidth, screenHeight);                 ","		                                                                             ","	    float depth = texture2D(depthMap, uv).r;                                     ","	    if(vLinearDepth > depth + vRadius * 0.5){                                       ","	    	discard;                                                                 ","	    }                                                                            ","	#endif                                                                           ","	                                                                                 ","	#if defined use_interpolation                                                    ","	    float w = 1.0 - ( u*u + v*v);                                                                             ","	    vec4 pos = vec4(vViewPos, 1.0);                                                                             ","	    pos.z += w * vRadius;                                                                             ","	    pos = projectionMatrix * pos;                                                                             ","	    pos = pos / pos.w;                                                                             ","	                                                                                 ","	    gl_FragDepthEXT = (pos.z + 1.0) / 2.0;                                       ","	#endif                                                                           ","	                                                                                 ","	                                                                                 ","	#if defined color_type_point_index                                               ","		gl_FragColor = vec4(vColor, pcIndex / 255.0);                                ","	#else                                                                            ","		gl_FragColor = vec4(vColor, vOpacity);                                       ","	#endif                                                                           ","	                                                                                 ","	                                                                                 ","	#if defined weighted_splats                                                      ","	    float w = pow(1.0 - (u*u + v*v), 2.0);                                                       ","		gl_FragColor.rgb = gl_FragColor.rgb * w;                                     ","		gl_FragColor.a = w;                                                          ","	#endif                                                                           ","	                                                                                 ","	                                                                                 ","	                                                                                 ","}                                                                                  "],THREE.FirstPersonControls=function(e,t){function o(e){l.enabled!==!1&&(e.preventDefault(),0===e.button?(R=T.ROTATE,c.set(e.clientX,e.clientY)):2===e.button&&(R=T.PAN,u.set(e.clientX,e.clientY)),l.domElement.addEventListener("mousemove",i,!1),l.domElement.addEventListener("mouseup",n,!1),l.dispatchEvent(w))
}function i(e){if(l.enabled!==!1){e.preventDefault();var t=l.domElement===document?l.domElement.body:l.domElement;R===T.ROTATE?(d.set(e.clientX,e.clientY),h.subVectors(d,c),l.rotateLeft(2*Math.PI*h.x/t.clientWidth*l.rotateSpeed),l.rotateUp(2*Math.PI*h.y/t.clientHeight*l.rotateSpeed),c.copy(d)):R===T.PAN&&(p.set(e.clientX,e.clientY),m.subVectors(p,u),m.multiplyScalar(5e-4).multiplyScalar(l.moveSpeed),l.pan(m.x,m.y),u.copy(p))}}function n(){l.enabled!==!1&&(l.domElement.removeEventListener("mousemove",i,!1),l.domElement.removeEventListener("mouseup",n,!1),l.dispatchEvent(C),R=T.NONE)}function r(e){if(l.enabled!==!1&&l.noZoom!==!0){e.preventDefault();var t=e.detail<0||e.wheelDelta>0?1:-1;l.moveSpeed+=.1*l.moveSpeed*t,l.moveSpeed=Math.max(.1,l.moveSpeed),l.dispatchEvent(w),l.dispatchEvent(C)}}function s(e){if(l.enabled!==!1)switch(e.keyCode){case l.keys.UP:l.moveForward=!0;break;case l.keys.BOTTOM:l.moveBackward=!0;break;case l.keys.LEFT:l.moveLeft=!0;break;case l.keys.RIGHT:l.moveRight=!0;break;case l.keys.W:l.moveForward=!0;break;case l.keys.S:l.moveBackward=!0;break;case l.keys.A:l.moveLeft=!0;break;case l.keys.D:l.moveRight=!0}}function a(e){switch(e.keyCode){case l.keys.W:l.moveForward=!1;break;case l.keys.S:l.moveBackward=!1;break;case l.keys.A:l.moveLeft=!1;break;case l.keys.D:l.moveRight=!1;break;case l.keys.UP:l.moveForward=!1;break;case l.keys.BOTTOM:l.moveBackward=!1;break;case l.keys.LEFT:l.moveLeft=!1;break;case l.keys.RIGHT:l.moveRight=!1}}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.rotateSpeed=1,this.moveSpeed=10,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:"A".charCodeAt(0),S:"S".charCodeAt(0),D:"D".charCodeAt(0),W:"W".charCodeAt(0)};var l=this,c=new THREE.Vector2,d=new THREE.Vector2,h=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Vector2,v=new THREE.Vector3,E=(new THREE.Vector3,0),f=0,g=1,y=new THREE.Vector3,b=new THREE.Vector3,T={NONE:-1,ROTATE:0,SPEEDCHANGE:1,PAN:2},R=T.NONE;this.position0=this.object.position.clone();var P={type:"change"},w={type:"start"},C={type:"end"};this.rotateLeft=function(e){f-=e},this.rotateUp=function(e){E-=e},this.panLeft=function(e){var t=this.object.matrix.elements;v.set(t[0],t[1],t[2]),v.multiplyScalar(-e),y.add(v)},this.panUp=function(e){var t=this.object.matrix.elements;v.set(t[4],t[5],t[6]),v.multiplyScalar(e),y.add(v)},this.panForward=function(e){var t=this.object.matrix.elements;v.set(t[8],t[9],t[10]),v.multiplyScalar(e),y.add(v)},this.pan=function(e,t){var o=l.domElement===document?l.domElement.body:l.domElement;if(void 0!==l.object.fov){var i=l.object.position,n=i.clone(),r=n.length();r*=Math.tan(l.object.fov/2*Math.PI/180),l.panLeft(2*e*r/o.clientHeight),l.panUp(2*t*r/o.clientHeight)}else void 0!==l.object.top?(l.panLeft(e*(l.object.right-l.object.left)/o.clientWidth),l.panUp(t*(l.object.top-l.object.bottom)/o.clientHeight)):console.warn("WARNING: FirstPersonControls.js encountered an unknown camera type - pan disabled.")},this.update=function(e){this.object.rotation.order="ZYX";var t=this.object;this.object=new THREE.Object3D,this.object.position.copy(t.position),this.object.rotation.copy(t.rotation),this.object.updateMatrix(),this.object.updateMatrixWorld();var o=this.object.position;if(void 0!==e&&(this.moveRight&&this.panLeft(-e*this.moveSpeed),this.moveLeft&&this.panLeft(e*this.moveSpeed),this.moveForward&&this.panForward(-e*this.moveSpeed),this.moveBackward&&this.panForward(e*this.moveSpeed)),!y.equals(new THREE.Vector3(0,0,0))){var i={type:"move",translation:y.clone()};this.dispatchEvent(i)}if(o.add(y),0!==f||0!==E){var i={type:"rotate",thetaDelta:f,phiDelta:E};this.dispatchEvent(i)}this.object.updateMatrix();var n=(new THREE.Matrix4).makeRotationY(f),r=(new THREE.Matrix4).multiplyMatrices(n,this.object.matrix);this.object.quaternion.setFromRotationMatrix(r),this.object.rotation.x+=E,this.object.updateMatrixWorld();var s={type:"proposeTransform",oldPosition:t.position,newPosition:this.object.position,objections:0,counterProposals:[]};if(this.dispatchEvent(s),s.objections>0&&s.counterProposals.length>0){var a=s.counterProposals;this.object.position.copy(a[0]),s.objections=0,s.counterProposals=[]}s.objections>0||t.position.copy(this.object.position),t.rotation.copy(this.object.rotation),this.object=t,f=0,E=0,g=1,y.set(0,0,0),b.distanceTo(this.object.position)>0&&(this.dispatchEvent(P),b.copy(this.object.position))},this.reset=function(){R=T.NONE,this.object.position.copy(this.position0)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),window.addEventListener("keydown",s,!1),window.addEventListener("keyup",a,!1)},THREE.FirstPersonControls.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.OrbitControls=function(e,t){function o(){return 2*Math.PI/60/60*u.autoRotateSpeed}function i(){return Math.pow(.95,u.zoomSpeed)}function n(e){if(u.enabled!==!1){if(e.preventDefault(),0===e.button){if(u.noRotate===!0)return;A=S.ROTATE,m.set(e.clientX,e.clientY)}else if(1===e.button){if(u.noZoom===!0)return;A=S.DOLLY,R.set(e.clientX,e.clientY)}else if(2===e.button){if(u.noPan===!0)return;A=S.PAN,f.set(e.clientX,e.clientY)}u.domElement.addEventListener("mousemove",r,!1),u.domElement.addEventListener("mouseup",s,!1),u.dispatchEvent(I)}}function r(e){if(u.enabled!==!1){e.preventDefault();var t=u.domElement===document?u.domElement.body:u.domElement;if(A===S.ROTATE){if(u.noRotate===!0)return;v.set(e.clientX,e.clientY),E.subVectors(v,m),u.rotateLeft(2*Math.PI*E.x/t.clientWidth*u.rotateSpeed),u.rotateUp(2*Math.PI*E.y/t.clientHeight*u.rotateSpeed),m.copy(v)}else if(A===S.DOLLY){if(u.noZoom===!0)return;P.set(e.clientX,e.clientY),w.subVectors(P,R),w.y>0?u.dollyIn():u.dollyOut(),R.copy(P)}else if(A===S.PAN){if(u.noPan===!0)return;g.set(e.clientX,e.clientY),y.subVectors(g,f),u.pan(y.x,y.y),f.copy(g)}}}function s(){u.enabled!==!1&&(u.domElement.removeEventListener("mousemove",r,!1),u.domElement.removeEventListener("mouseup",s,!1),u.dispatchEvent(L),A=S.NONE)}function a(e){if(u.enabled!==!1&&u.noZoom!==!0){e.preventDefault();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?u.dollyOut():u.dollyIn(),u.dispatchEvent(I),u.dispatchEvent(L)}}function l(e){if(u.enabled!==!1&&u.noKeys!==!0&&u.noPan!==!0)switch(e.keyCode){case u.keys.UP:u.pan(0,u.keyPanSpeed);break;case u.keys.BOTTOM:u.pan(0,-u.keyPanSpeed);break;case u.keys.LEFT:u.pan(u.keyPanSpeed,0);break;case u.keys.RIGHT:u.pan(-u.keyPanSpeed,0)}}function c(e){if(u.enabled!==!1){switch(e.touches.length){case 1:if(u.noRotate===!0)return;A=S.TOUCH_ROTATE,m.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(u.noZoom===!0)return;A=S.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+o*o);R.set(0,i);break;case 3:if(u.noPan===!0)return;A=S.TOUCH_PAN,f.set(e.touches[0].pageX,e.touches[0].pageY);break;default:A=S.NONE}u.dispatchEvent(I)}}function d(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=u.domElement===document?u.domElement.body:u.domElement;switch(e.touches.length){case 1:if(u.noRotate===!0)return;if(A!==S.TOUCH_ROTATE)return;v.set(e.touches[0].pageX,e.touches[0].pageY),E.subVectors(v,m),u.rotateLeft(2*Math.PI*E.x/t.clientWidth*u.rotateSpeed),u.rotateUp(2*Math.PI*E.y/t.clientHeight*u.rotateSpeed),m.copy(v);break;case 2:if(u.noZoom===!0)return;if(A!==S.TOUCH_DOLLY)return;var o=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(o*o+i*i);P.set(0,n),w.subVectors(P,R);var r=t.clientWidth,s=t.clientHeight,a=Math.sqrt(r*r+s*s),l=w.y/a;w.y>0?u.dollyOut(1-l):u.dollyIn(1+l),R.copy(P);break;case 3:if(u.noPan===!0)return;if(A!==S.TOUCH_PAN)return;g.set(e.touches[0].pageX,e.touches[0].pageY),y.subVectors(g,f),u.pan(y.x,y.y),f.copy(g);break;default:A=S.NONE}}}function h(){u.enabled!==!1&&(u.dispatchEvent(L),A=S.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.fadeFactor=10,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var u=this,p=1e-6,m=new THREE.Vector2,v=new THREE.Vector2,E=new THREE.Vector2,f=new THREE.Vector2,g=new THREE.Vector2,y=new THREE.Vector2,b=new THREE.Vector3,T=new THREE.Vector3,R=new THREE.Vector2,P=new THREE.Vector2,w=new THREE.Vector2,C=0,x=0,H=1,V=new THREE.Vector3,M=new THREE.Vector3,S={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},A=S.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var B={type:"change"},I={type:"start"},L={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=o()),x-=e},this.rotateUp=function(e){void 0===e&&(e=o()),C-=e},this.panLeft=function(e){var t=this.object.matrix.elements;b.set(t[0],t[1],t[2]),b.multiplyScalar(-e),V.add(b)},this.panUp=function(e){var t=this.object.matrix.elements;b.set(t[4],t[5],t[6]),b.multiplyScalar(e),V.add(b)},this.pan=function(e,t){var o=u.domElement===document?u.domElement.body:u.domElement;if(void 0!==u.object.fov){var i=u.object.position,n=i.clone().sub(u.target),r=n.length();r*=Math.tan(u.object.fov/2*Math.PI/180),u.panLeft(2*e*r/o.clientHeight),u.panUp(2*t*r/o.clientHeight)}else void 0!==u.object.top?(u.panLeft(e*(u.object.right-u.object.left)/o.clientWidth),u.panUp(t*(u.object.top-u.object.bottom)/o.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=i()),H/=e},this.dollyOut=function(e){void 0===e&&(e=i()),H*=e},this.update=function(e){var t=this.object.position.clone();T.copy(t).sub(this.target);var i=Math.atan2(T.x,T.z),n=Math.atan2(Math.sqrt(T.x*T.x+T.z*T.z),T.y);this.autoRotate&&this.rotateLeft(o());var r=Math.min(1,this.fadeFactor*e);i+=r*x,n+=r*C,n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n)),n=Math.max(p,Math.min(Math.PI-p,n));var s=T.length();s+=(H-1)*s*r,s=Math.max(this.minDistance,Math.min(this.maxDistance,s)),this.target.add(V.clone().multiplyScalar(r)),T.x=s*Math.sin(n)*Math.sin(i),T.y=s*Math.cos(n),T.z=s*Math.sin(n)*Math.cos(i),t.copy(this.target).add(T);var a={type:"proposeTransform",oldPosition:this.object.position,newPosition:t,objections:0,counterProposals:[]};for(this.dispatchEvent(a);a.objections>0;)if(a.counterProposals.length>0){var l=a.counterProposals;t.copy(l[0]),a.objections=0,a.counterProposals=[]}if(a.objections>0)x=0,C=0,H=1,V.set(0,0,0);else{this.object.position.copy(t),this.object.lookAt(this.target);var c=Math.max(0,1-this.fadeFactor*e);x*=c,C*=c,H=1+(H-1)*c,V.multiplyScalar(c)}M.distanceTo(this.object.position)>0&&(this.dispatchEvent(B),M.copy(this.object.position))},this.reset=function(){A=S.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),this.domElement.addEventListener("touchstart",c,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",d,!1),window.addEventListener("keydown",l,!1)},Potree.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.EarthControls=function(e,t,o){function i(e){if(a.enabled!==!1){e.preventDefault();var t=a.domElement.getBoundingClientRect(),o={x:(e.clientX-t.left)/a.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/a.domElement.clientHeight)+1},i=getMousePointCloudIntersection(o,a.camera,a.renderer,a.pointclouds);if(i){var s=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),i),u=new THREE.Vector3(o.x,o.y,.5);u.unproject(a.camera);var p=u.sub(a.camera.position).normalize(),m=new THREE.Ray(a.camera.position,p);E=m.intersectPlane(s),v=a.camera.clone(),v.rotation.copy(a.camera.rotation),d.set(e.clientX-t.left,e.clientY-t.top),h.set(e.clientX-t.left,e.clientY-t.top),a.scene.add(a.pivotNode),a.pivotNode.position.copy(E),0===e.button?c=l.DRAG:2===e.button&&(c=l.ROTATE),a.domElement.addEventListener("mousemove",n,!1),a.domElement.addEventListener("mouseup",r,!1)}}}function n(e){if(a.enabled!==!1){e.preventDefault();{var t=a.domElement.getBoundingClientRect();a.domElement===document?a.domElement.body:a.domElement}m.set(e.clientX-t.left-h.x,e.clientY-t.top-h.y),h.set(e.clientX-t.left,e.clientY-t.top)}}function r(){a.enabled!==!1&&(a.domElement.removeEventListener("mousemove",n,!1),a.domElement.removeEventListener("mouseup",r,!1),c=l.NONE,a.scene.remove(a.pivotNode))}function s(e){if(a.enabled!==!1&&a.noZoom!==!0){e.preventDefault();var t=a.domElement.getBoundingClientRect(),o=e.detail<0||e.wheelDelta>0?1:-1,i={x:(e.clientX-t.left)/a.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/a.domElement.clientHeight)+1},n=getMousePointCloudIntersection(i,a.camera,a.renderer,a.pointclouds);if(n){var r=n.distanceTo(a.camera.position),s=(new THREE.Vector3).subVectors(n,a.camera.position).normalize();a.camera.position.add(s.multiplyScalar(.1*r*o))}}}this.camera=e,this.renderer=t,this.pointclouds=[],this.domElement=t.domElement,this.scene=o,this.enabled=!0;var a=this,l={NONE:-1,DRAG:0,ROTATE:1},c=l.NONE,d=new THREE.Vector2,h=new THREE.Vector2,u=new THREE.SphereGeometry(1,32,32),p=new THREE.MeshNormalMaterial({shading:THREE.SmoothShading,transparent:!0,opacity:.5});this.pivotNode=new THREE.Mesh(u,p);var m=new THREE.Vector2,v=null,E=null;this.minAngle=10/180*Math.PI,this.maxAngle=70/180*Math.PI,this.update=function(e){this.camera.position;this.camera.updateMatrixWorld();var t=new THREE.Object3D;if(t.position.copy(this.camera.position),t.rotation.copy(this.camera.rotation),t.updateMatrix(),t.updateMatrixWorld(),E){if(c===l.DRAG){var o=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),E),i={x:h.x/this.domElement.clientWidth*2-1,y:2*-(h.y/this.domElement.clientHeight)+1},n=new THREE.Vector3(i.x,i.y,.5);n.unproject(v);var r=n.sub(v.position).normalize(),s=new THREE.Ray(v.position,r),a=s.distanceToPlane(o);if(a>0){var d=(new THREE.Vector3).subVectors(E,r.clone().multiplyScalar(a));t.position.copy(d)}}else if(c===l.ROTATE){var u=m.clone().multiplyScalar(e);u.x*=.3,u.y*=.2;var p=new THREE.Object3D,f=new THREE.Object3D;p.add(f),p.position.copy(E),f.position.copy(this.camera.position).sub(E),f.rotation.copy(this.camera.rotation),p.rotation.y+=-u.x;var r=this.camera.getWorldDirection(),g=new THREE.Vector3(0,1,0),y=(new THREE.Vector3).crossVectors(g,r),b=f.position.clone();b.y=0,b.normalize();var T=b.dot(f.position.clone().normalize()),R=Math.acos(T);f.position.y<0&&(R=-R);var P=0;P=u.y>0?u.y-Math.max(0,this.minAngle-(R-u.y)):u.y+Math.max(0,R-u.y-this.maxAngle),p.rotateOnAxis(y,-P),p.updateMatrixWorld(),t.position.copy(f.getWorldPosition()),t.quaternion.copy(f.getWorldQuaternion())}var w={type:"proposeTransform",oldPosition:this.camera.position,newPosition:t.position,objections:0};this.dispatchEvent(w),w.objections>0||(this.camera.position.copy(t.position),this.camera.rotation.copy(t.rotation));var C=this.pivotNode.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),x=Math.abs(C.z/30),H=this.pivotNode.scale.length();this.pivotNode.scale.multiplyScalar(x/H)}m.set(0,0)},this.reset=function(){c=l.NONE,this.camera.position.copy(this.position0)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1)},THREE.EarthControls.prototype=Object.create(THREE.EventDispatcher.prototype),LRU.prototype.size=function(){return this.elements},LRU.prototype.contains=function(e){return null==this.items[e.id]},LRU.prototype.touch=function(e){if(e.loaded){var t;null==this.items[e.id]?(t=new LRUItem(e),t.previous=this.last,this.last=t,null!==t.previous&&(t.previous.next=t),this.items[e.id]=t,this.elements++,null===this.first&&(this.first=t),this.numPoints+=e.numPoints):(t=this.items[e.id],null===t.previous?null!==t.next&&(this.first=t.next,this.first.previous=null,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t):null===t.next||(t.previous.next=t.next,t.next.previous=t.previous,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t))}},LRU.prototype.remove=function(e){var t=this.items[e.id];t&&(1===this.elements?(this.first=null,this.last=null):(t.previous||(this.first=t.next,this.first.previous=null),t.next||(this.last=t.previous,this.last.next=null),t.previous&&t.next&&(t.previous.next=t.next,t.next.previous=t.previous)),delete this.items[e.id],this.elements--,this.numPoints-=e.numPoints)},LRU.prototype.getLRUItem=function(){if(null===this.first)return null;var e=this.first;return e.node},LRU.prototype.toString=function(){for(var e="{ ",t=this.first;null!==t;)e+=t.node.id,null!==t.next&&(e+=", "),t=t.next;return e+="}",e+="("+this.size()+")"},LRU.prototype.freeMemory=function(){if(!(this.elements<=1))for(;this.numPoints>Potree.pointLoadLimit;){var e=this.first,t=e.node;this.disposeDescendants(t)}},LRU.prototype.disposeDescendants=function(e){var t=[];for(t.push(e);t.length>0;){var o=t.pop();o.dispose(),this.remove(o);for(var i in o.children)if(o.children.hasOwnProperty(i)){var n=o.children[i];n.loaded&&t.push(o.children[i])}}},Potree.PointCloudOctreeProxyNode=function(e){THREE.Object3D.call(this),this.geometryNode=e,this.boundingBox=e.boundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(),this.name=e.name,this.level=e.level,this.numPoints=e.numPoints},Potree.PointCloudOctreeProxyNode.prototype=Object.create(THREE.Object3D.prototype),Potree.ProfileRequest=function(e,t,o,i,n){this.start=e,this.end=t,this.width=o,this.depth=i,this.callback=n,this.loadQueue=[];var r=((new THREE.Vector3).addVectors(t,e).multiplyScalar(.5),(new THREE.Vector3).subVectors(t,e).length(),(new THREE.Vector3).subVectors(t,e).normalize()),s=new THREE.Vector3(0,1,0),a=(new THREE.Vector3).crossVectors(r,s).normalize(),l=a;this.plane=(new THREE.Plane).setFromNormalAndCoplanarPoint(l,e)},Potree.PointCloudOctree=function(e,t){THREE.Object3D.call(this),Potree.PointCloudOctree.lru=Potree.PointCloudOctree.lru||new LRU,this.pcoGeometry=e,this.boundingBox=this.pcoGeometry.tightBoundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(),this.material=t||new Potree.PointCloudMaterial,this.visiblePointsTarget=2e6,this.level=0,this.position.sub(e.offset),this.updateMatrix(),this.LODDistance=20,this.LODFalloff=1.3,this.LOD=4,this.showBoundingBox=!1,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleBounds=new THREE.Box3,this.profileRequests=[],this.visibleNodes=[],this.visibleGeometry=[],this.pickTarget,this.pickMaterial,this.maxLevel=0,this.generateDEM=!1;var o=new Potree.PointCloudOctreeProxyNode(this.pcoGeometry.root);this.add(o)},Potree.PointCloudOctree.prototype=Object.create(THREE.Object3D.prototype),Potree.PointCloudOctree.prototype.updateVisibleBounds=function(){for(var e=[],t=0;t<this.visibleNodes.length;t++){for(var o=this.visibleNodes[t],i=o.node,n=!0,r=0;r<i.children.length;r++){var s=i.children[r];s instanceof THREE.PointCloud&&(n=n&&!s.visible)}n&&e.push(i)}this.visibleBounds.min=new THREE.Vector3(1/0,1/0,1/0),this.visibleBounds.max=new THREE.Vector3(-1/0,-1/0,-1/0);for(var t=0;t<e.length;t++){var i=e[t];this.visibleBounds.expandByPoint(i.boundingBox.min),this.visibleBounds.expandByPoint(i.boundingBox.max)}},Potree.PointCloudOctree.prototype.updateProfileRequests=function(){for(var e=0;e<this.profileRequests.length;e++){var t=this.profileRequests[e],o=t.plane,i=(t.start,t.end,t.depth),n=[];for(n.push(this);n.length>0;){var r=n.shift();if(r instanceof Potree.PointCloudOctreeProxyNode){var s=Potree.utils.computeTransformedBoundingBox(r.boundingBox,r.matrixWorld),a=s.getBoundingSphere();Math.abs(o.distanceToPoint(a.center))<a.radius&&t.loadQueue.push(r)}if(r.level<i)for(var e=0;e<r.children.length;e++){var l=r.children[e];(l instanceof Potree.PointCloudOctreeProxyNode||l instanceof THREE.PointCloud)&&n.push(r.children[e])}}}for(var c=[],e=0;e<this.profileRequests.length;e++){var d=this.profileRequests[e];if(d.loadQueue.length>0){var r=d.loadQueue[0],h=r.geometryNode;if(h.loaded===!0&&void 0!==r.parent){var u=this.replaceProxy(r);u.updateMatrixWorld(),u.matrixWorld.multiplyMatrices(u.parent.matrixWorld,u.matrix)}else r.geometryNode.load()}else{var p=this.getProfile(d.start,d.end,d.width,d.depth);d.callback({type:"finished",points:p}),c.push(d)}}for(var e=0;e<c.length;e++){var m=this.profileRequests.indexOf(c[e]);m>-1&&this.profileRequests.splice(m,1)}},Potree.PointCloudOctree.prototype.updatePointCloud=function(e,t,o,i){if(this.numVisibleNodes++,this.numVisiblePoints+=e.numPoints,e.material=this.material,this.visibleNodes.push(t),e.level&&(this.maxLevel=Math.max(e.level,this.maxLevel)),this.showBoundingBox&&!e.boundingBoxNode){var n=new THREE.BoxHelper(e);this.add(n),this.boundingBoxNodes.push(n),e.boundingBoxNode=n,e.boundingBoxNode.matrixWorld.copy(e.matrixWorld)}else this.showBoundingBox?(e.boundingBoxNode.visible=!0,e.boundingBoxNode.matrixWorld.copy(e.matrixWorld)):!this.showBoundingBox&&e.boundingBoxNode&&(e.boundingBoxNode.visible=!1);this.generateDEM&&e.level<=2&&(e.dem||(e.dem=this.createDEM(e)));for(var r=0;r<e.children.length;r++){var s=e.children[r],a=i.indexOf(s.name)>=0;if(a)for(var l=0;l<this.visibleGeometry.length;l++)if(this.visibleGeometry[l].node.name===s.name){o.push({node:s,weight:this.visibleGeometry[l].weight});break}}},Potree.PointCloudOctree.prototype.updateMaterial=function(e,t,o){this.material.fov=t.fov*(Math.PI/180),this.material.screenWidth=o.domElement.clientWidth,this.material.screenHeight=o.domElement.clientHeight,this.material.spacing=this.pcoGeometry.spacing,this.material.near=t.near,this.material.far=t.far,this.material.octreeLevels=this.maxLevel,this.material.pointSizeType&&(this.material.pointSizeType===Potree.PointSizeType.ADAPTIVE||this.material.pointColorType===Potree.PointColorType.OCTREE_DEPTH)&&this.updateVisibilityTexture(this.material,e)},Potree.PointCloudOctree.prototype.updateLoadQueue=function(){if(this.loadQueue.length>0){this.loadQueue.length>=2&&this.loadQueue.sort(function(e,t){return t.weight-e.weight});for(var e=0;e<Math.min(5,this.loadQueue.length);e++)this.loadQueue[e].node.geometryNode.load()}},Potree.PointCloudOctree.prototype.update=function(e,t){if(this.visibleGeometry=[],this.loadQueue=[],this.visibleNodes=[],this.numVisibleNodes=0,this.numVisiblePoints=0,this.visible){this.updateMatrixWorld(!0),this.visibleGeometry=this.getVisibleGeometry(e);for(var o=[],i=0;i<this.visibleGeometry.length;i++)o.push(this.visibleGeometry[i].node.name);for(var i=0;i<this.profileRequests.length;i++){var n=this.profileRequests[i];n.loadQueue=[]}for(var i=0;i<this.boundingBoxNodes.length;i++)this.boundingBoxNodes[i].visible=!1;this.hideDescendants(this.children[0]);var r=[];for(r.push({node:this.children[0],weight:1});r.length>0;){{var s=r.shift(),a=s.node;s.weight}if(a.visible=!0,a.matrixWorld.multiplyMatrices(a.parent.matrixWorld,a.matrix),a instanceof Potree.PointCloudOctreeProxyNode){var l=a.geometryNode;l.loaded===!0?this.replaceProxy(a):this.loadQueue.push(s)}else if(a instanceof THREE.PointCloud)if(a.pcoGeometry.loaded)Potree.PointCloudOctree.lru.touch(a.pcoGeometry),this.updatePointCloud(a,s,r,o);else{var c=new Potree.PointCloudOctreeProxyNode(a.pcoGeometry),d=a.parent;d.remove(a),d.add(c)}}this.updateProfileRequests(),this.updateVisibleBounds(),this.updateLoadQueue(),this.hideDescendants(this.children[0]);for(var h=[],i=0;i<this.visibleNodes.length;i++)this.visibleNodes[i].node.visible=!0,h.push(this.visibleNodes[i].node);this.updateMaterial(h,e,t),Potree.PointCloudOctree.lru.freeMemory()}},Potree.PointCloudOctree.prototype.getVisibleGeometry=function(e){var t=[],o=this.pcoGeometry;e.updateMatrixWorld();var i=new THREE.Frustum,n=e.matrixWorldInverse,r=this.matrixWorld,s=e.projectionMatrix,a=(new THREE.Matrix4).multiply(s).multiply(n).multiply(r);i.setFromMatrix(a);var l=e.matrixWorld,c=(new THREE.Matrix4).getInverse(r),d=(new THREE.Matrix4).multiply(c).multiply(l),h=(new THREE.Vector3).setFromMatrixPosition(d),u=o.root,p=[],m=0,v=u.boundingBox.getBoundingSphere(),E=v.center.distanceTo(h),f=1/Math.max(.1,v.center.distanceTo(h)-v.radius);p.push({node:u,weight:f});for(var g=0;p.length>0;){g++;var y=p.shift(),b=y.node,T=b.boundingBox,v=b.boundingSphere,R=i.intersectsBox(T),P=R;if(P){if(m+b.numPoints>this.visiblePointsTarget)break;m+=b.numPoints,t.push(y);for(var w=0;8>w;w++)if(b.children[w]){var C=b.children[w],v=C.boundingSphere,E=v.center.distanceTo(h),x=v.radius,f=v.radius/E,H=e.fov/2*Math.PI/180,V=1/Math.tan(H)*x/Math.sqrt(E*E-x*x);if(!(.1>V))if(f=V,0>E-x&&(f=Number.MAX_VALUE),0===p.length)p.push({node:C,weight:f});else{for(var M=0,S=0;S<p.length;S++){if(f>p[S].weight){var M=S;break}if(S==p.length-1){M=p.length;break}}p.splice(M,0,{node:C,weight:f})}}}}return t},Potree.PointCloudOctree.prototype.updateVisibilityTexture=function(e,t){if(e){var o=e.visibleNodesTexture,i=o.image.data;t=t.slice();var n=function(e,t){var o=e.name,i=t.name;return o.length!=i.length?o.length-i.length:i>o?-1:o>i?1:0};t.sort(n);for(var r={},s=0;s<t.length;s++)r[t[s].name]=!0;for(var s=0;s<t.length;s++){for(var a=t[s],l=[],c=0;c<a.children.length;c++){var d=a.children[c];d instanceof THREE.PointCloud&&d.visible&&r[d.name]&&l.push(d)}l.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),i[3*s+0]=0,i[3*s+1]=0,i[3*s+2]=0;for(var c=0;c<l.length;c++){var d=l[c],h=parseInt(d.name.substr(-1));if(i[3*s+0]+=Math.pow(2,h),0===c){var u=t.indexOf(d);i[3*s+1]=u-s}}}e.uniforms.nodeSize.value=this.pcoGeometry.boundingBox.size().x,o.needsUpdate=!0}},Potree.PointCloudOctree.prototype.nodesOnRay=function(e,t){for(var o=[],i=t.clone(),n=0;n<e.length;n++){var r=e[n].node,s=r.boundingSphere.clone().applyMatrix4(r.matrixWorld);i.isIntersectionSphere(s)&&o.push(r)}return o},Potree.PointCloudOctree.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0)},Potree.PointCloudOctree.prototype.replaceProxy=function(e){var t=e.geometryNode;if(t.loaded===!0){var o=t.geometry,i=new THREE.PointCloud(o,this.material);i.name=e.name,i.level=e.level,i.numPoints=e.numPoints,i.boundingBox=o.boundingBox,i.boundingSphere=i.boundingBox.getBoundingSphere(),i.pcoGeometry=t;var n=e.parent;n.remove(e),n.add(i),i.matrixWorld.multiplyMatrices(i.parent.matrixWorld,i.matrix);for(var r=0;8>r;r++)if(void 0!==t.children[r]){var s=t.children[r],a=new Potree.PointCloudOctreeProxyNode(s);i.add(a)}return i}},Potree.PointCloudOctree.prototype.hideDescendants=function(e){for(var t=[],o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}for(;t.length>0;){var e=t.shift();e.visible=!1;for(var o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}}},Potree.PointCloudOctree.prototype.moveToOrigin=function(){this.position.set(0,0,0),this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);this.position.set(0,0,0).sub(o.center())},Potree.PointCloudOctree.prototype.moveToGroundPlane=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);this.position.y+=-o.min.y},Potree.PointCloudOctree.prototype.getBoundingBoxWorld=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);return o},Potree.PointCloudOctree.prototype.getPointsInProfile=function(e,t){for(var o=[],i=0,n=0;n<e.points.length-1;n++){var r=e.points[n],s=e.points[n+1],a=this.getProfile(r,s,e.width,t),l=function(e,t,o){var i=e,n=t,r=o,s=new THREE.Vector3(1,0,0),a=(new THREE.Vector3).subVectors(n,i);a.y=0,a.normalize();var l=Math.acos(s.dot(a));return a.z>0&&(l=-l),function(e){var t=(new THREE.Matrix4).makeTranslation(-i.x,-i.y,-i.z),o=(new THREE.Matrix4).makeRotationY(-l),n=(new THREE.Matrix4).makeTranslation(r,0,0),s=e.clone();return s.applyMatrix4(t),s.applyMatrix4(o),s.applyMatrix4(n),s}}(r,s,i),c={start:r,end:s,points:a,project:l};o.push(c),i+=r.distanceTo(s)}return o},Potree.PointCloudOctree.prototype.getProfile=function(e,t,o,i,n){if(void 0===n){var r=[];r.push(this);for(var s=(new THREE.Vector3).addVectors(t,e).multiplyScalar(.5),a=(new THREE.Vector3).subVectors(t,e).length(),l=(new THREE.Vector3).subVectors(t,e).normalize(),c=new THREE.Vector3(0,1,0),d=(new THREE.Vector3).crossVectors(l,c).normalize(),h=d,u=(new THREE.Plane).setFromNormalAndCoplanarPoint(h,e),p=(new THREE.Plane).setFromNormalAndCoplanarPoint(l,s),m=null;r.length>0;){var v=r.shift(),E=0;if(v instanceof THREE.PointCloud){var f=v.geometry,g=f.attributes.position,y=g.array,b=v.numPoints;if(!m){m={};for(var T in f.attributes)f.attributes.hasOwnProperty(T)&&("indices"===T||(m[T]=[]))}for(var R=0;b>R;R++){var P=new THREE.Vector3(y[3*R],y[3*R+1],y[3*R+2]);P.applyMatrix4(this.matrixWorld);var w=Math.abs(u.distanceToPoint(P)),C=Math.abs(p.distanceToPoint(P));if(o/2>w&&a/2>C){for(var T in f.attributes)if(f.attributes.hasOwnProperty(T))if("position"===T)m[T].push(P);else if("indices"===T);else{var x=f.attributes[T];if(1===x.itemSize)m[T].push(x.array[R+V]);else{for(var H=[],V=0;V<x.itemSize;V++)H.push(x.array[R*x.itemSize+V]);m[T].push(H)}}E++}}}if(v==this||v.level<i)for(var R=0;R<v.children.length;R++){var M=v.children[R];if(M instanceof THREE.PointCloud){var S=M.boundingSphere.clone().applyMatrix4(M.matrixWorld);u.distanceToSphere(S)<S.radius&&r.push(M)}}}m.numPoints=m.position.length;var A=function(e,t){var o=e,i=t,n=new THREE.Vector3(1,0,0),r=(new THREE.Vector3).subVectors(i,o);r.y=0,r.normalize();var s=Math.acos(n.dot(r));return r.z>0&&(s=-s),function(e){var t=(new THREE.Matrix4).makeTranslation(-o.x,-o.y,-o.z),i=(new THREE.Matrix4).makeRotationY(-s),n=e.clone();return n.applyMatrix4(t),n.applyMatrix4(i),n}}(e,t);return m.project=A,m}this.profileRequests.push(new Potree.ProfileRequest(e,t,o,i,n))},Potree.PointCloudOctree.prototype.getVisibleExtent=function(){return this.visibleBounds.applyMatrix4(this.matrixWorld)},Potree.PointCloudOctree.prototype.pick=function(e,t,o,i){var i=i||{},n=i.pickWindowSize||17,r=this.nodesOnRay(this.visibleNodes,o);if(0===r.length)return null;var s=Math.ceil(e.domElement.clientWidth),a=Math.ceil(e.domElement.clientHeight),l=(new THREE.Vector3).addVectors(t.position,o.direction).project(t);l.addScalar(1).multiplyScalar(.5),l.x*=s,l.y*=a,this.pickTarget?(this.pickTarget.width!=s||this.pickTarget.height!=a)&&(this.pickTarget.dispose(),this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})):this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.pickTarget.setSize(s,a),this.pickMaterial||(this.pickMaterial=new Potree.PointCloudMaterial,this.pickMaterial.pointColorType=Potree.PointColorType.POINT_INDEX,this.pickMaterial.pointSizeType=Potree.PointSizeType.FIXED),this.pickMaterial.pointSizeType=this.material.pointSizeType,this.pickMaterial.size=this.material.size,this.pickMaterial.pointSizeType===Potree.PointSizeType.ADAPTIVE&&this.updateVisibilityTexture(this.pickMaterial,r),this.pickMaterial.fov=this.material.fov,this.pickMaterial.screenWidth=this.material.screenWidth,this.pickMaterial.screenHeight=this.material.screenHeight,this.pickMaterial.spacing=this.material.spacing,this.pickMaterial.near=this.material.near,this.pickMaterial.far=this.material.far,this.pickMaterial.octreeLevels=this.material.octreeLevels,this.pickMaterial.pointShape=this.material.pointShape;
var c=e.context;c.enable(c.SCISSOR_TEST),c.scissor(l.x-(n-1)/2,l.y-(n-1)/2,n,n),c.disable(c.SCISSOR_TEST);var d=this.pickMaterial;e.setRenderTarget(this.pickTarget),e.setDepthTest(d.depthTest),e.setDepthWrite(d.depthWrite),e.setBlending(THREE.NoBlending),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),r.length>0&&r.push(r[0]);for(var h=0;h<r.length;h++){var u=r[h],p=u.geometry;if(p.attributes.indices.buffer){if(d.pcIndex=h,d.program){var m=d.program.program;c.useProgram(m);var v=c.getAttribLocation(m,"indices"),E=4;c.bindBuffer(c.ARRAY_BUFFER,p.attributes.indices.buffer),c.enableVertexAttribArray(v),c.vertexAttribPointer(v,E,c.UNSIGNED_BYTE,!0,0,0),c.uniform1f(d.program.uniforms.pcIndex,d.pcIndex)}e.renderBufferDirect(t,[],null,d,p,u)}}var n=17,f=n*n,g=new ArrayBuffer(4*f),y=new Uint8Array(g),b=new Uint32Array(g);e.context.readPixels(l.x-(n-1)/2,l.y-(n-1)/2,n,n,e.context.RGBA,e.context.UNSIGNED_BYTE,y);for(var T=Number.MAX_VALUE,R=null,P=0;n>P;P++)for(var w=0;n>w;w++){var C=P+w*n,x=Math.pow(P-(n-1)/2,2)+Math.pow(w-(n-1)/2,2),H=y[4*C+3];y[4*C+3]=0;var V=b[C];(0!==V||0!==H)&&T>x&&(R={pIndex:V,pcIndex:H},T=x)}if(R){var M={},S=r[R.pcIndex],A=S.geometry.attributes;for(var B in A)if(A.hasOwnProperty(B)){var I=p.attributes[B];if("position"===B){var L=S.geometry.attributes.position.array,W=L[3*R.pIndex+0],G=L[3*R.pIndex+1],O=L[3*R.pIndex+2],N=new THREE.Vector3(W,G,O);N.applyMatrix4(this.matrixWorld),M[B]=N}else if("indices"===B);else if(1===I.itemSize)M[B]=I.array[h+Z];else{for(var X=[],Z=0;Z<I.itemSize;Z++)X.push(I.array[h*I.itemSize+Z]);M[B]=X}}return M}return null};var demTime=0;Potree.PointCloudOctree.prototype.createDEM=function(e){for(var t=(new Date).getTime(),o=e.matrixWorld,i=e.boundingBox.clone().applyMatrix4(o),n=i.size(),r=e.geometry.attributes.position.array,s=64,a=new Array(s*s),l=new Float32Array(s*s),c=r.length/3,d=0;c>d;d++){var h=r[3*d+0],u=r[3*d+1],p=r[3*d+2],m=new THREE.Vector3(h,u,p).applyMatrix4(o),v=parseInt(s*(m.x-i.min.x)/n.x),E=parseInt(s*(m.z-i.min.z)/n.z);v=Math.min(v,s-1),E=Math.min(E,s-1);var f=v+E*s;a[f]||(a[f]=[]),a[f].push(m.y)}for(var d=0;d<a.length;d++){var g=a[d];if(g)if(0===g.length)l[d]=0;else{var y=parseInt((g.length-1)/2);l[d]=g[y]}else l[d]=0}var b=new THREE.Box2;b.expandByPoint(new THREE.Vector3(i.min.x,i.min.z)),b.expandByPoint(new THREE.Vector3(i.max.x,i.max.z));var T={boundingBox:i,boundingBox2D:b,dem:l,demSize:s},R=(new Date).getTime(),P=R-t;return demTime+=P,T},Potree.PointCloudOctree.prototype.getDEMHeight=function(e){var t=new THREE.Vector2(e.x,e.z),o=function(e){{var o=e.demSize,i=e.boundingBox2D;i.containsPoint(t)}if(i.containsPoint(t)){var n=t.clone().sub(i.min).divide(i.size()),r=n.clone().multiplyScalar(o),s=0;if(r.x>.5&&r.x<o-.5&&r.y>.5&&r.y<o-.5){var a=Math.floor(r.x-.5),l=Math.floor(r.y-.5);a=a===o-1?o-2:a,l=l===o-1?o-2:l;var c=r.x-a-.5,d=r.y-l-.5,h=a+l*o,u=a+1+l*o,p=a+(l+1)*o,m=a+1+(l+1)*o,v=e.dem[h],E=e.dem[u],f=e.dem[p],g=e.dem[m];if(0===v||0===E||0===f||0===g)s=null;else{var y=v*(1-c)+E*c,b=f*(1-c)+g*c;s=y*(1-d)+b*d}}else{r.x=Math.min(parseInt(Math.min(r.x,o)),o-1),r.y=Math.min(parseInt(Math.min(r.y,o)),o-1);var T=r.x+r.y*o;s=e.dem[T]}return s}return null},i=null,n=[];for(this.children[0].dem&&n.push(this.children[0]);n.length>0;){{var r=n.shift(),s=r.dem,a=(s.demSize,s.boundingBox2D);a.containsPoint(t)}if(a.containsPoint(t)){var l=o(s);if(i?null!=l&&l>0&&(i=l):i=l,r.level<=2)for(var c=0;c<r.children.length;c++){var d=r.children[c];d.dem&&n.push(d)}}}return i},Potree.PointCloudOctree.prototype.generateTerain=function(){for(var e=this.boundingBox.clone().applyMatrix4(this.matrixWorld),t=300,o=300,i=new THREE.BufferGeometry,n=new Float32Array(t*o*3),r=0,s=0;t>s;s++)for(var a=0;o>a;a++){var l=s/t,c=a/o,d=l*e.size().x+e.min.x,h=c*e.size().z+e.min.z,u=this.getDEMHeight(new THREE.Vector3(d,0,h));u||(u=0),n[r+0]=d,n[r+1]=u,n[r+2]=h,r+=3}i.addAttribute("position",new THREE.BufferAttribute(n,3));var p=new THREE.PointCloudMaterial({size:20,color:65280}),m=new THREE.PointCloud(i,p);scene.add(m)};var nodesLoadTimes={};Potree.PointCloudOctreeGeometry=function(){Potree.PointCloudOctree.lru=Potree.PointCloudOctree.lru||new LRU,this.url=null,this.octreeDir=null,this.spacing=0,this.boundingBox=null,this.root=null,this.numNodesLoading=0,this.nodes=null,this.pointAttributes=null,this.hierarchyStepSize=-1,this.loader=null},Potree.PointCloudOctreeGeometryNode=function(e,t,o){this.id=Potree.PointCloudOctreeGeometryNode.IDCount++,this.name=e,this.index=parseInt(e.charAt(e.length-1)),this.pcoGeometry=t,this.geometry=null,this.boundingBox=o,this.boundingSphere=o.getBoundingSphere(),this.children={},this.numPoints=0,this.level=null},Potree.PointCloudOctreeGeometryNode.IDCount=0,Potree.PointCloudOctreeGeometryNode.prototype.getURL=function(){var e="",t=this.pcoGeometry.loader.version;return t.equalOrHigher("1.5")?e=this.pcoGeometry.octreeDir+"/"+this.getHierarchyPath()+"/"+this.name:t.equalOrHigher("1.4")?e=this.pcoGeometry.octreeDir+"/"+this.name:t.upTo("1.3")&&(e=this.pcoGeometry.octreeDir+"/"+this.name),e},Potree.PointCloudOctreeGeometryNode.prototype.getHierarchyPath=function(){for(var e="r/",t=this.pcoGeometry.hierarchyStepSize,o=this.name.substr(1),i=Math.floor(o.length/t),n=0;i>n;n++)e+=o.substr(n*t,t)+"/";return e=e.slice(0,-1)},Potree.PointCloudOctreeGeometryNode.prototype.addChild=function(e){this.children[e.index]=e,e.parent=this},Potree.PointCloudOctreeGeometryNode.prototype.load=function(){this.loading===!0||this.pcoGeometry.numNodesLoading>3||(this.loading=!0,this.pcoGeometry.numNodesLoading++,this.pcoGeometry.loader.version.equalOrHigher("1.5")&&this.level%this.pcoGeometry.hierarchyStepSize===0&&this.hasChildren?this.loadHierachyThenPoints():this.loadPoints())},Potree.PointCloudOctreeGeometryNode.prototype.loadPoints=function(){this.pcoGeometry.loader.load(this)},Potree.PointCloudOctreeGeometryNode.prototype.loadHierachyThenPoints=function(){var e=this,t=function(e,t){var o=(t.byteLength/5,new DataView(t)),i=[],n=o.getUint8(0),r=o.getUint32(1,!0);e.numPoints=r,i.push({children:n,numPoints:r,name:e.name});for(var s=[],a=5;i.length>0;){for(var l=i.shift(),c=1,d=0;8>d;d++){if(0!==(l.children&c)){var h=l.name+d,u=o.getUint8(a),p=o.getUint32(a+1,!0);i.push({children:u,numPoints:p,name:h}),s.push({children:u,numPoints:p,name:h}),a+=5}c=2*c}if(a===t.byteLength)break}var m={};m[e.name]=e;for(var v=e.pcoGeometry,d=0;d<s.length;d++){var E=s[d].name,r=s[d].numPoints,f=parseInt(E.charAt(E.length-1)),g=E.substring(0,E.length-1),y=m[g],b=E.length-1,T=POCLoader.createChildAABB(y.boundingBox,f),R=new Potree.PointCloudOctreeGeometryNode(E,v,T);R.level=b,R.numPoints=r,R.hasChildren=s[d].children>0,y.addChild(R),m[E]=R}e.loadPoints()};if(e.level%e.pcoGeometry.hierarchyStepSize===0){var o=e.pcoGeometry.octreeDir+"/"+e.getHierarchyPath()+"/"+e.name+".hrc",i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){var o=i.response;t(e,o)}else console.log("Failed to load file! HTTP status: "+i.status+", file: "+url)};try{i.send(null)}catch(n){console.log("fehler beim laden der punktwolke: "+n)}}},Potree.PointCloudOctreeGeometryNode.prototype.dispose=function(){this.geometry&&(this.geometry.dispose(),this.geometry=null,this.loaded=!1)},Potree.utils=function(){},Potree.utils.pathExists=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),200!==t.status?!1:!0},Potree.utils.computeTransformedBoundingBox=function(e,t){var o=[new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.max.z).applyMatrix4(t)],i=new THREE.Box3;return i.setFromPoints(o),i},Potree.utils.addCommas=function(e){e+="",x=e.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var t=/(\d+)(\d{3})/;t.test(x1);)x1=x1.replace(t,"$1,$2");return x1+x2},Potree.utils.createWorker=function(e){var t=new Blob([e],{type:"application/javascript"}),o=new Worker(URL.createObjectURL(t));return o},Potree.utils.loadSkybox=function(e){var t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e5),o=new THREE.Scene,i=".jpg",n=[e+"px"+i,e+"nx"+i,e+"py"+i,e+"ny"+i,e+"pz"+i,e+"nz"+i],r=THREE.ImageUtils.loadTextureCube(n,THREE.CubeRefractionMapping),s={uniforms:{tCube:{type:"t",value:r},tFlip:{type:"f",value:-1}},vertexShader:THREE.ShaderLib.cube.vertexShader,fragmentShader:THREE.ShaderLib.cube.fragmentShader},a=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,side:THREE.BackSide}),l=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),a);return o.add(l),{camera:t,scene:o}},Potree.utils.createGrid=function(e,t,o,i){for(var n=new THREE.LineBasicMaterial({color:i||8947848}),r=new THREE.Geometry,s=0;t>=s;s++)r.vertices.push(new THREE.Vector3(-(o*e)/2,0,s*o-o*t/2)),r.vertices.push(new THREE.Vector3(+(o*e)/2,0,s*o-o*t/2));for(var s=0;e>=s;s++)r.vertices.push(new THREE.Vector3(s*o-o*e/2,0,-(o*t)/2)),r.vertices.push(new THREE.Vector3(s*o-o*e/2,0,+(o*t)/2));var a=new THREE.Line(r,n,THREE.LinePieces);return a.receiveShadow=!0,a},Potree.utils.createBackgroundTexture=function(e,t){function o(e,t){return 1/(2*Math.PI)*Math.exp(-(e*e+t*t)/2)}var i=THREE.ImageUtils.generateDataTexture(e,t,new THREE.Color);i.magFilter=THREE.NearestFilter;for(var n=i.image.data,r=[1,1.5,1.7],s=o(0,0),a=0;e>a;a++)for(var l=0;t>l;l++){var c=2*(a/e)-1,d=2*(l/t)-1,h=a+e*l,u=o(2*c,2*d)/s,p=(Math.random()+Math.random()+Math.random())/3;p=(.5*u+.5)*p*.03,p=.4*p,n[3*h+0]=255*(u/15+.05+p)*r[0],n[3*h+1]=255*(u/15+.05+p)*r[1],n[3*h+2]=255*(u/15+.05+p)*r[2]}return i},Potree.utils.topView=function(e,t,o){if(e.position.set(0,1,0),e.rotation.set(-Math.PI/2,0,0),e.zoomTo(o,1),t.target){var i=o.boundingSphere.clone().applyMatrix4(o.matrixWorld),n=new THREE.Vector3(e.position.x,i.center.y,e.position.z);t.target.copy(n)}},Potree.utils.frontView=function(e,t,o){if(e.position.set(0,0,1),e.rotation.set(0,0,0),e.zoomTo(o,1),t.target){var i=o.boundingSphere.clone().applyMatrix4(o.matrixWorld),n=new THREE.Vector3(e.position.x,e.position.y,i.center.z);t.target.copy(n)}},Potree.utils.leftView=function(e,t,o){if(e.position.set(-1,0,0),e.rotation.set(0,-Math.PI/2,0),e.zoomTo(o,1),t.target){var i=o.boundingSphere.clone().applyMatrix4(o.matrixWorld),n=new THREE.Vector3(i.center.x,e.position.y,e.position.z);t.target.copy(n)}},Potree.utils.rightView=function(e,t,o){if(e.position.set(1,0,0),e.rotation.set(0,Math.PI/2,0),e.zoomTo(o,1),t.target){var i=o.boundingSphere.clone().applyMatrix4(o.matrixWorld),n=new THREE.Vector3(i.center.x,e.position.y,e.position.z);t.target.copy(n)}},Potree.Features=function(){var e=document.createElement("canvas").getContext("webgl");return{SHADER_INTERPOLATION:{isSupported:function(){var t=!0;return t=t&&e.getExtension("EXT_frag_depth"),t=t&&e.getParameter(e.MAX_VARYING_VECTORS)>=8}},SHADER_SPLATS:{isSupported:function(){var t=!0;return t=t&&e.getExtension("EXT_frag_depth"),t=t&&e.getExtension("OES_texture_float"),t=t&&e.getParameter(e.MAX_VARYING_VECTORS)>=8}}}}(),Potree.TextSprite=function(e){THREE.Object3D.call(this);var t=new THREE.Texture;t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter;var o=new THREE.SpriteMaterial({map:t,useScreenCoordinates:!1});this.material=o,this.sprite=new THREE.Sprite(o),this.add(this.sprite),this.borderThickness=4,this.fontface="Arial",this.fontsize=28,this.borderColor={r:0,g:0,b:0,a:1},this.backgroundColor={r:255,g:255,b:255,a:1},this.textColor={r:255,g:255,b:255,a:1},this.text="",this.setText(e)},Potree.TextSprite.prototype=new THREE.Object3D,Potree.TextSprite.prototype.setText=function(e){this.text=e,this.update()},Potree.TextSprite.prototype.setTextColor=function(e){this.textColor=e,this.update()},Potree.TextSprite.prototype.setBorderColor=function(e){this.borderColor=e,this.update()},Potree.TextSprite.prototype.setBackgroundColor=function(e){this.backgroundColor=e,this.update()},Potree.TextSprite.prototype.update=function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.font="Bold "+this.fontsize+"px "+this.fontface;var o=t.measureText(this.text),i=o.width,n=i+2*this.borderThickness,r=1.4*this.fontsize+2*this.borderThickness,e=document.createElement("canvas"),t=e.getContext("2d");t.canvas.width=n,t.canvas.height=r,t.font="Bold "+this.fontsize+"px "+this.fontface,t.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",t.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",t.lineWidth=this.borderThickness,this.roundRect(t,this.borderThickness/2,this.borderThickness/2,i+this.borderThickness,1.4*this.fontsize+this.borderThickness,6),t.strokeStyle="rgba(0, 0, 0, 1.0)",t.strokeText(this.text,this.borderThickness,this.fontsize+this.borderThickness),t.fillStyle="rgba("+this.textColor.r+","+this.textColor.g+","+this.textColor.b+","+this.textColor.a+")",t.fillText(this.text,this.borderThickness,this.fontsize+this.borderThickness);var s=new THREE.Texture(e);s.minFilter=THREE.LinearFilter,s.magFilter=THREE.LinearFilter,s.needsUpdate=!0,this.sprite.material.map=s,this.sprite.scale.set(.01*n,.01*r,1)},Potree.TextSprite.prototype.roundRect=function(e,t,o,i,n,r){e.beginPath(),e.moveTo(t+r,o),e.lineTo(t+i-r,o),e.quadraticCurveTo(t+i,o,t+i,o+r),e.lineTo(t+i,o+n-r),e.quadraticCurveTo(t+i,o+n,t+i-r,o+n),e.lineTo(t+r,o+n),e.quadraticCurveTo(t,o+n,t,o+n-r),e.lineTo(t,o+r),e.quadraticCurveTo(t,o,t+r,o),e.closePath(),e.fill(),e.stroke()},Potree.Version=function(e){this.version=e;var t=-1===e.indexOf(".")?e.length:e.indexOf(".");this.versionMajor=parseInt(e.substr(0,t)),this.versionMinor=parseInt(e.substr(t+1)),0===this.versionMinor.length&&(this.versionMinor=0)},Potree.Version.prototype.newerThan=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor?!0:this.versionMajor===t.versionMajor&&this.versionMinor>t.versionMinor?!0:!1},Potree.Version.prototype.equalOrHigher=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor?!0:this.versionMajor===t.versionMajor&&this.versionMinor>=t.versionMinor?!0:!1},Potree.Version.prototype.upTo=function(e){return!this.newerThan(e)},Potree.AngleTool=function(e,t,o){"use strict";function i(e){this.points=[],this.spheres=[],this.edges=[],this.sphereLabels=[],this.angleLabels=[],this.root=e,this.closed=!0;var t=new THREE.SphereGeometry(.4,10,10),o=new THREE.Color(16711680),i=function(){var e=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:16711680,ambient:11184810,depthTest:!1,depthWrite:!1});return e};this.add=function(e){this.points.push(e);var n=new THREE.Mesh(t,i());n.addEventListener("mousemove",m),n.addEventListener("mouseleave",v),n.addEventListener("mousedrag",E),n.addEventListener("drop",f);var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3,new THREE.Vector3),r.colors.push(o,o,o);var s=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:2});s.depthTest=!1;var a=new THREE.Line(r,s),l=new Potree.TextSprite;l.setBorderColor({r:0,g:255,b:0,a:0}),l.setBackgroundColor({r:0,g:255,b:0,a:0}),l.material.depthTest=!1,l.material.opacity=1,this.root.add(n),this.root.add(a),this.root.add(l),this.spheres.push(n),this.edges.push(a),this.angleLabels.push(l),this.setPosition(this.points.length-1,e)},this.remove=function(e){this.points.splice(e,1),this.root.remove(this.spheres[e]),this.root.remove(this.edges[e]),this.root.remove(this.angleLabels[e]),this.spheres.splice(e,1),this.edges.splice(e,1),this.angleLabels.splice(e,1),this.update()},this.removeAll=function(){for(;this.points.length>1;)this.remove(0);this.sceneRoot.visible=!1,this.update()},this.getAngleBetweenLines=function(e,t,o){var i=(new THREE.Vector3).subVectors(t,e),n=(new THREE.Vector3).subVectors(o,e);return i.angleTo(n)},this.getAngle=function(e){var t=0,o=this.points[0],i=this.points[1],n=this.points[2];return 0===e?t=this.getAngleBetweenLines(o,i,n):1===e?t=this.getAngleBetweenLines(i,o,n):2===e&&(t=this.getAngleBetweenLines(n,o,i)),t},this.setPosition=function(e,t){var o=this.points[e];o.copy(t),this.update()},this.setClosed=function(e){this.closed=e,this.update()},this.update=function(){var e,t;if(1===this.points.length)return e=this.points[0],this.spheres[0].position.copy(e),this.edges[0].visible=!1,void(this.angleLabels[0].visible=!1);var o=this.points.length-1,i=new THREE.Vector3;for(t=0;o>=t;t++){e=this.points[t];var n=this.spheres[t],r=0===t?o:t-1,s=this.edges[r],a=this.edges[t];n.position.copy(e),s.geometry.vertices[1].copy(e),s.geometry.verticesNeedUpdate=!0,s.geometry.computeBoundingSphere(),a.geometry.vertices[0].copy(e),a.geometry.verticesNeedUpdate=!0,a.geometry.computeBoundingSphere(),a.visible=t!==o||this.closed?!0:!1,i.add(e)}if(i.multiplyScalar(1/this.points.length),this.points.length>=3)for(t=0;o>=t;t++){this.angleLabels[t].visible=!0,this.angleLabels[t].setText(Potree.utils.addCommas((this.getAngle(t)*(180/Math.PI)).toFixed(1))+"°");var l=(new THREE.Vector3).addVectors(this.points[t],i).multiplyScalar(.5);this.angleLabels[t].position.copy(l)}else for(t=0;o>=t;t++)this.angleLabels[t].visible=!1}}function n(e){if(h.enabled&&void 0!==e){var t=d();if(t){var o=t.clone();if(p===u.DEFAULT&&(p=u.PICKING,h.activeMeasurement=new i),p===u.PICKING&&h.activeMeasurement&&h.activeMeasurement.points.length>2)h.measurements.push(h.activeMeasurement),h.activeMeasurement=void 0,p=u.DEFAULT,h.setEnabled(!1);else{h.activeMeasurement.add(o);var n={type:"newpoint",position:o.clone()};h.dispatchEvent(n)}}}}function r(e){if(void 0!==e){var t=h.domElement.getBoundingClientRect();h.mouse.x=(e.clientX-t.left)/h.domElement.clientWidth*2-1,h.mouse.y=2*-((e.clientY-t.top)/h.domElement.clientHeight)+1;var o;if(h.dragstart)h.dragstart.object.dispatchEvent({type:"mousedrag",event:e});else if(p===u.PICKING&&h.activeMeasurement){if(o=d()){var i=h.activeMeasurement.points.length-1;h.activeMeasurement.setPosition(i,o)}}else o=c(),o?(o.object.dispatchEvent({type:"mousemove",target:o.object,event:e}),h.hoveredElement&&h.hoveredElement!==o.object&&h.hoveredElement.dispatchEvent({type:"mouseleave",target:h.hoveredElement,event:e}),h.hoveredElement=o.object):(h.hoveredElement&&h.hoveredElement.dispatchEvent({type:"mouseleave",target:h.hoveredElement,event:e}),h.hoveredElement=null)}}function s(e){void 0!==e&&p===u.PICKING&&(h.activeMeasurement.removeAll(),h.activeMeasurement=void 0,p=u.DEFAULT,h.setEnabled(!1))}function a(e){if(1===e.which){p!==u.DEFAULT&&e.stopImmediatePropagation();var t=c();t&&(h.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:h.sceneRoot.position.clone(),mousePos:{x:h.mouse.x,y:h.mouse.y}},e.stopImmediatePropagation())}else 3===e.which&&s(e)}function l(e){h.dragstart&&(h.dragstart.object.dispatchEvent({type:"drop",event:e}),h.dragstart=null)}function c(){var e=new THREE.Vector3(h.mouse.x,h.mouse.y,.5);e.unproject(h.camera);var t=new THREE.Raycaster;t.ray.set(h.camera.position,e.sub(h.camera.position).normalize());for(var o=[],i=0;i<h.measurements.length;i++)for(var n=h.measurements[i],r=0;r<n.spheres.length;r++)o.push(n.spheres[r]);var s=t.intersectObjects(o,!0);return s.length>0?s[0]:!1}function d(){var e=new THREE.Vector3(h.mouse.x,h.mouse.y,.5);e.unproject(h.camera);var t=e.sub(h.camera.position).normalize(),o=new THREE.Ray(h.camera.position,t),i=[];h.scene.traverse(function(e){e instanceof Potree.PointCloudOctree&&i.push(e)});for(var n=null,r=null,s=0;s<i.length;s++){var a=i[s],l=a.pick(h.renderer,h.camera,o);if(l){var c=h.camera.position.distanceTo(l.position);(!n||r>c)&&(n=l,r=c)}}return n?n.position:null}var h=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0},this.accuracy=.5;var u={DEFAULT:0,PICKING:1},p=u.DEFAULT;this.activeMeasurement=null,this.measurements=[],this.sceneMeasurement=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneMeasurement.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneMeasurement.add(this.light),this.hoveredElement=null;var m=function(e){e.target.material.emissive.setHex(8947848)},v=function(e){e.target.material.emissive.setHex(0)},E=function(e){var t=d();if(t)for(var o=0;o<h.measurements.length;o++){var i=h.measurements[o],n=i.spheres.indexOf(h.dragstart.object);if(n>=0){h.measurements[o].setPosition(n,t);break}}e.event.stopImmediatePropagation()},f=function(e){};this.setEnabled=function(e){this.enabled!==e&&(this.enabled=e,e&&(p=u.PICKING,h.activeMeasurement=new i(h.sceneRoot),h.activeMeasurement.add(new THREE.Vector3(0,0,0))))},this.update=function(){var e,t,i=[];for(e=0;e<this.measurements.length;e++)i.push(this.measurements[e]);for(this.activeMeasurement&&i.push(this.activeMeasurement),e=0;e<i.length;e++){var n=i[e];for(t=0;t<n.spheres.length;t++){var r=n.spheres[t],s=h.camera.position.distanceTo(r.getWorldPosition()),a=projectedRadius(1,h.camera.fov*Math.PI/180,s,o.domElement.clientHeight),l=15/a;r.scale.set(l,l,l)}for(t=0;t<n.angleLabels.length;t++){var c=n.angleLabels[t],s=h.camera.position.distanceTo(c.getWorldPosition()),a=projectedRadius(1,h.camera.fov*Math.PI/180,s,o.domElement.clientHeight),l=70/a;c.scale.set(l,l,l)}}this.light.position.copy(this.camera.position),this.light.lookAt(this.camera.getWorldDirection().add(this.camera.position))},this.render=function(){this.update(),o.render(this.sceneMeasurement,this.camera)},this.domElement.addEventListener("click",n,!1),this.domElement.addEventListener("mousemove",r,!1),this.domElement.addEventListener("mousedown",a,!1),this.domElement.addEventListener("mouseup",l,!0)},Potree.AngleTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.Measure=function(){var e=this;THREE.Object3D.call(this),this.points=[],this._showDistances=!0,this._showArea=!0,this._closed=!0,this.spheres=[],this.edges=[],this.sphereLabels=[],this.edgeLabels=[],this.areaLabel=new Potree.TextSprite(""),this.areaLabel.setBorderColor({r:0,g:255,b:0,a:0}),this.areaLabel.setBackgroundColor({r:0,g:255,b:0,a:0}),this.areaLabel.setTextColor({r:180,g:220,b:180,a:1}),this.areaLabel.material.depthTest=!1,this.areaLabel.material.opacity=1,this.add(this.areaLabel);var t=new THREE.SphereGeometry(.4,10,10);this.color=new THREE.Color(16711680);var o=function(){var t=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:e.color,ambient:11184810,depthTest:!1,depthWrite:!1});return t},i=function(e){e.target.material.emissive.setHex(8947848)},n=function(e){e.target.material.emissive.setHex(0)},r=function(t){var o=t.tool,i=(o.dragstart,o.mouse,o.getMousePointCloudIntersection());if(i){var n=e.spheres.indexOf(o.dragstart.object);e.setPosition(n,i)}},s=function(){};this.addMarker=function(e){this.points.push(e);var a=new THREE.Mesh(t,o());a.addEventListener("move",i),a.addEventListener("leave",n),a.addEventListener("drag",r),a.addEventListener("drop",s),this.add(a),this.spheres.push(a);var l=new THREE.Geometry;l.vertices.push(new THREE.Vector3,new THREE.Vector3),l.colors.push(this.color,this.color,this.color);var c=new THREE.LineBasicMaterial({linewidth:1});c.depthTest=!1;var d=new THREE.Line(l,c);d.visible=!0,this.add(d),this.edges.push(d);var h=new Potree.TextSprite(0);h.setBorderColor({r:0,g:255,b:0,a:0}),h.setBackgroundColor({r:0,g:255,b:0,a:0}),h.material.depthTest=!1,h.visible=!1,this.edgeLabels.push(h),this.add(h),this.setPosition(this.points.length-1,e)},this.removeMarker=function(e){this.points.splice(e,1),this.remove(this.spheres[e]);var t=0==e?0:e-1;this.remove(this.edges[t]),this.edges.splice(t,1),this.remove(this.edgeLabels[t]),this.edgeLabels.splice(t,1),this.spheres.splice(e,1),this.update()},this.setPosition=function(e,t){var o=this.points[e];o.copy(t),this.update()},this.getArea=function(){for(var e=0,t=this.points.length-1,o=0;o<this.points.length;o++){var i=this.points[o],n=this.points[t];e+=(n.x+i.x)*(i.z-n.z),t=o}return Math.abs(e/2)},this.update=function(){if(0!==this.points.length){if(1===this.points.length){var t=this.points[0];return void this.spheres[0].position.copy(t)}for(var o=this.points.length-1,i=new THREE.Vector3,n=0;o>=n;n++){var t=this.points[n];i.add(t)}i.divideScalar(this.points.length);for(var n=0;o>=n;n++){var r=n,s=n+1>o?0:n+1,t=this.points[r],a=this.points[s],l=this.spheres[r];l.position.copy(t),l.material.color=e.color;var c=this.edges[r];c.material.color=this.color,c.geometry.vertices[0].copy(t),c.geometry.vertices[1].copy(a),c.geometry.verticesNeedUpdate=!0,c.geometry.computeBoundingSphere(),c.visible=o>r||this.closed;var d=this.edgeLabels[n],h=(new THREE.Vector3).add(t);h.add(a),h=h.multiplyScalar(.5);var u=t.distanceTo(a);d.position.copy(h),d.setText(u.toFixed(2)),d.visible=this.showDistances&&(o>r||this.closed)&&this.points.length>=2&&u>0}this.areaLabel.position.copy(i),this.areaLabel.visible=this.showArea&&this.points.length>=3;var p=Potree.utils.addCommas(this.getArea().toFixed(1))+"²";this.areaLabel.setText(p)}},this.raycast=function(e,t){for(var o=0;o<this.points.length;o++){var i=this.spheres[o];i.raycast(e,t)}for(var o=0;o<t.length;o++){var n=t[o];n.distance=e.ray.origin.distanceTo(n.point)}t.sort(function(e,t){return e.distance-t.distance})}},Potree.Measure.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.Measure.prototype,"showArea",{get:function(){return this._showArea},set:function(e){this._showArea=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"closed",{get:function(){return this._closed},set:function(e){this._closed=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"showDistances",{get:function(){return this._showDistances},set:function(e){this._showDistances=e,this.update()}}),Potree.MeasuringTool=function(e,t,o){function i(e){if(u===h.INSERT){var t=d.getMousePointCloudIntersection();if(t){var o=t.clone();d.activeMeasurement.addMarker(o);var e={type:"newpoint",position:o.clone()};d.dispatchEvent(e)}}}function n(e){var t=d.domElement.getBoundingClientRect();if(d.mouse.x=(e.clientX-t.left)/d.domElement.clientWidth*2-1,d.mouse.y=2*-((e.clientY-t.top)/d.domElement.clientHeight)+1,d.dragstart){var o={type:"drag",event:e,tool:d};d.dragstart.object.dispatchEvent(o)}else if(u==h.INSERT&&d.activeMeasurement){var i=d.getMousePointCloudIntersection();if(i){var n=d.activeMeasurement.points.length-1;d.activeMeasurement.setPosition(n,i)}}else{var i=c();i?(i.object.dispatchEvent({type:"move",target:i.object,event:e}),d.hoveredElement&&d.hoveredElement!==i.object&&d.hoveredElement.dispatchEvent({type:"leave",target:d.hoveredElement,event:e}),d.hoveredElement=i.object):(d.hoveredElement&&d.hoveredElement.dispatchEvent({type:"leave",target:d.hoveredElement,event:e}),d.hoveredElement=null)}}function r(){u==h.INSERT&&d.finishInsertion()}function s(e){if(1===e.which){u!==h.DEFAULT&&e.stopImmediatePropagation();var t=c();t&&(d.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:d.sceneRoot.position.clone(),mousePos:{x:d.mouse.x,y:d.mouse.y}},e.stopImmediatePropagation())}else 3===e.which&&r(e)}function a(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),d.activeMeasurement&&u===h.INSERT&&(d.activeMeasurement.removeMarker(d.activeMeasurement.points.length-1),d.finishInsertion())}function l(e){d.dragstart&&(d.dragstart.object.dispatchEvent({type:"drop",event:e}),d.dragstart=null)}function c(){var e=new THREE.Vector3(d.mouse.x,d.mouse.y,.5);e.unproject(d.camera);var t=new THREE.Raycaster;t.ray.set(d.camera.position,e.sub(d.camera.position).normalize());for(var o=[],i=0;i<d.measurements.length;i++)for(var n=d.measurements[i],r=0;r<n.spheres.length;r++)o.push(n.spheres[r]);var s=t.intersectObjects(o,!0);return s.length>0?s[0]:!1}var d=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0};var h={DEFAULT:0,INSERT:1},u=h.DEFAULT;this.activeMeasurement,this.measurements=[],this.sceneMeasurement=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneMeasurement.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneMeasurement.add(this.light),this.hoveredElement=null,this.getState=function(){return u},this.getMousePointCloudIntersection=function(){var e=new THREE.Vector3(d.mouse.x,d.mouse.y,.5);e.unproject(d.camera);var t=e.sub(d.camera.position).normalize(),o=new THREE.Ray(d.camera.position,t),i=[];d.scene.traverse(function(e){e instanceof Potree.PointCloudOctree&&i.push(e)});for(var n=null,r=null,s=0;s<i.length;s++){var a=i[s],l=a.pick(d.renderer,d.camera,o);if(l){var c=d.camera.position.distanceTo(l.position);(!n||r>c)&&(n=l,r=c)}}return n?n.position:null},this.startInsertion=function(e){u=h.INSERT;var e=e||{},t=e.showDistances||!0,o=e.showArea||!1,i=e.closed||!1;this.activeMeasurement=new Potree.Measure,this.activeMeasurement.showDistances=t,this.activeMeasurement.showArea=o,this.activeMeasurement.closed=i,this.sceneMeasurement.add(this.activeMeasurement),this.measurements.push(this.activeMeasurement),this.activeMeasurement.addMarker(new THREE.Vector3(0,0,0))},this.finishInsertion=function(){this.activeMeasurement.removeMarker(this.activeMeasurement.points.length-1),this.activeMeasurement=null,u=h.DEFAULT},this.addMeasurement=function(e){this.sceneMeasurement.add(e),this.measurements.push(e)},this.removeMeasurement=function(e){this.sceneMeasurement.remove(e);var t=this.measurements.indexOf(e);t>=0&&this.measurements.splice(t,1)},this.update=function(){for(var e=[],t=0;t<this.measurements.length;t++)e.push(this.measurements[t]);this.activeMeasurement&&e.push(this.activeMeasurement);for(var t=0;t<e.length;t++){for(var i=e[t],n=0;n<i.spheres.length;n++){var r=i.spheres[n],s=d.camera.position.distanceTo(r.getWorldPosition()),a=projectedRadius(1,d.camera.fov*Math.PI/180,s,o.domElement.clientHeight),l=15/a;r.scale.set(l,l,l)}for(var n=0;n<i.edgeLabels.length;n++){var c=i.edgeLabels[n],s=d.camera.position.distanceTo(c.getWorldPosition()),a=projectedRadius(1,d.camera.fov*Math.PI/180,s,o.domElement.clientHeight),l=70/a;c.scale.set(l,l,l)}var s=d.camera.position.distanceTo(i.areaLabel.getWorldPosition()),a=projectedRadius(1,d.camera.fov*Math.PI/180,s,o.domElement.clientHeight),l=80/a;i.areaLabel.scale.set(l,l,l)}this.light.position.copy(this.camera.position),this.light.lookAt(this.camera.getWorldDirection().add(this.camera.position))},this.render=function(){this.update(),o.render(this.sceneMeasurement,this.camera)},this.domElement.addEventListener("click",i,!1),this.domElement.addEventListener("dblclick",a,!1),this.domElement.addEventListener("mousemove",n,!1),this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mouseup",l,!0)},Potree.MeasuringTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.HeightProfile=function(){var e=this;THREE.Object3D.call(this),this.points=[],this.spheres=[],this.edges=[],this.boxes=[],this.width=1,this.height=20,this._modifiable=!0;var t=new THREE.SphereGeometry(.4,10,10),o=new THREE.Color(16711680),i=function(){var e=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:16711680,ambient:11184810,depthTest:!1,depthWrite:!1});return e},n=function(e){e.target.material.emissive.setHex(8947848)},r=function(e){e.target.material.emissive.setHex(0)},s=function(t){var o=t.tool,i=o.dragstart,n=o.mouse;if(t.event.ctrlKey){var r=new THREE.Vector3(i.mousePos.x,i.mousePos.y,0),s=new THREE.Vector3(n.x,n.y,0),a=i.widthStart,l=1-10*(r.y-s.y);
l=Math.max(.01,l),a&&e.setWidth(a*l)}else{var c=o.getMousePointCloudIntersection();if(c){var d=e.spheres.indexOf(o.dragstart.object);e.setPosition(d,c)}}t.event.stopImmediatePropagation()},a=function(){};this.addMarker=function(e){this.points.push(e);var l=new THREE.Mesh(t,i());if(l.addEventListener("mousemove",n),l.addEventListener("mouseleave",r),l.addEventListener("mousedrag",s),l.addEventListener("drop",a),this.add(l),this.spheres.push(l),this.points.length>1){var c=new THREE.Geometry;c.vertices.push(new THREE.Vector3,new THREE.Vector3),c.colors.push(o,o,o);var d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:2,transparent:!0,opacity:.4});d.depthTest=!1;var h=new THREE.Line(c,d);h.visible=!1,this.add(h),this.edges.push(h);var u=new THREE.BoxGeometry(1,1,1),p=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.2}),m=new THREE.Mesh(u,p);m.visible=!1,this.add(m),this.boxes.push(m)}this.setPosition(this.points.length-1,e);var v={type:"marker_added",profile:this};this.dispatchEvent(v)},this.removeMarker=function(e){this.points.splice(e,1),this.remove(this.spheres[e]);var t=0==e?0:e-1;this.remove(this.edges[t]),this.edges.splice(t,1),this.remove(this.boxes[t]),this.boxes.splice(t,1),this.spheres.splice(e,1),this.update();var o={type:"marker_removed",profile:this};this.dispatchEvent(o)},this.getArea=function(){for(var e=0,t=this.points.length-1,o=0;o<this.points.length;o++){var i=this.points[o],n=this.points[t];e+=(n.x+i.x)*(i.z-n.z),t=o}return Math.abs(e/2)},this.setPosition=function(e,t){var o=this.points[e];o.copy(t),this.update()},this.setWidth=function(e){this.width=e,this.update()},this.update=function(){if(0!==this.points.length){if(1===this.points.length){var e=this.points[0];return void this.spheres[0].position.copy(e)}for(var t=this.points[0].clone(),o=this.points[0].clone(),i=new THREE.Vector3,n=this.points.length-1,r=0;n>=r;r++){{var e=this.points[r],s=this.spheres[r],a=0===r?n:r-1,l=r===n?0:r+1,c=this.points[a],d=this.points[l],h=this.edges[a],u=this.edges[r],p=this.boxes[a];this.boxes[r],e.distanceTo(c),e.distanceTo(d),(new THREE.Vector3).addVectors(c,e).multiplyScalar(.5),(new THREE.Vector3).addVectors(e,d).multiplyScalar(.5)}if(s.position.copy(e),s.visible=this._modifiable?!0:!1,h&&(h.geometry.vertices[1].copy(e),h.geometry.verticesNeedUpdate=!0,h.geometry.computeBoundingSphere()),u&&(u.geometry.vertices[0].copy(e),u.geometry.verticesNeedUpdate=!0,u.geometry.computeBoundingSphere()),p){var m=c,v=e,E=m.clone().setY(0).distanceTo(v.clone().setY(0));p.scale.set(E,this.height,this.width);var f=(new THREE.Vector3).addVectors(m,v).multiplyScalar(.5),g=(new THREE.Vector3).subVectors(v,m),y=new THREE.Vector3(g.z,0,-g.x);p.position.set(0,0,0),p.lookAt(y),p.position.copy(f)}i.add(e),t.min(e),o.max(e)}i.multiplyScalar(1/this.points.length);for(var r=0;r<this.boxes.length;r++){var b=this.boxes[r];b.position.y=t.y+(o.y-t.y)/2,b.scale.y=1e6}}},this.raycast=function(e,t){for(var o=0;o<this.points.length;o++){var i=this.spheres[o];i.raycast(e,t)}for(var o=0;o<t.length;o++){var n=t[o];n.distance=e.ray.origin.distanceTo(n.point)}t.sort(function(e,t){return e.distance-t.distance})}},Potree.HeightProfile.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.HeightProfile.prototype,"modifiable",{get:function(){return this.modifiable},set:function(e){this._modifiable=e,this.update()}}),Potree.ProfileTool=function(e,t,o){function i(e){if(u===h.INSERT){var t=d.getMousePointCloudIntersection();if(t){var o=t.clone();d.activeProfile.addMarker(o);var e={type:"newpoint",position:o.clone()};d.dispatchEvent(e)}}}function n(e){var t=d.domElement.getBoundingClientRect();if(d.mouse.x=(e.clientX-t.left)/d.domElement.clientWidth*2-1,d.mouse.y=2*-((e.clientY-t.top)/d.domElement.clientHeight)+1,d.dragstart){var o={type:"mousedrag",event:e,tool:d};d.dragstart.object.dispatchEvent(o)}else if(u==h.INSERT&&d.activeProfile){var i=d.getMousePointCloudIntersection();if(i){var n=d.activeProfile.points.length-1;d.activeProfile.setPosition(n,i)}}else{var i=c();i?(i.object.dispatchEvent({type:"mousemove",target:i.object,event:e}),d.hoveredElement&&d.hoveredElement!==i.object&&d.hoveredElement.dispatchEvent({type:"mouseleave",target:d.hoveredElement,event:e}),d.hoveredElement=i.object):(d.hoveredElement&&d.hoveredElement.dispatchEvent({type:"mouseleave",target:d.hoveredElement,event:e}),d.hoveredElement=null)}}function r(){u==h.INSERT&&d.finishInsertion()}function s(e){if(u!==h.DEFAULT&&e.stopImmediatePropagation(),1===e.which){var t=c();if(t){for(var o=null,i=0;i<d.profiles.length;i++)for(var n=d.profiles[i],s=0;s<n.spheres.length;s++){var a=n.spheres[s];a===t.object&&(o=n.width)}d.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:d.sceneRoot.position.clone(),mousePos:{x:d.mouse.x,y:d.mouse.y},widthStart:o},e.stopImmediatePropagation()}}else 3===e.which&&r(e)}function a(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),d.activeProfile&&u===h.INSERT&&(d.activeProfile.removeMarker(d.activeProfile.points.length-1),d.finishInsertion())}function l(e){d.dragstart&&(d.dragstart.object.dispatchEvent({type:"drop",event:e}),d.dragstart=null)}function c(){var e=new THREE.Vector3(d.mouse.x,d.mouse.y,.5);e.unproject(d.camera);var t=new THREE.Raycaster;t.ray.set(d.camera.position,e.sub(d.camera.position).normalize());var o=t.intersectObjects(d.profiles);return o.length>0?o[0]:!1}var d=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0};{var h={DEFAULT:0,INSERT:1},u=h.DEFAULT;new THREE.SphereGeometry(.4,10,10)}this.activeProfile,this.profiles=[],this.sceneProfile=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneProfile.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneProfile.add(this.light),this.hoveredElement=null,this.getMousePointCloudIntersection=function(){var e=new THREE.Vector3(d.mouse.x,d.mouse.y,.5);e.unproject(d.camera);var t=e.sub(d.camera.position).normalize(),o=new THREE.Ray(d.camera.position,t),i=[];d.scene.traverse(function(e){e instanceof Potree.PointCloudOctree&&i.push(e)});for(var n=null,r=null,s=0;s<i.length;s++){var a=i[s],l=a.pick(d.renderer,d.camera,o);if(l){var c=d.camera.position.distanceTo(l.position);(!n||r>c)&&(n=l,r=c)}}return n?n.position:null},this.startInsertion=function(e){u=h.INSERT;var e=e||{},t=e.clip||!1,o=e.width||1;return this.activeProfile=new Potree.HeightProfile,this.activeProfile.clip=t,this.activeProfile.setWidth(o),this.addProfile(this.activeProfile),this.activeProfile.addMarker(new THREE.Vector3(0,0,0)),this.activeProfile},this.finishInsertion=function(){this.activeProfile.removeMarker(this.activeProfile.points.length-1),this.activeProfile=null,u=h.DEFAULT},this.addProfile=function(e){this.profiles.push(e),this.sceneProfile.add(e),e.update(),this.dispatchEvent({type:"profile_added",profile:e}),e.addEventListener("marker_added",function(e){d.dispatchEvent(e)}),e.addEventListener("marker_removed",function(e){d.dispatchEvent(e)})},this.removeProfile=function(e){this.sceneProfile.remove(e);var t=this.profiles.indexOf(e);t>=0&&this.profiles.splice(t,1),this.dispatchEvent({type:"profile_removed",profile:e})},this.update=function(){for(var e=0;e<this.profiles.length;e++)for(var t=this.profiles[e],i=0;i<t.spheres.length;i++){var n=t.spheres[i],r=d.camera.position.distanceTo(n.getWorldPosition()),s=projectedRadius(1,d.camera.fov*Math.PI/180,r,o.domElement.clientHeight),a=15/s;n.scale.set(a,a,a)}this.light.position.copy(this.camera.position),this.light.lookAt(this.camera.getWorldDirection().add(this.camera.position))},this.render=function(){this.update(),o.render(this.sceneProfile,this.camera)},this.domElement.addEventListener("click",i,!1),this.domElement.addEventListener("dblclick",a,!1),this.domElement.addEventListener("mousemove",n,!1),this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mouseup",l,!0)},Potree.ProfileTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.TransformationTool=function(e,t,o){function i(e){if(a.mouse.x=e.clientX/a.domElement.clientWidth*2-1,a.mouse.y=2*-(e.clientY/a.domElement.clientHeight)+1,a.dragstart)a.dragstart.object.dispatchEvent({type:"mousedrag",event:e});else{var t=s();if(t){var o=t.object;o.dispatchEvent({type:"mousemove",event:e}),a.hoveredElement&&a.hoveredElement!==o&&a.hoveredElement.dispatchEvent({type:"mouseleave",event:e}),a.hoveredElement=o}else a.hoveredElement&&a.hoveredElement.dispatchEvent({type:"mouseleave",event:e}),a.hoveredElement=null}}function n(e){if(1===e.which){var t=s();if(t){for(var o=[],i=[],n=0;n<a.targets.length;n++)o.push(a.targets[n].scale.clone()),i.push(a.targets[n].rotation.clone());a.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:a.sceneRoot.position.clone(),mousePos:{x:a.mouse.x,y:a.mouse.y},scales:o,rotations:i},e.stopImmediatePropagation()}}else 3===e.which&&a.setTargets([])}function r(e){a.dragstart&&(a.dragstart.object.dispatchEvent({type:"drop",event:e}),a.dragstart=null)}function s(){if(0!==a.targets.length){var e=new THREE.Vector3(a.mouse.x,a.mouse.y,.5);e.unproject(a.camera);var t=new THREE.Raycaster;t.ray.set(a.camera.position,e.sub(a.camera.position).normalize()),t.linePrecision=.2;var o=[];a.translationNode.visible?o.push(a.translationNode):a.scaleNode.visible?o.push(a.scaleNode):a.rotationNode.visible&&(o.push(a.rotationNode),o.push(a.sceneRotation));for(var i=t.intersectObjects(o,!0),n=0;n<i.length;n++){var r=i[n];r.distance=a.camera.position.distanceTo(r.point)}return i.sort(function(e,t){return e.distance-t.distance}),i.length>0?i[0]:!1}}var a=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0},this.dragstart=null,this.sceneTransformation=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneTransformation.add(this.sceneRoot),this.sceneRotation=new THREE.Scene,this.translationNode=new THREE.Object3D,this.rotationNode=new THREE.Object3D,this.scaleNode=new THREE.Object3D,this.sceneRoot.add(this.translationNode),this.sceneRoot.add(this.rotationNode),this.sceneRoot.add(this.scaleNode),this.sceneRoot.visible=!1,this.hoveredElement=null,this.STATE={DEFAULT:0,TRANSLATE_X:1,TRANSLATE_Y:2,TRANSLATE_Z:3,SCALE_X:1,SCALE_Y:2,SCALE_Z:3},this.parts={ARROW_X:{name:"arrow_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.TRANSLATE_X},ARROW_Z:{name:"arrow_z",object:void 0,color:new THREE.Color(255),state:this.STATE.TRANSLATE_Z},ARROW_Y:{name:"arrow_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.TRANSLATE_Y},SCALE_X:{name:"scale_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.SCALE_X},SCALE_Z:{name:"scale_z",object:void 0,color:new THREE.Color(255),state:this.STATE.SCALE_Z},SCALE_Y:{name:"scale_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.SCALE_Y},ROTATE_X:{name:"rotate_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.ROTATE_X},ROTATE_Z:{name:"rotate_z",object:void 0,color:new THREE.Color(255),state:this.STATE.ROTATE_Z},ROTATE_Y:{name:"rotate_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.ROTATE_Y}},this.buildTranslationNode=function(){var e=a.createArrow(a.parts.ARROW_X,a.parts.ARROW_X.color);e.rotation.z=-Math.PI/2;var t=a.createArrow(a.parts.ARROW_Y,a.parts.ARROW_Y.color),o=a.createArrow(a.parts.ARROW_Z,a.parts.ARROW_Z.color);o.rotation.x=-Math.PI/2,this.translationNode.add(e),this.translationNode.add(t),this.translationNode.add(o)},this.buildScaleNode=function(){var e=this.createScaleHandle(a.parts.SCALE_X,16711680);e.rotation.z=-Math.PI/2;var t=this.createScaleHandle(a.parts.SCALE_Y,65280),o=this.createScaleHandle(a.parts.SCALE_Z,255);o.rotation.x=-Math.PI/2,this.scaleNode.add(e),this.scaleNode.add(t),this.scaleNode.add(o)},this.buildRotationNode=function(){var e=this.createRotationCircle(a.parts.ROTATE_X,16711680);e.rotation.y=-Math.PI/2;var t=this.createRotationCircle(a.parts.ROTATE_Y,65280),o=this.createRotationCircle(a.parts.ROTATE_Z,255);t.rotation.x=-Math.PI/2,this.rotationNode.add(e),this.rotationNode.add(t),this.rotationNode.add(o);var i=new THREE.SphereGeometry(2.9,24,24),n=new THREE.Mesh(i,new THREE.MeshBasicMaterial({color:11184810,transparent:!0,opacity:.4}));this.sceneRotation.add(n);var r=function(){n.material.color.setHex(5592405)},s=function(){n.material.color.setHex(11184810)},l=function(e){e.event.stopImmediatePropagation();for(var t=new THREE.Vector3(a.dragstart.mousePos.x,a.dragstart.mousePos.y,.1),o=new THREE.Vector3(a.mouse.x,a.mouse.y,.1),i=(new THREE.Vector3).subVectors(o,t),n=t.clone().unproject(a.camera),r=o.clone().unproject(a.camera),s=(new THREE.Vector3).subVectors(r,n),l=s.clone().normalize(),c=(new THREE.Vector3).subVectors(a.camera.position,n).normalize(),d=c.clone().cross(l),h=6*i.length(),u=0;u<a.targets.length;u++){var p=a.targets[u],m=a.dragstart.rotations[u];p.rotation.copy(m);var v=new THREE.Quaternion;v.setFromAxisAngle(d,h),p.quaternion.multiplyQuaternions(v,p.quaternion)}},c=function(){};n.addEventListener("mousemove",r),n.addEventListener("mouseleave",s),n.addEventListener("mousedrag",l),n.addEventListener("drop",c)},this.createBox=function(e){var t=new THREE.BoxGeometry(1,1,1),o=new THREE.MeshBasicMaterial({color:e,transparent:!0,opacity:.5}),i=new THREE.Mesh(t,o);return i};this.createRotationCircle=function(e,t){for(var o=[],i=128,n=0;i>=n;n++){var r=2*Math.PI*n/i,s=3*Math.cos(r),l=3*Math.sin(r);o.push(new THREE.Vector3(s,l,0))}for(var c=new THREE.Geometry,n=0;n<o.length;n++)c.vertices.push(o[n]);var d=new THREE.LineBasicMaterial({color:t}),h=new THREE.Line(c,d);h.mode=THREE.LineStrip,h.scale.set(1,1,1);var u=function(){d.color.setRGB(1,1,0)},p=function(){d.color.setHex(t)},m=function(t){t.event.stopImmediatePropagation();var o=new THREE.Vector3;e===a.parts.ROTATE_X?o.x=1:e===a.parts.ROTATE_Y?o.y=1:e===a.parts.ROTATE_Z&&(o.z=-1);var i=a.dragstart.sceneClickPos.clone(),n=a.sceneRoot.position.clone(),r=i.clone().sub(n).normalize(),s=i.clone().project(a.camera),l=n.clone().project(a.camera),c=s.clone().sub(l).normalize(),d=(new THREE.Vector3(c.y,c.x,0),new THREE.Vector3(a.dragstart.mousePos.x,a.dragstart.mousePos.y,0),new THREE.Vector3(a.mouse.x,a.mouse.y,0)),h=(new THREE.Plane).setFromNormalAndCoplanarPoint(o,a.sceneRoot.position),u=a.camera.position,p=(new THREE.Vector3(0,0,-1).applyQuaternion(a.camera.quaternion),new THREE.Vector3(d.x,d.y,.5).unproject(a.camera).sub(a.camera.position).normalize()),m=new THREE.Ray(u,p),v=m.intersectPlane(h);if(v){sceneTargetNormal=v.clone().sub(n).normalize();var E,f;e===a.parts.ROTATE_X?(E=2*Math.PI+Math.atan2(r.y,-r.z),f=4*Math.PI+Math.atan2(sceneTargetNormal.y,-sceneTargetNormal.z)):e===a.parts.ROTATE_Y?(E=2*Math.PI+Math.atan2(-r.z,r.x),f=4*Math.PI+Math.atan2(-sceneTargetNormal.z,sceneTargetNormal.x)):e===a.parts.ROTATE_Z&&(E=2*Math.PI+Math.atan2(r.x,r.y),f=4*Math.PI+Math.atan2(sceneTargetNormal.x,sceneTargetNormal.y));for(var g=f-E,y=0;y<a.targets.length;y++){var b=a.targets[y],T=a.dragstart.rotations[y];b.rotation.copy(T);var R=new THREE.Quaternion;R.setFromAxisAngle(o,g),b.quaternion.multiplyQuaternions(R,b.quaternion)}}},v=function(){};return h.addEventListener("mousemove",u),h.addEventListener("mouseleave",p),h.addEventListener("mousedrag",m),h.addEventListener("drop",v),h},this.createScaleHandle=function(e,t){var o=new THREE.BoxGeometry(1,1,1),i=new THREE.MeshBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),n=new THREE.Mesh(o,i);n.scale.set(.3,.3,.3),n.position.set(0,3,0);var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(0,0,0)),r.vertices.push(new THREE.Vector3(0,3,0));var s=new THREE.LineBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),l=new THREE.Line(r,s),c=new THREE.Object3D;c.add(n),c.add(l),c.partID=e;var d=function(){s.color.setRGB(1,1,0),i.color.setRGB(1,1,0)},h=function(){s.color.setHex(t),i.color.setHex(t)},u=function(t){var o=new THREE.Vector3;e===a.parts.SCALE_X?o.x=1:e===a.parts.SCALE_Y?o.y=1:e===a.parts.SCALE_Z&&(o.z=-1);var i=a.dragstart.sceneClickPos.clone();i.multiply(o),i.z*=-1;var n=a.dragstart.sceneStartPos.clone().project(a.camera),r=a.dragstart.sceneStartPos.clone().add(o).project(a.camera),s=n.clone(),l=r.clone().sub(n);l.normalize();var c=new THREE.Vector3(a.dragstart.mousePos.x,a.dragstart.mousePos.y,0),d=new THREE.Vector3(a.mouse.x,a.mouse.y,0),h=(new THREE.Vector3).subVectors(d,c).dot(l),u=l.clone().multiplyScalar(h).add(s);u.unproject(a.camera);var p=a.sceneRoot.position.clone().sub(u);p.multiply(new THREE.Vector3(-1,-1,1)).addScalar(1);for(var m=0;m<a.targets.length;m++){var v=a.targets[m],E=a.dragstart.scales[m];v.scale.copy(E).add(p),v.scale.x=Math.max(v.scale.x,.01),v.scale.y=Math.max(v.scale.y,.01),v.scale.z=Math.max(v.scale.z,.01)}t.event.stopImmediatePropagation()},p=function(){i.color.set(t)};return n.addEventListener("mousemove",d),n.addEventListener("mouseleave",h),n.addEventListener("mousedrag",u),n.addEventListener("drop",p),l.addEventListener("mousemove",d),l.addEventListener("mouseleave",h),l.addEventListener("mousedrag",u),l.addEventListener("drop",p),c},this.createArrow=function(e,t){var o=new THREE.MeshBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0)),i.vertices.push(new THREE.Vector3(0,3,0));var n=new THREE.LineBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),r=new THREE.Line(i,n),s=new THREE.CylinderGeometry(0,.2,.5,10,1,!1),l=o,c=new THREE.Mesh(s,l);c.position.y=3;var d=new THREE.Object3D;d.add(r),d.add(c),d.partID=e,d.material=o;var h=function(){l.color.setRGB(1,1,0),n.color.setRGB(1,1,0)},u=function(){l.color.set(t),n.color.set(t)},p=function(t){var o=new THREE.Vector3;e===a.parts.ARROW_X?o.x=1:e===a.parts.ARROW_Y?o.y=1:e===a.parts.ARROW_Z&&(o.z=-1);var i=a.dragstart.sceneClickPos.clone();i.multiply(o),i.z*=-1;var n=a.dragstart.sceneStartPos.clone().project(a.camera),r=a.dragstart.sceneStartPos.clone().add(o).project(a.camera),s=n.clone(),l=r.clone().sub(n);l.normalize();var c=new THREE.Vector3(a.dragstart.mousePos.x,a.dragstart.mousePos.y,0),d=new THREE.Vector3(a.mouse.x,a.mouse.y,0),h=(new THREE.Vector3).subVectors(d,c).dot(l),u=l.clone().multiplyScalar(h).add(s);u.unproject(a.camera);{var p=a.sceneRoot.position.clone();i.clone().sub(a.dragstart.sceneStartPos)}a.sceneRoot.position.copy(u),p.sub(a.sceneRoot.position);for(var m=0;m<a.targets.length;m++){var v=a.targets[m];v.position.sub(p)}t.event.stopImmediatePropagation()},m=function(){n.color.set(t)};return r.addEventListener("mousemove",h),c.addEventListener("mousemove",h),r.addEventListener("mouseleave",u),c.addEventListener("mouseleave",u),r.addEventListener("mousedrag",p),c.addEventListener("mousedrag",p),r.addEventListener("drop",m),c.addEventListener("drop",m),d},this.setTargets=function(e){if(a.targets=e,0===a.targets.length)return this.sceneRoot.visible=!1,void(this.sceneRotation.visible=!1);this.sceneRoot.visible=!0;var t,o=e[0];if(t=o.geometry&&o.geometry.boundingBox?o.geometry.boundingBox:o.boundingBox){var i=t.clone().applyMatrix4(o.matrixWorld).center();a.sceneRoot.position.copy(i)}},this.update=function(){var e=this.sceneRoot,o=e.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),i=(new THREE.Vector4(o.x,o.y,o.z).applyMatrix4(t.projectionMatrix),Math.abs(o.z/20));e.scale.set(i,i,i),this.targets&&1===this.targets.length&&this.scaleNode.rotation.copy(this.targets[0].rotation),this.sceneRotation.scale.set(i,i,i)},this.render=function(){this.update(),this.sceneRotation.position.copy(this.sceneRoot.position),this.sceneRotation.visible=this.rotationNode.visible&&this.sceneRoot.visible,o.render(this.sceneRotation,this.camera),o.render(this.sceneTransformation,this.camera)},this.translate=function(){this.translationNode.visible=!0,this.scaleNode.visible=!1,this.rotationNode.visible=!1},this.scale=function(){this.translationNode.visible=!1,this.scaleNode.visible=!0,this.rotationNode.visible=!1},this.rotate=function(){this.translationNode.visible=!1,this.scaleNode.visible=!1,this.rotationNode.visible=!0},this.buildTranslationNode(),this.buildScaleNode(),this.buildRotationNode(),this.rotate(),this.setTargets([]),this.domElement.addEventListener("mousemove",i,!0),this.domElement.addEventListener("mousedown",n,!0),this.domElement.addEventListener("mouseup",r,!0)},Potree.Volume=function(e){THREE.Object3D.call(this),e=e||{},this._clip=e.clip||!1,this._modifiable=e.modifiable||!0;var t=new THREE.BoxGeometry(1,1,1);t.computeBoundingBox();var o=new THREE.Geometry;o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),this.dimension=new THREE.Vector3(1,1,1);var i=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.3});this.box=new THREE.Mesh(t,i),this.box.geometry.computeBoundingBox(),this.boundingBox=this.box.geometry.boundingBox,this.add(this.box),this.frame=new THREE.Line(o,new THREE.LineBasicMaterial({color:0})),this.frame.mode=THREE.LinePieces,this.add(this.frame),this.label=new Potree.TextSprite("0"),this.label.setBorderColor({r:0,g:255,b:0,a:0}),this.label.setBackgroundColor({r:0,g:255,b:0,a:0}),this.label.material.depthTest=!1,this.label.position.y-=.5,this.add(this.label);var n=this;this.label.updateMatrixWorld=function(){var e=new THREE.Vector3;e.setFromMatrixPosition(n.matrixWorld),n.label.position.copy(e),n.label.updateMatrix(),n.label.matrixWorld.copy(n.label.matrix),n.label.matrixWorldNeedsUpdate=!1;for(var t=0,o=n.label.children.length;o>t;t++)n.label.children[t].updateMatrixWorld(!0)},this.setDimension=function(e,t,o){this.dimension.set(e,t,o),this.box.scale.set(e,t,o),this.frame.scale.set(e,t,o)},this.volume=function(){return Math.abs(this.scale.x*this.scale.y*this.scale.z)},this.update=function(){this.boundingBox=this.box.geometry.boundingBox,this._clip?(this.box.visible=!1,this.label.visible=!1):(this.box.visible=!0,this.label.visible=!0)},this.raycast=function(e,t){var o=[];if(this.box.raycast(e,o),o.length>0){var i=o[0];t.push({distance:i.distance,object:this,point:i.point.clone()})}},this.update()},Potree.Volume.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.Volume.prototype,"clip",{get:function(){return this._clip},set:function(e){this._clip=e,this.update()}}),Object.defineProperty(Potree.Volume.prototype,"modifiable",{get:function(){return this._modifiable},set:function(e){this._modifiable=e,this.update()}}),Potree.VolumeTool=function(e,t,o){function i(e){var t=c.domElement.getBoundingClientRect();c.mouse.x=(e.clientX-t.left)/c.domElement.clientWidth*2-1,c.mouse.y=2*-((e.clientY-t.top)/c.domElement.clientHeight)+1}function n(){}function r(e){if(h!==d.DEFAULT&&e.stopImmediatePropagation(),h===d.INSERT_VOLUME)c.finishInsertion();else if(1===e.which){var t=a();t&&t.object.modifiable&&transformationTool.setTargets([t.object])}3===e.which}function s(e){return e.preventDefault(),!1}function a(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=new THREE.Raycaster;t.ray.set(c.camera.position,e.sub(c.camera.position).normalize());for(var o=[],i=0;i<c.volumes.length;i++){var n=c.volumes[i];o.push(n)}var r=t.intersectObjects(o,!1);return r.length>0?r[0]:!1}function l(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=e.sub(c.camera.position).normalize(),o=new THREE.Ray(c.camera.position,t),i=[];c.scene.traverse(function(e){e instanceof Potree.PointCloudOctree&&i.push(e)});for(var n=null,r=null,s=0;s<i.length;s++){var a=i[s],l=a.pick(c.renderer,c.camera,o);if(l){var d=c.camera.position.distanceTo(l.position);(!n||r>d)&&(n=l,r=d)}}return n?n.position:null}var c=this;this.enabled=!1,this.scene=e,this.sceneVolume=new THREE.Scene,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0},this.volumes=[];var d={DEFAULT:0,INSERT_VOLUME:1},h=d.DEFAULT;this.update=function(){if(h===d.INSERT_VOLUME){var e=l();if(e){this.activeVolume.position.copy(e);var t=this.activeVolume.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),i=(new THREE.Vector4(t.x,t.y,t.z).applyMatrix4(this.camera.projectionMatrix),Math.abs(t.z/10));this.activeVolume.scale.set(i,i,i)}}for(var n=[],r=0;r<this.volumes.length;r++)n.push(this.volumes[r]);this.activeVolume&&n.push(this.activeVolume);for(var r=0;r<n.length;r++){var s=n[r],a=(s.box,s.label),u=s.volume(),p=Potree.utils.addCommas(u.toFixed(1))+"³";a.setText(p);var m=c.camera.position.distanceTo(a.getWorldPosition()),v=projectedRadius(1,c.camera.fov*Math.PI/180,m,o.domElement.clientHeight),E=70/v;a.scale.set(E,E,E)}},this.startInsertion=function(e){h=d.INSERT_VOLUME;var e=e||{},t=e.clip||!1;this.activeVolume=new Potree.Volume,this.activeVolume.clip=t,this.sceneVolume.add(this.activeVolume),this.volumes.push(this.activeVolume)},this.finishInsertion=function(){transformationTool.setTargets([this.activeVolume]),this.activeVolume=null,h=d.DEFAULT},this.addVolume=function(e){this.sceneVolume.add(e),this.volumes.push(e)},this.removeVolume=function(e){this.sceneVolume.remove(e);var t=this.volumes.indexOf(e);t>=0&&this.volumes.splice(t,1)},this.render=function(){o.render(this.sceneVolume,this.camera)},this.domElement.addEventListener("click",n,!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousemove",i,!1),this.domElement.addEventListener("contextmenu",s,!1)};